<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema SALIDAS - Pro</title>
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3; --primary-light: #e0e7ff;
            --bg-app: #f3f4f6; --surface: #ffffff; 
            --text-main: #111827; --text-sec: #6b7280; --border: #e5e7eb;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --money: #059669; --pase-color: #8b5cf6; --ops-color: #0891b2;
            --pay-debt-bg: #fef2f2; --pay-part-bg: #fff7ed; --pay-ok-bg: #f0fdf4;
            --report-color: #be185d; --expense-color: #b91c1c;
        }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 25px; }
        
        /* HEADER & TABS */
        .header-container { background: var(--surface); padding: 10px 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); overflow-x: auto; }
        .tab-btn { padding: 10px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: var(--text-sec); cursor: pointer; transition: 0.2s; }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }

        /* VISTAS */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* TABLAS Y CARDS */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #f9fafb; color: #4b5563; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; }

        /* CALENDARIO ESTILOS ESPECIFICOS */
        .excel-wrapper { overflow-x: auto; background: var(--surface); border-radius: 12px; height: 70vh; border: 1px solid var(--border); }
        .col-sticky { position: sticky; left: 0; background: var(--surface); z-index: 20; border-right: 2px solid var(--border) !important; min-width: 280px; }
        .tour-item { background: white; border-left: 4px solid var(--primary); padding: 4px; font-size: 0.7rem; margin-bottom: 3px; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 4px; }
        .tour-item.locked { border-left-color: #f59e0b; background-color: #fffbeb; cursor: default; }
        .tour-obs-cal { font-size: 0.65rem; color: #2563eb; font-weight:bold; margin-top: 2px; }
        .drop-zone.drag-over { background: #dcfce7 !important; border: 2px dashed var(--success); }

        /* MODALES */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; }
        .pro-section { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .tour-row-input { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1fr 30px; gap: 8px; margin-bottom: 8px; padding: 10px; background: #f8fafc; border-radius: 8px; }

        /* UI UTILS */
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .badge-liq { background:#ecfdf5; color:#065f46; padding:2px 6px; border-radius:4px; font-size:0.75rem; border:1px solid #6ee7b7; }
        .tag-tour { display: inline-block; background: var(--primary-light); color: var(--primary-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; margin: 2px; }
    </style>
</head>
<body>

    <div class="header-container">
        <div class="title-section"><h1 style="color:var(--primary); margin:0;">üöÄ SISTEMA SALIDAS v2</h1></div>
        <div style="display:flex; gap:10px;">
            <input type="month" id="filtroMes" onchange="actualizarTodo()" style="padding:8px; border-radius:8px; border:1px solid var(--border);">
            <button class="btn-main" onclick="abrirModalRegistro()">+ Nuevo Registro</button>
        </div>
    </div>

    <div class="tabs">
        <button id="tabBtnLista" class="tab-btn active" onclick="cambiarVista('lista')">üìã Lista Pasajeros</button>
        <button id="tabBtnExcel" class="tab-btn" onclick="cambiarVista('excel')">üìÖ Calendario Grupal</button>
        <button id="tabBtnOps" class="tab-btn" onclick="cambiarVista('ops')" style="color:var(--ops-color);">üöç Despacho (Salidas)</button>
        <button id="tabBtnCatalogo" class="tab-btn" onclick="cambiarVista('catalogo')">‚öôÔ∏è Configuraci√≥n</button>
    </div>

    <div id="vistaLista" class="view-section active">
        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>Pasajero / Agencia</th>
                        <th>Hospedaje</th>
                        <th>Pagos</th>
                        <th>Itinerario (Tours y Notas)</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tbodyLista"></tbody>
            </table>
        </div>
    </div>

    <div id="vistaExcel" class="view-section">
        <div class="excel-wrapper">
            <table id="tablaExcel"></table>
        </div>
    </div>

    <div id="vistaOps" class="view-section">
        <div class="pro-section" style="border-top: 5px solid var(--ops-color);">
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                <div><label>Fecha</label><input type="date" id="ops_fecha" onchange="cargarPendientesOps()"></div>
                <div><label>Tour</label><select id="ops_tour" onchange="cargarPendientesOps()"></select></div>
                <div><label>Conductor</label><input type="text" id="ops_conductor"></div>
                <div><label>Capacidad</label><input type="number" id="ops_capacidad" value="15"></div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card" style="padding:10px;">
                    <h4 style="margin:0 0 10px 0;">üë• Disponibles para hoy</h4>
                    <div id="lista_ops_pendientes"></div>
                </div>
                <div class="card" style="padding:10px; background:#f0f9ff;">
                    <h4 style="margin:0 0 10px 0;">üöç Asignados al Veh√≠culo</h4>
                    <div id="lista_ops_asignados"></div>
                </div>
            </div>
            <div style="text-align:right; margin-top:15px;">
                <button class="btn-main" style="background:var(--ops-color);" onclick="guardarOperacion()">üíæ Guardar y Cerrar Salida</button>
            </div>
        </div>
        <div class="card">
            <table id="tablaResumenOps">
                <thead><tr><th>Fecha</th><th>Tour</th><th>Equipo</th><th>Pax</th><th>Acciones</th></tr></thead>
                <tbody id="tbodyOps"></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="modalRegistro">
        <div class="modal-content">
            <div style="padding:20px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee;">
                <h2 id="modalRegTitulo" style="margin:0;">üìù Registro de Paquete</h2>
                <button onclick="cerrarModal('modalRegistro')" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div style="padding:20px;">
                <form id="formTour">
                    <input type="hidden" id="reg_firestore_id">
                    <div class="pro-section">
                        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:10px;">
                            <input type="text" id="nombre" placeholder="Nombre completo" required>
                            <input type="tel" id="celular" placeholder="Celular">
                            <select id="selAgencia"></select>
                        </div>
                    </div>
                    <div class="pro-section">
                        <div style="display:grid; grid-template-columns: 1.5fr 1fr 1fr; gap:10px;">
                            <select id="selHotelName" onchange="cargarHabitacionesDeHotel(this.value)"></select>
                            <input type="date" id="llegada" onchange="actualizarSelectoresItinerario()">
                            <input type="date" id="retorno" onchange="actualizarSelectoresItinerario()">
                        </div>
                        <div id="listaCheckHabitaciones" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:5px;"></div>
                    </div>
                    <div class="pro-section" style="background:#fefce8;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h4 style="margin:0;">üó∫Ô∏è Itinerario Detallado</h4>
                            <button type="button" onclick="agregarLineaTour()" class="btn-main" style="padding:5px 10px;">+ Agregar D√≠a</button>
                        </div>
                        <div id="listaToursInputs"></div>
                        <p style="font-size:0.7rem; color:#666;">* <b>Obs Ops:</b> Sale en el manifiesto del chofer. | <b>Obs Cal:</b> Anotaci√≥n visual fija en calendario.</p>
                    </div>
                    <div class="pro-section">
                        <div style="display:grid; grid-template-columns: 1fr 1fr 2fr; gap:10px;">
                            <input type="number" id="precioPaquete" placeholder="Total S/">
                            <input type="number" id="adelanto" placeholder="Adelanto S/">
                            <input type="text" id="observaciones" placeholder="Notas internas generales">
                        </div>
                    </div>
                    <button type="submit" class="btn-main" style="width:100%; padding:15px;">üíæ GUARDAR REGISTRO COMPLETO</button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB7R-NO45QoBSdHWS4Q2BK7tqmjYCMyDEk",
            authDomain: "sistemasalidas-92d4b.firebaseapp.com",
            projectId: "sistemasalidas-92d4b",
            storageBucket: "sistemasalidas-92d4b.firebasestorage.app",
            messagingSenderId: "679142301697",
            appId: "1:679142301697:web:4357eca0d8915ebcd66000"
        };

        const app = initializeApp(firebaseConfig);
        const dbFirestore = getFirestore(app);

        // State Global
        window.db = []; 
        window.dbOps = [];
        window.catalogo = { hoteles: [], tours: [], agencias: [] };
        window.opsTempAsignados = [];

        // Realtime
        onSnapshot(collection(dbFirestore, "registros"), (snap) => {
            window.db = snap.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
            actualizarTodo();
        });
        onSnapshot(collection(dbFirestore, "operaciones"), (snap) => {
            window.dbOps = snap.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
            renderListaOps();
        });
        onSnapshot(doc(dbFirestore, "config", "catalogo"), (docSnap) => {
            if (docSnap.exists()) {
                window.catalogo = docSnap.data();
                actualizarCatalogosUI();
            }
        });

        // Funciones de Guardado
        window.guardarRegistroEnNube = async (data) => {
            const fid = document.getElementById('reg_firestore_id').value;
            try {
                if (fid) await updateDoc(doc(dbFirestore, "registros", fid), data);
                else await addDoc(collection(dbFirestore, "registros"), data);
                cerrarModal('modalRegistro');
            } catch (e) { alert("Error: " + e.message); }
        };

        window.guardarOperacionEnNube = async (data) => {
            try {
                await addDoc(collection(dbFirestore, "operaciones"), data);
                alert("Operaci√≥n guardada");
                window.opsTempAsignados = [];
                cargarPendientesOps();
            } catch (e) { alert(e); }
        };

        // UI Helpers
        window.cambiarVista = (vista) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('vista' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active');
            document.getElementById('tabBtn' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active');
            if(vista === 'ops') cargarSelectOps();
        };

        window.cerrarModal = (id) => document.getElementById(id).classList.remove('active');
    </script>

    <script>
        // L√ìGICA DE NEGOCIO
        const fmtMoneda = (v) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(v);

        function actualizarTodo() {
            const mes = document.getElementById('filtroMes').value;
            const dataMes = window.db.filter(r => r.llegada.startsWith(mes) || r.retorno.startsWith(mes));
            renderLista(dataMes);
            renderExcel(dataMes, mes);
        }

        function renderLista(data) {
            document.getElementById('tbodyLista').innerHTML = data.map(r => {
                const liq = r.liquidado ? '<span class="badge-liq">Pagado</span>' : '';
                return `<tr>
                    <td><b>${r.nombre}</b><br><small>üè¢ ${r.agencia}</small> ${liq}</td>
                    <td>üè® ${r.hotelName}<br><small>üõèÔ∏è ${r.habitaciones?.join(', ')}</small></td>
                    <td>Venta: ${fmtMoneda(r.precioPaquete)}<br><small>Deuda: ${fmtMoneda(r.precioPaquete - r.adelanto)}</small></td>
                    <td><div style="display:flex; flex-wrap:wrap; gap:4px;">
                        ${r.tours.map(t => `<span class="tag-tour" title="${t.obsTour || ''}">
                            ${t.nombre || 'üìå'} (${t.fecha.split('-')[2]}) ${t.obsDia ? 'üìù' : ''}
                        </span>`).join('')}
                    </div></td>
                    <td>
                        <button onclick="cargarEdicion(${r.id})" style="cursor:pointer; border:none; background:#f3f4f6; padding:5px; border-radius:4px;">‚úèÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderExcel(data, mes) {
            if(!mes) return;
            const [y, m] = mes.split('-');
            const days = new Date(y, m, 0).getDate();
            let h = '<thead><tr><th class="col-sticky">Pasajero</th>';
            for(let i=1; i<=days; i++) h += `<th style="text-align:center;">${i}</th>`;
            h += '</tr></thead><tbody>';

            data.forEach(r => {
                h += `<tr><td class="col-sticky"><b>${r.nombre}</b><br><small>${r.hotelName} (${r.cantidad} pax)</small></td>`;
                for(let d=1; d<=days; d++) {
                    const fStr = `${y}-${m}-${String(d).padStart(2,'0')}`;
                    const itemsDia = r.tours.filter(t => t.fecha === fStr);
                    const isStay = (fStr >= r.llegada && fStr <= r.retorno);
                    
                    h += `<td class="drop-zone ${isStay?'cell-stay':''}" data-dia="${d}" ondragover="allowDrop(event)" ondrop="dropTour(event, ${r.id})">`;
                    itemsDia.forEach((t, idx) => {
                        const isNote = !t.nombre;
                        const dragAttr = isNote ? 'draggable="false"' : `draggable="true" ondragstart="drag(event, ${r.id}, '${t.fecha}', ${idx})"`;
                        h += `<div class="tour-item ${isNote?'locked':''}" ${dragAttr}>
                            <div style="font-weight:bold;">${t.nombre || 'üìå Nota'}</div>
                            ${t.obsDia ? `<div class="tour-obs-cal">${t.obsDia}</div>` : ''}
                        </div>`;
                    });
                    h += `</td>`;
                }
                h += '</tr>';
            });
            document.getElementById('tablaExcel').innerHTML = h + '</tbody>';
        }

        // DRAG AND DROP
        window.drag = (ev, pid, fecha, tidx) => {
            ev.dataTransfer.setData("pid", pid);
            ev.dataTransfer.setData("tidx", tidx);
        };
        window.allowDrop = (ev) => { ev.preventDefault(); };
        window.dropTour = async (ev, targetPid) => {
            ev.preventDefault();
            const pid = parseInt(ev.dataTransfer.getData("pid"));
            const tidx = parseInt(ev.dataTransfer.getData("tidx"));
            const dia = ev.target.closest('td').dataset.dia;
            
            if (pid !== targetPid) { alert("Solo puedes mover tours del mismo pasajero"); return; }
            
            const [y, m] = document.getElementById('filtroMes').value.split('-');
            const nuevaFecha = `${y}-${m}-${String(dia).padStart(2, '0')}`;
            
            const registro = window.db.find(x => x.id === pid);
            if (registro) {
                registro.tours[tidx].fecha = nuevaFecha;
                document.getElementById('reg_firestore_id').value = registro.firestoreId;
                await window.guardarRegistroEnNube(registro);
            }
        };

        // OPERACIONES
        function cargarPendientesOps() {
            const f = document.getElementById('ops_fecha').value;
            const t = document.getElementById('ops_tour').value;
            const div = document.getElementById('lista_ops_pendientes');
            div.innerHTML = '';
            if(!f || !t) return;

            window.db.forEach(r => {
                const tourDia = r.tours.find(x => x.fecha === f && x.nombre === t);
                if (tourDia) {
                    const yaAsignado = window.opsTempAsignados.some(a => a.pid === r.id);
                    if(!yaAsignado) {
                        div.innerHTML += `<div style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                            <span><b>${r.nombre}</b> (${r.cantidad} pax)<br><small>${r.hotelName} | ${tourDia.obsTour || 'Sin obs'}</small></span>
                            <button onclick="asignarPax(${r.id}, ${r.cantidad}, '${r.nombre}', '${r.hotelName}')">Add</button>
                        </div>`;
                    }
                }
            });
            renderAsignados();
        }

        window.asignarPax = (pid, pax, nom, hot) => {
            window.opsTempAsignados.push({ pid, pax, nom, hot });
            cargarPendientesOps();
        };

        function renderAsignados() {
            const div = document.getElementById('lista_ops_asignados');
            let total = 0;
            div.innerHTML = window.opsTempAsignados.map((a, i) => {
                total += parseInt(a.pax);
                return `<div style="padding:5px; display:flex; justify-content:space-between;">
                    <span>${a.nom} (${a.pax})</span>
                    <button onclick="window.opsTempAsignados.splice(${i},1); renderAsignados();" style="color:red;">x</button>
                </div>`;
            }).join('');
            document.getElementById('lista_ops_asignados').innerHTML += `<div style="margin-top:10px; font-weight:bold; border-top:1px solid #000;">TOTAL: ${total}</div>`;
        }

        // FORMULARIO DINAMICO
        window.agregarLineaTour = (tourVal='', diaIdx=0, obsT='', obsD='') => {
            const container = document.getElementById('listaToursInputs');
            const row = document.createElement('div');
            row.className = 'tour-row-input';
            
            let tourOpts = '<option value="">-- Solo Nota --</option>';
            window.catalogo.tours.forEach(t => {
                tourOpts += `<option value="${t.nombre}" ${t.nombre===tourVal?'selected':''}>${t.nombre}</option>`;
            });

            row.innerHTML = `
                <select class="in-tour">${tourOpts}</select>
                <select class="in-dia">${obtenerOpcionesDias(diaIdx)}</select>
                <input type="text" class="in-obs-t" placeholder="Obs Operaci√≥n" value="${obsT}">
                <input type="text" class="in-obs-d" placeholder="Obs Calendario" value="${obsD}">
                <button type="button" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(row);
        };

        function obtenerOpcionesDias(selected = 0) {
            let h = '';
            for(let i=0; i<10; i++) h += `<option value="${i}" ${i==selected?'selected':''}>D√≠a ${i+1}</option>`;
            return h;
        }

        window.abrirModalRegistro = () => {
            document.getElementById('formTour').reset();
            document.getElementById('reg_firestore_id').value = '';
            document.getElementById('listaToursInputs').innerHTML = '';
            actualizarCatalogosUI();
            agregarLineaTour();
            document.getElementById('modalRegistro').classList.add('active');
        };

        window.cargarEdicion = (id) => {
            const r = window.db.find(x => x.id === id);
            if(!r) return;
            abrirModalRegistro();
            document.getElementById('reg_firestore_id').value = r.firestoreId;
            document.getElementById('nombre').value = r.nombre;
            document.getElementById('celular').value = r.celular;
            document.getElementById('selAgencia').value = r.agencia;
            document.getElementById('selHotelName').value = r.hotelName;
            document.getElementById('llegada').value = r.llegada;
            document.getElementById('retorno').value = r.retorno;
            document.getElementById('precioPaquete').value = r.precioPaquete;
            document.getElementById('adelanto').value = r.adelanto;
            document.getElementById('observaciones').value = r.observaciones;

            document.getElementById('listaToursInputs').innerHTML = '';
            r.tours.forEach(t => {
                const diff = Math.ceil((new Date(t.fecha) - new Date(r.llegada)) / 86400000);
                agregarLineaTour(t.nombre, diff, t.obsTour||'', t.obsDia||'');
            });
        };

        document.getElementById('formTour').addEventListener('submit', async (e) => {
            e.preventDefault();
            const llegada = document.getElementById('llegada').value;
            const tours = [];
            document.querySelectorAll('.tour-row-input').forEach(row => {
                const tName = row.querySelector('.in-tour').value;
                const diaIdx = parseInt(row.querySelector('.in-dia').value);
                const fecha = new Date(llegada);
                fecha.setDate(fecha.getDate() + diaIdx);
                
                tours.push({
                    nombre: tName,
                    fecha: fecha.toISOString().split('T')[0],
                    obsTour: row.querySelector('.in-obs-t').value,
                    obsDia: row.querySelector('.in-obs-d').value
                });
            });

            const data = {
                id: window.editId || Date.now(),
                nombre: document.getElementById('nombre').value,
                celular: document.getElementById('celular').value,
                agencia: document.getElementById('selAgencia').value,
                hotelName: document.getElementById('selHotelName').value,
                llegada: llegada,
                retorno: document.getElementById('retorno').value,
                precioPaquete: parseFloat(document.getElementById('precioPaquete').value) || 0,
                adelanto: parseFloat(document.getElementById('adelanto').value) || 0,
                observaciones: document.getElementById('observaciones').value,
                tours: tours
            };
            await window.guardarRegistroEnNube(data);
        });

        function actualizarCatalogosUI() {
            const h = document.getElementById('selHotelName');
            const a = document.getElementById('selAgencia');
            const t = document.getElementById('ops_tour');
            h.innerHTML = window.catalogo.hoteles.map(x => `<option value="${x.nombre}">${x.nombre}</option>`).join('');
            a.innerHTML = window.catalogo.agencias.map(x => `<option value="${x.nombre}">${x.nombre}</option>`).join('');
            t.innerHTML = '<option value="">-- Seleccionar --</option>' + window.catalogo.tours.map(x => `<option value="${x.nombre}">${x.nombre}</option>`).join('');
        }

        window.onload = () => {
            document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
        };
    </script>
</body>
</html>
