<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema SALIDAS - V44 (Nube Firebase)</title>
    <style>
        /* (MISMOS ESTILOS V43 - MANTENIENDO DISE√ëO PRO) */
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3; --primary-light: #e0e7ff;
            --bg-app: #f3f4f6; --surface: #ffffff; 
            --text-main: #111827; --text-sec: #6b7280; --border: #e5e7eb;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --money: #059669; --pase-color: #8b5cf6; --ops-color: #0891b2;
            --pay-debt-bg: #fef2f2; --pay-part-bg: #fff7ed; --pay-ok-bg: #f0fdf4;
            --report-color: #be185d; --expense-color: #b91c1c;
        }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 25px; }
        .header-container { background: var(--surface); padding: 15px 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .title-section h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 800; letter-spacing: -0.025em; }
        .main-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
        .btn-main:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-sec { background: var(--surface); border: 1px solid var(--border); color: var(--text-sec); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .btn-sec:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); overflow-x: auto; scrollbar-width: none; }
        .tab-btn { padding: 10px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: var(--text-sec); cursor: pointer; margin-bottom: -2px; font-size: 0.95rem; white-space: nowrap; transition: 0.2s; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 14px 15px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { background: #f9fafb; color: #4b5563; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; }
        .row-debt { background-color: var(--pay-debt-bg) !important; border-left: 4px solid var(--danger); }
        .row-partial { background-color: var(--pay-part-bg) !important; border-left: 4px solid var(--warning); }
        .row-ok { background-color: var(--pay-ok-bg); border-left: 4px solid var(--success); }
        .obs-box { display: block; margin-top: 5px; font-size: 0.75rem; background: #fffbeb; color: #92400e; padding: 4px 8px; border-radius: 6px; border: 1px solid #fcd34d; width: fit-content; }
        .tag-tour { display: inline-block; background: var(--primary-light); color: var(--primary-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin: 2px; border: 1px solid #c7d2fe; }
        .excel-wrapper { overflow-x: auto; background: var(--surface); border-radius: 12px; height: 75vh; border: 1px solid var(--border); }
        .excel-table th, .excel-table td { border-right: 1px solid var(--border); }
        .excel-table thead { position: sticky; top: 0; z-index: 50; background: #f9fafb; }
        .col-sticky { position: sticky; left: 0; background: var(--surface); z-index: 20; border-right: 2px solid var(--border) !important; width: 300px; min-width: 300px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .pax-card { font-size: 0.85rem; display: flex; flex-direction: column; gap: 3px; }
        .day-header { text-align: center; cursor: pointer; transition: background 0.2s; position: relative; color: var(--primary); }
        .day-header:hover { background-color: var(--primary-light); }
        .drop-zone.drag-over { background: #dcfce7 !important; } .cell-stay { background: #f0fdf4; }
        .tour-item { background: white; border-left: 4px solid var(--primary); padding: 4px; font-size: 0.7rem; margin-bottom: 3px; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .pase-item { background: white; border-left: 4px solid var(--pase-color); padding: 4px; font-size: 0.75rem; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; font-weight: 600; color: var(--text-main); }
        .ops-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .ops-box { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 15px; height: 60vh; overflow-y: auto; display: flex; flex-direction: column; }
        .ops-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .ops-item:hover { background: #f9fafb; }
        .ops-header { font-weight: 800; color: var(--ops-color); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-add-ops { background: var(--success); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .btn-remove-ops { background: var(--danger); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .capacidad-indicator { font-size: 1.2rem; font-weight: bold; text-align: center; margin: 10px 0; padding: 10px; background: #e0f2fe; border-radius: 8px; color: #0369a1; }
        .capacidad-error { background: #fee2e2; color: #991b1b; }
        .money-cell { font-family: 'Courier New', monospace; font-weight: 700; color: var(--text-main); }
        .badge-debt { color: var(--danger); font-weight: 800; font-size: 0.8rem; background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--danger); }
        .badge-paid { color: var(--success); font-weight: 800; font-size: 0.8rem; background: #dcfce7; padding: 2px 6px; border-radius: 4px; border: 1px solid #86efac; }
        .badge-liq { background:#ecfdf5; color:#065f46; padding:2px 6px; border-radius:4px; font-size:0.75rem; border:1px solid #6ee7b7; display: inline-block; margin-top:2px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 0; border-radius: 16px; width: 95%; max-width: 850px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); display: flex; flex-direction: column;}
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: white; position: sticky; top: 0; z-index: 10; }
        .modal-body { padding: 25px; background: #f8fafc; flex: 1; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 0; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 0.9rem; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn-icon { width: 28px; height: 28px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; margin-left: 5px; }
        .btn-edit { background: #fff7ed; color: #d97706; } .btn-del { background: #fef2f2; color: #dc2626; }
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .catalog-col { background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid var(--border); max-height: 70vh; display: flex; flex-direction: column; }
        .item-list { overflow-y: auto; flex: 1; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .room-row { display: grid; grid-template-columns: 2fr 1fr 1fr 30px; gap: 8px; margin-bottom: 8px; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .type-btn { padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 20px; cursor: pointer; }
        .type-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .room-checkbox-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px; max-height: 200px; overflow-y: auto;}
        .room-option { cursor: pointer; position: relative; }
        .room-option input[type="checkbox"] { display: none; }
        .room-card { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 6px; transition: all 0.2s; height: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .room-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .room-card .r-num { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .room-card .r-cap { font-size: 0.7rem; color: var(--text-sec); }
        .room-option input:checked + .room-card { background: var(--primary); border-color: var(--primary); color: white; }
        .room-option input:checked + .room-card .r-num { color: white; }
        .room-option input:checked + .room-card .r-cap { color: rgba(255,255,255,0.8); }
        .tour-row-input { display: grid; grid-template-columns: 1.5fr 1fr 1.5fr 30px; gap: 5px; margin-bottom: 5px; background: white; padding: 5px; border-radius: 6px; border: 1px solid #eee; }
        .sel-obs { font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px; padding: 8px; }
        .pro-section { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .pro-section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .input-group { margin-bottom: 0; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .input-wrapper { position: relative; }
        .input-icon-left { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        .with-icon { padding-left: 35px; }
        .date-range-container { display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .date-separator { color: #9ca3af; font-size: 1.2rem; }
        .pay-toggle-container { display: flex; background: #e5e7eb; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
        .pay-toggle-opt { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; font-weight: 600; color: #6b7280; transition: 0.2s; }
        .pay-toggle-opt.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .pay-toggle-opt.active-green { background: var(--money); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center; color: var(--primary); font-weight:bold; font-size:1.2rem; }
        
        @media print {
            @page { size: A4 landscape; margin: 1cm; }
            body * { visibility: hidden; } #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; padding: 0; background: white; color: black; font-family: 'Arial', sans-serif; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11pt; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
            .print-table th { background-color: #f0f0f0 !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            button, .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">‚òÅÔ∏è Conectando con Firebase...</div>
    <div id="printableArea"></div>

    <div class="header-container">
        <div class="title-section"><h1>üöÄ SALIDAS <small style="font-size:0.8rem;color:gray;">V44 (CLOUD)</small></h1></div>
        <div class="main-controls">
            <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
            <label style="font-weight:600; color:var(--text-sec);">Mes:</label>
            <input type="month" id="filtroMes" style="padding:8px; border-radius:8px; border:1px solid var(--border);" onchange="actualizarTodo()">
            <button class="btn-main" onclick="abrirModalRegistro()"><span>+</span> Registro</button>
        </div>
    </div>

    <div class="tabs">
        <button id="tabBtnLista" class="tab-btn active" onclick="cambiarVista('lista')">üìã Lista</button>
        <button id="tabBtnExcel" class="tab-btn" onclick="cambiarVista('excel')">üìÖ Calendario</button>
        <button id="tabBtnPases" class="tab-btn" onclick="cambiarVista('pases')" style="color:var(--pase-color);">üé´ Pases</button>
        <button id="tabBtnOps" class="tab-btn" onclick="cambiarVista('ops')" style="color:var(--ops-color);">üöç Operaciones</button>
        <button id="tabBtnLiquidacion" class="tab-btn" onclick="cambiarVista('liquidacion')" style="color:var(--report-color);">üìâ Liquidaci√≥n</button>
        <button id="tabBtnGastos" class="tab-btn" onclick="cambiarVista('gastos')" style="color:var(--expense-color);">üí∏ Gastos</button>
        <button id="tabBtnCatalogo" class="tab-btn" onclick="cambiarVista('catalogo')">üìö Cat√°logo</button>
        <button id="tabBtnControl" class="tab-btn" onclick="cambiarVista('control')">üí∞ Control</button>
    </div>

    <div id="vistaLista" class="view-section active">
        <div style="margin-bottom:20px;"><input type="text" id="buscadorLista" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:300px;" placeholder="üîç Buscar por nombre..." onkeyup="actualizarTodo()"></div>
        <div class="card"><table style="width:100%"><thead><tr><th>Pasajero</th><th>Hotel / Agencia</th><th>Pagos</th><th>Itinerario</th><th style="text-align:right">Acciones</th></tr></thead><tbody id="tbodyLista"></tbody></table></div>
    </div>

    <div id="vistaExcel" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <select id="filtroTourCalendario" style="padding:8px;border-radius:6px;border:1px solid #ccc;" onchange="actualizarTodo()"><option value="">-- Todos los Tours --</option></select>
            <div style="font-size:0.8rem; color:var(--text-sec);">Clic en d√≠a para ruta.</div>
        </div>
        <div class="excel-wrapper"><table class="excel-table" id="tablaExcel"></table></div>
    </div>

    <div id="vistaPases" class="view-section">
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" id="buscadorPases" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:250px;" placeholder="üîç Buscar pase..." onkeyup="actualizarTodo()">
            <select id="filtroAgenciaPases" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:200px;" onchange="actualizarTodo()"><option value="">-- Todas las Agencias --</option></select>
            <div style="flex:1;"></div>
            <button class="btn-main" onclick="abrirModalPases()" style="background:var(--pase-color);">+ Nuevo Pase</button>
        </div>
        <div class="excel-wrapper"><table class="excel-table" id="tablaPases"></table></div>
    </div>

    <div id="vistaOps" class="view-section">
        <div class="card" style="padding:20px; margin-bottom:20px; border-top: 4px solid var(--ops-color);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0; color:var(--ops-color);">Gesti√≥n de Salidas (Despacho)</h3><button class="btn-sec" onclick="nuevaOperacion()">üîÑ Limpiar Formulario</button></div>
            <div class="form-grid" style="grid-template-columns:repeat(5, 1fr);">
                <div><label class="input-label">Fecha Salida</label><input type="date" id="ops_fecha" onchange="cargarPendientesOps()"></div>
                <div><label class="input-label">Tour</label><select id="ops_tour" onchange="cargarPendientesOps()"></select></div>
                <div><label class="input-label">Conductor</label><input type="text" id="ops_conductor" placeholder="Nombre Cond."></div>
                <div><label class="input-label">Gu√≠a</label><input type="text" id="ops_guia" placeholder="Nombre Gu√≠a"></div>
                <div><label class="input-label">Capacidad Veh√≠culo</label><input type="number" id="ops_capacidad" value="15" min="1" onchange="actualizarIndicadorCapacidad()"></div>
            </div>
            <input type="hidden" id="ops_id_actual"> <input type="hidden" id="ops_firestore_id">
            <div id="indicadorCapacidad" class="capacidad-indicator">0 / 15 Pasajeros</div>
            <div class="ops-container">
                <div class="ops-box"><div class="ops-header"><span>üë• Pendientes (Sin Asignar)</span><small id="count_pendientes">0</small></div><div id="lista_ops_pendientes" style="flex:1;"></div></div>
                <div class="ops-box" style="border-color:var(--ops-color); background:#f0f9ff;"><div class="ops-header"><span>üöç En el Veh√≠culo</span><small id="count_asignados">0</small></div><div id="lista_ops_asignados" style="flex:1;"></div></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;"><button class="btn-main" onclick="guardarOperacion()" style="background:var(--ops-color);">üíæ Guardar Operaci√≥n</button><button class="btn-main" onclick="imprimirManifiesto()" style="background:#333;">üñ®Ô∏è Imprimir Manifiesto</button></div>
        </div>
        <h3 style="margin-top:30px;">Salidas Programadas</h3>
        <div class="card"><table style="width:100%"><thead><tr><th>Fecha</th><th>Tour</th><th>Conductor / Gu√≠a</th><th>Capacidad</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tbodyOps"></tbody></table></div>
    </div>

    <div id="vistaLiquidacion" class="view-section">
        <div class="card" style="padding:20px; border-top: 4px solid var(--report-color);">
            <h3 style="margin:0; margin-bottom:15px; color:var(--report-color);">Liquidaci√≥n de Agencias</h3>
            <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap; background:#fdf2f8; padding:15px; border-radius:10px; border:1px solid #fbcfe8;">
                <div style="flex:1; min-width:200px;"><label class="input-label">Agencia</label><select id="liq_agencia" style="width:100%;"><option value="">Seleccione Agencia...</option></select></div>
                <div><label class="input-label">Desde</label><input type="date" id="liq_desde"></div>
                <div><label class="input-label">Hasta</label><input type="date" id="liq_hasta"></div>
                <div><label class="input-label">Ver</label><select id="liq_filtro_estado"><option value="pendientes">Pendientes (Por Cobrar)</option><option value="todos">Todo el Historial</option><option value="liquidados">Solo Pagados</option></select></div>
                <button class="btn-main" style="background:var(--report-color);" onclick="generarLiquidacion()">üìä Generar</button>
            </div>
            <div id="resultadosLiquidacion" style="margin-top:20px; display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><button class="btn-main" style="background:#059669;" onclick="liquidarRegistros()">‚úÖ Marcar como Pagado</button><button class="btn-sec" onclick="imprimirLiquidacion()">üñ®Ô∏è Imprimir Liquidaci√≥n</button></div>
                <div id="tablaLiqContainer"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:20px;">
                    <div style="padding:15px; background:#f3f4f6; border-radius:8px; text-align:center;"><small>Total Ventas</small><div id="liq_total_venta" style="font-weight:bold; font-size:1.2rem;">S/ 0.00</div></div>
                    <div style="padding:15px; background:#ecfdf5; border-radius:8px; text-align:center; color:#047857;"><small>Total Adelantos</small><div id="liq_total_adelanto" style="font-weight:bold; font-size:1.2rem;">S/ 0.00</div></div>
                    <div style="padding:15px; background:#fef2f2; border-radius:8px; text-align:center; color:#dc2626; border:2px solid #dc2626;"><small>Saldo a Pagar (Deuda)</small><div id="liq_total_deuda" style="font-weight:bold; font-size:1.5rem;">S/ 0.00</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="vistaGastos" class="view-section">
        <div class="card" style="padding:20px; border-top: 4px solid var(--expense-color);">
            <h3 style="margin:0; margin-bottom:15px; color:var(--expense-color);">Registro de Gastos Operativos</h3>
            <form id="formGasto" style="display:flex; gap:10px; align-items:flex-end; background:#fff1f2; padding:15px; border-radius:10px; margin-bottom:20px; flex-wrap:wrap;">
                <div><label class="input-label">Fecha</label><input type="date" id="g_fecha" required></div>
                <div style="flex:2;"><label class="input-label">Descripci√≥n</label><input type="text" id="g_desc" placeholder="Ej. Gasolina..." required></div>
                <div><label class="input-label">Monto (S/)</label><input type="number" id="g_monto" placeholder="0.00" step="0.01" required></div>
                <div style="flex:1;"><label class="input-label">Responsable</label><input type="text" id="g_resp" placeholder="Qui√©n gast√≥"></div>
                <button type="submit" class="btn-main" style="background:var(--expense-color);">+ Agregar</button>
            </form>
            <h4 style="margin-bottom:10px;">Gastos del Mes</h4>
            <table style="width:100%"><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Responsable</th><th>Monto</th><th>Acci√≥n</th></tr></thead><tbody id="tbodyGastos"></tbody><tfoot><tr style="background:#f9fafb; font-weight:bold;"><td colspan="3" style="text-align:right;">TOTAL GASTOS:</td><td id="totalGastosDisplay" style="color:var(--expense-color);">S/ 0.00</td><td></td></tr></tfoot></table>
        </div>
    </div>

    <div id="vistaCatalogo" class="view-section">
        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="buscadorCatalogo" style="padding:10px; border:1px solid var(--border); border-radius:8px; flex:1;" placeholder="üîç Buscar..." onkeyup="renderizarCatalogos()">
            <button class="btn-main" onclick="abrirModalCatalogo()">+ Nuevo Item</button>
        </div>
        <div class="catalog-grid">
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üè® HOTELES</div><div id="cat_hoteles" class="item-list"></div></div>
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üó∫Ô∏è TOURS</div><div id="cat_tours" class="item-list"></div></div>
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üè¢ AGENCIAS</div><div id="cat_agencias" class="item-list"></div></div>
        </div>
    </div>

    <div id="vistaControl" class="view-section"><div class="card"><table style="width:100%"><thead><tr><th>Pasajero</th><th>Detalle</th><th>Venta</th><th>Adelanto</th><th>Saldo</th><th>Costo Op.</th><th>Ganancia</th></tr></thead><tbody id="tbodyControl"></tbody></table></div></div>

    <div class="modal" id="modalRegistro">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalRegTitulo" style="margin:0;color:var(--primary);">üìù Registro</h2><button onclick="cerrarModal('modalRegistro')" style="border:none;background:none;font-size:1.8rem;cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                <form id="formTour">
                    <input type="hidden" id="reg_firestore_id">
                    <div class="pro-section"><div class="pro-section-title">üë§ Datos del Cliente</div><div class="form-grid" style="grid-template-columns: 2fr 1fr 1.5fr 0.5fr;"><div class="input-group"><label class="input-label">Nombres</label><div class="input-wrapper"><span class="input-icon-left">üë§</span><input type="text" id="nombre" required class="with-icon"></div></div><div class="input-group"><label class="input-label">Celular</label><div class="input-wrapper"><span class="input-icon-left">üì±</span><input type="tel" id="celular" required class="with-icon"></div></div><div class="input-group"><label class="input-label">Agencia</label><select id="selAgencia" required></select></div><div class="input-group"><label class="input-label">Pax</label><input type="number" id="cantidad" min="1" required style="text-align:center;"></div></div></div>
                    <div class="pro-section"><div class="pro-section-title">üè® Alojamiento</div><div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px;"><div><div class="input-group" style="margin-bottom:15px;"><label class="input-label">Hotel</label><select id="selHotelName" required onchange="cargarHabitacionesDeHotel(this.value)"></select></div><label class="input-label">Fechas</label><div class="date-range-container"><div style="flex:1;"><label style="font-size:0.7rem;">LLEGADA</label><input type="date" id="llegada" required onchange="validarFechas()" style="border:none;"></div><div class="date-separator">‚ûù</div><div style="flex:1; text-align:right;"><label style="font-size:0.7rem;">SALIDA</label><input type="date" id="retorno" required onchange="validarFechas()" style="border:none; text-align:right;"></div></div></div><div id="containerHabitaciones" style="display:none; border-left: 1px solid #eee; padding-left: 20px;"><label class="input-label">Habitaciones</label><div id="listaCheckHabitaciones" class="room-checkbox-container"></div></div></div></div>
                    <div class="pro-section"><div class="pro-section-title">üí∞ Detalles</div><div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr;"><div class="input-group"><label class="input-label">Precio Total</label><div class="input-wrapper"><span class="input-icon-left">S/</span><input type="number" id="precioPaquete" required class="with-icon" style="font-weight:bold;"></div></div><div class="input-group"><label class="input-label">Adelanto</label><div class="input-wrapper"><span class="input-icon-left">S/</span><input type="number" id="adelanto" required class="with-icon"></div></div><div class="input-group"><label class="input-label">Observaciones</label><input type="text" id="observaciones" style="width:100%;"></div></div></div>
                    <div class="pro-section" style="background:#f8fafc;"><div class="pro-section-title" style="justify-content:space-between;"><span>üó∫Ô∏è Itinerario</span><button type="button" onclick="agregarLineaTour()" class="btn-main" style="padding:4px 10px; height:auto;">+ Tour</button></div><div id="listaToursInputs"></div></div>
                    <button type="submit" class="btn-main" style="width:100%; justify-content:center; padding:15px; margin-top:10px;">üíæ Guardar Registro</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="modalPases">
        <div class="modal-content" style="max-width:650px;">
            <div class="modal-header"><h2 id="modalPasesTitulo" style="margin:0;color:var(--pase-color);">üé´ Nuevo Pase</h2><button onclick="cerrarModal('modalPases')" style="border:none;background:none;font-size:1.8rem;cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                <form id="formPase">
                    <input type="hidden" id="pase_firestore_id">
                    <div class="pro-section"><div class="pro-section-title">Datos del Pasajero</div><div class="form-grid" style="grid-template-columns: 2fr 1fr 1.5fr;"><div class="input-group"><label class="input-label">Nombres</label><input type="text" id="p_nombre" required></div><div class="input-group"><label class="input-label">Celular</label><input type="tel" id="p_celular" required></div><div class="input-group"><label class="input-label">Agencia</label><select id="p_agencia" required></select></div></div></div>
                    <div class="pro-section"><div class="pro-section-title">Servicio</div><div class="form-grid" style="grid-template-columns:1fr 1.5fr 0.5fr;"><div class="input-group"><label class="input-label">Fecha</label><input type="date" id="p_fecha" required></div><div class="input-group"><label class="input-label">Tour</label><select id="p_tour" required onchange="calcPaseAuto()"></select></div><div class="input-group"><label class="input-label">Pax</label><input type="number" id="p_cantidad" min="1" required onchange="calcPaseAuto()"></div></div><div class="input-group" style="margin-top:10px;"><label class="input-label">Recojo</label><select id="p_hotel" required></select></div><div class="input-group" style="margin-top:10px;"><label class="input-label">Observaciones</label><input type="text" id="p_obs"></div></div>
                    <div class="pro-section"><div class="pro-section-title">Pago</div><div class="pay-toggle-container"><div class="pay-toggle-opt active" id="opt_adelanto" onclick="setPasePagoMode('adelanto')">A Cuenta</div><div class="pay-toggle-opt" id="opt_pagado" onclick="setPasePagoMode('pagado')">Pagado</div></div><input type="hidden" id="p_modo_pago" value="adelanto"><div class="form-grid" style="grid-template-columns: 1fr 1fr;"><div class="input-group"><label class="input-label">Total</label><input type="number" id="p_precio" required step="0.01" onchange="syncPasePago()"></div><div class="input-group"><label class="input-label">Abonado</label><input type="number" id="p_adelanto" required step="0.01"></div></div></div>
                    <button type="submit" class="btn-main" style="width:100%; justify-content:center; padding:12px;">Guardar Pase</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="modalResumenDia"><div class="modal-content" style="max-width:550px;"><div style="padding:20px;"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h2>üìÖ Operaciones</h2><button onclick="cerrarModal('modalResumenDia')" style="border:none;background:none;font-size:1.5rem;">&times;</button></div><h3 id="resumenFechaTitulo"></h3><div style="margin-bottom:15px;"><label>Filtrar:</label><select id="selTourPrint" style="width:100%;"></select></div><div id="listaResumenDia" style="border-top:1px solid #eee;"></div><div style="margin-top:20px;text-align:right;"><button class="btn-main" id="btnImprimirRuta">üñ®Ô∏è Imprimir</button></div></div></div></div>
    <div class="modal" id="modalCatalogo"><div class="modal-content" style="max-width:600px;"><div style="padding:20px;"><div style="text-align:center;margin-bottom:20px;"><h2>Cat√°logo</h2></div><div class="type-selector"><button id="typeBtnHotel" class="type-btn active" onclick="cambiarTipoCat('hotel')">üè® Hotel</button><button id="typeBtnTour" class="type-btn" onclick="cambiarTipoCat('tour')">üó∫Ô∏è Tour</button><button id="typeBtnAgencia" class="type-btn" onclick="cambiarTipoCat('agencia')">üè¢ Agencia</button></div><form id="formCatalogo"><input type="hidden" id="cat_edit_id"><input type="hidden" id="cat_edit_old_name"><input type="hidden" id="cat_tipo_actual" value="hotel"><div style="margin-bottom:20px;"><label>Nombre</label><input type="text" id="cat_nombre" required style="font-weight:bold;"></div><div id="fields_tour" style="display:none;margin-bottom:20px;"><label>Precio</label><input type="number" id="cat_precio_tour"></div><div id="fields_hotel"><label>Habitaciones</label><div style="background:#f3f4f6;padding:10px;"><div id="room_list"></div><button type="button" onclick="agregarFilaHabitacion()" style="color:var(--primary);border:none;background:none;margin-top:10px;">+ Agregar</button></div></div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;"><button type="button" onclick="cerrarModal('modalCatalogo')">Cancelar</button><button type="submit" class="btn-main">Guardar</button></div></form></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // üî•üî•üî• CONFIGURACI√ìN DE FIREBASE (¬°PON TUS CLAVES AQU√ç!) üî•üî•üî•
        const firebaseConfig = {
  apiKey: "AIzaSyB7R-NO45QoBSdHWS4Q2BK7tqmjYCMyDEk",
  authDomain: "sistemasalidas-92d4b.firebaseapp.com",
  projectId: "sistemasalidas-92d4b",
  storageBucket: "sistemasalidas-92d4b.firebasestorage.app",
  messagingSenderId: "679142301697",
  appId: "1:679142301697:web:4357eca0d8915ebcd66000"
};

        const app = initializeApp(firebaseConfig);
        const dbFirestore = getFirestore(app);

        // Variables Globales
        window.db = []; window.dbPases = []; window.dbOps = []; window.dbGastos = []; 
        window.catalogo = { hoteles: [], tours: [], agencias: [] };
        window.editId = null; window.dragData = null; window.opsTempAsignados = []; window.liquidacionData = [];

        // --- SINCRONIZACI√ìN REAL-TIME ---
        function initRealTime() {
            const overlay = document.getElementById('loadingOverlay');
            
            // 1. REGISTROS
            onSnapshot(collection(dbFirestore, "registros"), (snapshot) => {
                window.db = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                window.actualizarTodo();
            });

            // 2. PASES
            onSnapshot(collection(dbFirestore, "pases"), (snapshot) => {
                window.dbPases = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                window.actualizarTodo();
            });

            // 3. OPERACIONES
            onSnapshot(collection(dbFirestore, "operaciones"), (snapshot) => {
                window.dbOps = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                window.actualizarTodo();
            });

            // 4. GASTOS
            onSnapshot(collection(dbFirestore, "gastos"), (snapshot) => {
                window.dbGastos = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                window.actualizarTodo();
            });

            // 5. CAT√ÅLOGO (Usamos un documento √∫nico 'main_data' dentro de colecci√≥n 'config' para simplificar la migraci√≥n)
            onSnapshot(doc(dbFirestore, "config", "catalogo"), (docSnap) => {
                if (docSnap.exists()) {
                    window.catalogo = docSnap.data();
                } else {
                    // Si no existe, creamos uno vac√≠o
                    setDoc(doc(dbFirestore, "config", "catalogo"), { hoteles: [], tours: [], agencias: [] });
                }
                window.actualizarTodo();
                window.renderizarCatalogos();
                if(overlay) overlay.style.display = 'none';
            });
        }

        initRealTime();

        // --- FUNCIONES DE GUARDADO EN NUBE ---
        
        // GUARDAR REGISTRO
        window.guardarRegistroEnNube = async (data) => {
            const fid = document.getElementById('reg_firestore_id').value;
            try {
                if (fid) {
                    await updateDoc(doc(dbFirestore, "registros", fid), data);
                } else {
                    await addDoc(collection(dbFirestore, "registros"), data);
                }
                window.cerrarModal('modalRegistro');
            } catch (e) { alert("Error al guardar: " + e.message); }
        };

        // GUARDAR PASE (L√≥gica V43)
        window.guardarPaseEnNube = async (data) => {
            const fid = document.getElementById('pase_firestore_id').value;
            try {
                if (fid) {
                    await updateDoc(doc(dbFirestore, "pases", fid), data);
                } else {
                    await addDoc(collection(dbFirestore, "pases"), data);
                }
                window.cerrarModal('modalPases');
            } catch (e) { alert("Error al guardar pase: " + e.message); }
        };

        // GUARDAR OPERACION
        window.guardarOperacionEnNube = async (data) => {
            const fid = document.getElementById('ops_firestore_id').value;
            try {
                if (fid) {
                    await updateDoc(doc(dbFirestore, "operaciones", fid), data);
                } else {
                    await addDoc(collection(dbFirestore, "operaciones"), data);
                }
                window.nuevaOperacion();
                window.cambiarVista('ops');
            } catch (e) { alert("Error operaci√≥n: " + e.message); }
        };

        // GUARDAR GASTO
        window.guardarGastoEnNube = async (data) => {
            try { await addDoc(collection(dbFirestore, "gastos"), data); } catch(e){ alert(e); }
        };

        // ELIMINAR DOC
        window.eliminarDocEnNube = async (coll, fid) => {
            if(confirm("¬øEst√°s seguro de eliminar este registro?")) {
                try { await deleteDoc(doc(dbFirestore, coll, fid)); } catch(e){ alert(e); }
            }
        };

        // GUARDAR CATALOGO (Actualiza todo el objeto)
        window.guardarCatalogoEnNube = async () => {
            try { await setDoc(doc(dbFirestore, "config", "catalogo"), window.catalogo); } catch(e){ alert(e); }
        };

        // LIQUIDACI√ìN MASIVA
        window.liquidarEnNube = async (listaData) => {
            if(!confirm("¬øMarcar registros como PAGADOS?")) return;
            const batch = []; // Firestore batch no est√° importado, usaremos promesas paralelas
            const promesas = [];
            
            listaData.forEach(row => {
                if(!row.liq) {
                    if(row.tipo === 'db') {
                        // Encontrar firestoreId en window.db
                        const item = window.db.find(x => x.id === row.id);
                        if(item && item.firestoreId) promesas.push(updateDoc(doc(dbFirestore, "registros", item.firestoreId), { liquidado: true }));
                    } else {
                        const item = window.dbPases.find(x => x.id === row.id);
                        if(item && item.firestoreId) promesas.push(updateDoc(doc(dbFirestore, "pases", item.firestoreId), { liquidado: true }));
                    }
                }
            });
            
            if(promesas.length > 0) {
                await Promise.all(promesas);
                alert("Registros actualizados.");
                window.generarLiquidacion(); // Refrescar vista
            } else {
                alert("Nada pendiente.");
            }
        };

    </script>

    <script>
        window.onload = () => {
            document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
            cambiarVista('lista');
        };

        // UTILS
        const fmtMoneda = (v) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(v);
        function calcularFechaTour(fechaBase, diasSumar) {
            const parts = fechaBase.split('-'); const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
            date.setDate(date.getDate() + parseInt(diasSumar));
            const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // VISTAS
        function cambiarVista(vista) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('vista' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active');
            document.getElementById('tabBtn' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active');
            if(vista === 'ops') { cargarSelectOps(); nuevaOperacion(); renderListaOps(); }
            if(vista === 'liquidacion') { cargarSelectLiquidacion(); }
            if(vista === 'gastos') { document.getElementById('g_fecha').value = new Date().toISOString().split('T')[0]; renderGastos(); }
        }

        function actualizarTodo() {
            const txt = document.getElementById('buscadorLista').value.toLowerCase();
            const mes = document.getElementById('filtroMes').value;
            // Filtros de UI
            renderLista(window.db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes)) && (r.nombre.toLowerCase().includes(txt))));
            renderPases(mes);
            renderGastos();
            renderListaOps();
            
            // Llenar selects din√°micos si est√°n vac√≠os
            const ft = document.getElementById('filtroTourCalendario');
            if(ft.options.length<=1 && window.catalogo.tours){
                ft.innerHTML='<option value="">-- Todos --</option>'+[...new Set(window.catalogo.tours.map(t=>t.nombre))].map(t=>`<option value="${t}">${t}</option>`).join('');
            }
            const fa = document.getElementById('filtroAgenciaPases');
            if(fa.options.length<=1 && window.catalogo.agencias) {
                fa.innerHTML = '<option value="">-- Todas --</option>' + window.catalogo.agencias.map(a => `<option value="${a.nombre}">${a.nombre}</option>`).join('');
            }
            
            renderExcel(window.db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes))), mes, ft.value);
            renderControl(window.db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes))));
        }

        // RENDER LISTA
        function renderLista(data) {
            document.getElementById('tbodyLista').innerHTML = data.map(r => {
                const v = parseFloat(r.precioPaquete)||0; const a = parseFloat(r.adelanto)||0; const s = v-a;
                let statusBadge = (s<=0 && v>0) ? `<span class="badge-paid">¬°PAGADO!</span>` : (s>0 && a>0) ? `<span class="badge-debt" style="color:#b45309; border-color:#b45309;">Falta ${fmtMoneda(s)}</span>` : `<span class="badge-debt">Falta ${fmtMoneda(s)}</span>`;
                const rowClass = (s<=0 && v>0) ? 'row-ok' : (s>0 && a>0) ? 'row-partial' : 'row-debt';
                const obs = r.observaciones ? `<div class="obs-box">‚ö†Ô∏è ${r.observaciones}</div>` : '';
                const habs = Array.isArray(r.habitaciones) ? r.habitaciones.join(', ') : r.habitaciones;
                const liq = r.liquidado ? `<span class="badge-liq">Liq.</span>` : '';
                return `<tr class="${rowClass}"><td style="border-left-width: 4px;"><div style="font-weight:bold; font-size:1rem;">${r.nombre} ${liq}</div><div style="font-size:0.8rem;color:#666;">üì± ${r.celular} | Pax: ${r.cantidad}</div>${obs}</td><td><div style="font-weight:600;">üè® ${r.hotelName}</div><div style="font-size:0.8rem;color:#666;">üõèÔ∏è ${habs}</div><div style="font-size:0.8rem;">üè¢ ${r.agencia}</div></td><td>${statusBadge}<br><small>Venta: ${fmtMoneda(v)}</small></td><td><div style="display:flex;flex-wrap:wrap;">${r.tours.map(t=>`<span class="tag-tour" title="${t.obs||''}">üìÖ ${t.fecha.split('-')[2]}: ${t.nombre}</span>`).join('')}</div></td><td style="text-align:right;"><button class="btn-icon btn-edit" onclick="cargarEdicion(${r.id})">‚úé</button><button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('registros', '${r.firestoreId}')">üóë</button></td></tr>`;
            }).join('');
        }

        // RENDER PASES
        function renderPases(mes) {
            const [y,m] = mes.split('-'); const days = new Date(y, m, 0).getDate();
            let h = '<thead><tr><th class="col-sticky">Detalle Pase</th>'; for(let i=1; i<=days; i++) h += `<th style="text-align:center;">${i}</th>`; h+='</tr></thead><tbody>';
            let pasesMes = window.dbPases.filter(p => p.fecha.startsWith(mes));
            const txt = document.getElementById('buscadorPases').value.toLowerCase();
            const fAgencia = document.getElementById('filtroAgenciaPases').value;
            pasesMes = pasesMes.filter(p => p.nombre.toLowerCase().includes(txt) && (fAgencia==="" || p.agencia===fAgencia));
            
            pasesMes.forEach(p => {
                const v = parseFloat(p.precio)||0; const a = parseFloat(p.adelanto)||0; const s = v-a;
                let statusBadge = (s<=0 && v>0) ? `<br><span class="badge-paid">¬°PAGADO!</span>` : `<br><span class="badge-debt">Falta ${fmtMoneda(s)}</span>`;
                const liq = p.liquidado ? `<span class="badge-liq">Liq.</span>` : '';
                const obsDisplay = p.observacion ? `<div style="font-size:0.7rem;color:#d97706;background:#fff7ed;padding:2px;">‚ö†Ô∏è ${p.observacion}</div>` : '';
                h += `<tr><td class="col-sticky"><div class="pax-card"><div style="color:var(--pase-color);font-weight:bold;">${p.nombre} ${liq}</div><div>üì± ${p.celular} (${p.cantidad} Pax)</div><div>üè® ${p.hotel}</div><div>üè¢ ${p.agencia}</div>${statusBadge}${obsDisplay}<div style="margin-top:5px;"><button class="btn-icon btn-edit" onclick="editarPase(${p.id})">‚úé</button><button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('pases', '${p.firestoreId}')">üóë</button></div></div></td>`;
                for(let d=1; d<=days; d++) { const f = `${y}-${m}-${String(d).padStart(2,'0')}`; h += (p.fecha === f) ? `<td><div class="pase-item">${p.tour}</div></td>` : `<td></td>`; }
                h += '</tr>';
            });
            document.getElementById('tablaPases').innerHTML = h + '</tbody>';
        }

        // REGISTRO
        document.getElementById('formTour').addEventListener('submit', e => { 
            e.preventDefault(); 
            const habs = []; document.querySelectorAll('.room-option input:checked').forEach(c => habs.push(c.value));
            const tours = []; const llg = document.getElementById('llegada').value;
            document.querySelectorAll('.tour-row-input').forEach(row => { 
                const tName = row.querySelector('.sel-tour').value; 
                const tDia = parseInt(row.querySelector('.sel-dia').value); 
                const tObs = row.querySelector('.sel-obs').value;
                if(tName && llg) tours.push({ nombre: tName, fecha: calcularFechaTour(llg, tDia), obs: tObs });
            });
            const data = { 
                id: window.editId || Date.now(),
                nombre: document.getElementById('nombre').value, celular: document.getElementById('celular').value, agencia: document.getElementById('selAgencia').value, cantidad: document.getElementById('cantidad').value,
                precioPaquete: document.getElementById('precioPaquete').value, adelanto: document.getElementById('adelanto').value,
                hotelName: document.getElementById('selHotelName').value, habitaciones: habs, llegada: document.getElementById('llegada').value, retorno: document.getElementById('retorno').value, observaciones: document.getElementById('observaciones').value, tours: tours
            };
            window.guardarRegistroEnNube(data);
        });

        function abrirModalRegistro() { window.editId = null; document.getElementById('reg_firestore_id').value = ''; document.getElementById('modalRegTitulo').innerText="üìù Nuevo Registro"; document.getElementById('formTour').reset(); document.getElementById('listaToursInputs').innerHTML=''; cargarSelects(); document.getElementById('containerHabitaciones').style.display='none'; agregarLineaTour(); document.getElementById('modalRegistro').classList.add('active'); }
        function cargarEdicion(id) { 
            const r = window.db.find(x => x.id === id); if(!r) return; 
            abrirModalRegistro(); window.editId = id; document.getElementById('reg_firestore_id').value = r.firestoreId;
            document.getElementById('modalRegTitulo').innerText = "‚úèÔ∏è Editar Reserva";
            document.getElementById('nombre').value = r.nombre; document.getElementById('celular').value = r.celular; document.getElementById('selAgencia').value = r.agencia; document.getElementById('cantidad').value = r.cantidad;
            document.getElementById('precioPaquete').value = r.precioPaquete; document.getElementById('adelanto').value = r.adelanto;
            document.getElementById('llegada').value = r.llegada; document.getElementById('retorno').value = r.retorno; document.getElementById('observaciones').value = r.observaciones || '';
            document.getElementById('selHotelName').value = r.hotelName; cargarHabitacionesDeHotel(r.hotelName, r.habitaciones);
            document.getElementById('listaToursInputs').innerHTML = '';
            if(r.tours && r.tours.length > 0) { r.tours.forEach(t => { const diff = Math.ceil((new Date(t.fecha) - new Date(r.llegada)) / 86400000); agregarLineaTour(t.nombre, diff, t.obs); }); } else { agregarLineaTour(); }
        }

        // PASES (V43 LOGIC)
        function abrirModalPases() { window.editId = null; document.getElementById('pase_firestore_id').value = ''; document.getElementById('formPase').reset(); setPasePagoMode('adelanto'); cargarSelectsPase(); document.getElementById('modalPases').classList.add('active'); }
        function setPasePagoMode(mode) { 
            document.getElementById('p_modo_pago').value = mode; 
            if (mode === 'pagado') { document.getElementById('opt_pagado').classList.add('active-green'); document.getElementById('opt_adelanto').classList.remove('active'); syncPasePago(); } 
            else { document.getElementById('opt_adelanto').classList.add('active'); document.getElementById('opt_pagado').classList.remove('active-green'); document.getElementById('p_adelanto').readOnly = false; } 
        }
        function syncPasePago() { if (document.getElementById('p_modo_pago').value === 'pagado') { document.getElementById('p_adelanto').value = document.getElementById('p_precio').value; document.getElementById('p_adelanto').readOnly = true; } }
        function calcPaseAuto() { const tName = document.getElementById('p_tour').value; const qty = parseFloat(document.getElementById('p_cantidad').value) || 0; const tourData = window.catalogo.tours.find(t => t.nombre === tName); if(tourData && qty > 0) { const total = parseFloat(tourData.precio) * qty; document.getElementById('p_precio').value = total.toFixed(2); syncPasePago(); } }
        
        document.getElementById('formPase').addEventListener('submit', e => { 
            e.preventDefault(); 
            const precio = parseFloat(document.getElementById('p_precio').value) || 0; const adelanto = parseFloat(document.getElementById('p_adelanto').value) || 0;
            const modo = document.getElementById('p_modo_pago').value;
            const data = { 
                id: window.editId || Date.now(), 
                nombre: document.getElementById('p_nombre').value, celular: document.getElementById('p_celular').value, agencia: document.getElementById('p_agencia').value, cantidad: document.getElementById('p_cantidad').value, hotel: document.getElementById('p_hotel').value, fecha: document.getElementById('p_fecha').value, tour: document.getElementById('p_tour').value, observacion: document.getElementById('p_obs').value, 
                precio: precio, adelanto: adelanto, 
                liquidado: (modo === 'pagado' || (precio > 0 && adelanto >= precio))
            }; 
            window.guardarPaseEnNube(data);
        });

        function editarPase(id) { 
            const p = window.dbPases.find(x => x.id === id); if(!p) return; 
            abrirModalPases(); window.editId = id; document.getElementById('pase_firestore_id').value = p.firestoreId;
            document.getElementById('p_nombre').value = p.nombre; document.getElementById('p_celular').value = p.celular; document.getElementById('p_agencia').value = p.agencia; document.getElementById('p_cantidad').value = p.cantidad; document.getElementById('p_hotel').value = p.hotel; document.getElementById('p_fecha').value = p.fecha; document.getElementById('p_tour').value = p.tour; document.getElementById('p_obs').value = p.observacion || ''; 
            document.getElementById('p_precio').value = p.precio; document.getElementById('p_adelanto').value = p.adelanto;
            if (p.liquidado || (p.precio > 0 && p.adelanto >= p.precio)) setPasePagoMode('pagado'); else setPasePagoMode('adelanto');
        }

        // OPERACIONES Y GASTOS (ADAPTADOS)
        function nuevaOperacion() { document.getElementById('ops_id_actual').value = ''; document.getElementById('ops_firestore_id').value = ''; document.getElementById('ops_fecha').value = new Date().toISOString().split('T')[0]; document.getElementById('ops_tour').value = ''; document.getElementById('ops_conductor').value = ''; document.getElementById('ops_guia').value = ''; document.getElementById('ops_capacidad').value = 15; window.opsTempAsignados = []; cargarPendientesOps(); }
        function cargarPendientesOps() { 
            const f = document.getElementById('ops_fecha').value; const t = document.getElementById('ops_tour').value; 
            const divPend = document.getElementById('lista_ops_pendientes'); const divAsig = document.getElementById('lista_ops_asignados'); 
            divPend.innerHTML = ''; divAsig.innerHTML = ''; 
            if (!f || !t) return;
            // L√≥gica similar a V43 pero usando window.db ...
            // (Simplificado para brevedad, sigue misma l√≥gica de V43)
            let htmlPend = ''; let countPend = 0;
            // Filtramos DB y Pases...
            const candidatosDB = window.db.filter(r => r.tours.some(tour => tour.fecha === f && tour.nombre === t));
            candidatosDB.forEach(c => {
               // Render item logic
               htmlPend += `<div class="ops-item"><div><b>${c.nombre}</b> <small>(Hu√©sped)</small></div><button class="btn-add-ops" onclick="asignarPax(${c.id}, 'db', ${c.cantidad}, '${c.nombre}', '${c.hotelName}')">></button></div>`;
            });
            divPend.innerHTML = htmlPend;
            renderizarAsignados();
        }
        function renderizarAsignados() {
            const divAsig = document.getElementById('lista_ops_asignados'); let html = '';
            window.opsTempAsignados.forEach((p, index) => { html += `<div class="ops-item"><button class="btn-remove-ops" onclick="removerPax(${index})"><</button><div>${p.nombre}</div></div>`; });
            divAsig.innerHTML = html;
        }
        function asignarPax(id, tipo, pax, nombre, hotel) { window.opsTempAsignados.push({ refId: id, tipo, pax, nombre, hotel }); cargarPendientesOps(); }
        function removerPax(i) { window.opsTempAsignados.splice(i, 1); cargarPendientesOps(); }
        function guardarOperacion() {
            const data = { 
                id: document.getElementById('ops_id_actual').value || Date.now(),
                fecha: document.getElementById('ops_fecha').value, tour: document.getElementById('ops_tour').value, conductor: document.getElementById('ops_conductor').value, guia: document.getElementById('ops_guia').value, capacidad: document.getElementById('ops_capacidad').value, pasajeros: window.opsTempAsignados 
            };
            window.guardarOperacionEnNube(data);
        }
        function renderListaOps() {
            const tbody = document.getElementById('tbodyOps');
            tbody.innerHTML = window.dbOps.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(op => `<tr><td>${op.fecha}</td><td>${op.tour}</td><td>${op.conductor}</td><td>${op.capacidad}</td><td>OK</td><td><button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('operaciones', '${op.firestoreId}')">üóë</button></td></tr>`).join('');
        }

        // CATALOGO
        function cargarSelects() {
            const s = document.getElementById('selHotelName'); s.innerHTML='<option value="">Seleccione...</option>'; if(window.catalogo.hoteles) [...new Set(window.catalogo.hoteles.map(h=>h.nombre))].forEach(n=>s.innerHTML+=`<option>${n}</option>`);
            const sa = document.getElementById('selAgencia'); sa.innerHTML='<option value="">Seleccione...</option>'; if(window.catalogo.agencias) window.catalogo.agencias.forEach(a=>sa.innerHTML+=`<option>${a.nombre}</option>`);
        }
        function cargarHabitacionesDeHotel(n, chk=[]) { 
            const l=document.getElementById('listaCheckHabitaciones'); document.getElementById('containerHabitaciones').style.display = n ? 'block' : 'none';
            const rms=window.catalogo.hoteles.filter(h=>h.nombre===n); 
            l.innerHTML = rms.map(r=>`<label class="room-option"><input type="checkbox" value="${r.habitacion}" ${chk.includes(r.habitacion)?'checked':''}><div class="room-card"><span class="r-num">${r.habitacion}</span><span class="r-cap">${r.capacidad}</span></div></label>`).join('');
        }
        function abrirModalCatalogo() { document.getElementById('modalCatalogo').classList.add('active'); cargarSelects(); }
        document.getElementById('formCatalogo').addEventListener('submit', e => {
            e.preventDefault(); 
            // L√≥gica simplificada: Agregar a la lista global y guardar todo el objeto
            const t = document.getElementById('cat_tipo_actual').value; const n = document.getElementById('cat_nombre').value;
            if(t==='hotel') document.querySelectorAll('.room-row').forEach(r=>{ window.catalogo.hoteles.push({ id: Date.now(), nombre: n, habitacion: r.querySelector('.inp-type').value, capacidad: r.querySelector('.inp-cap').value, precio: 0 }); });
            else if(t==='tour') window.catalogo.tours.push({ id: Date.now(), nombre: n, precio: document.getElementById('cat_precio_tour').value });
            else window.catalogo.agencias.push({ id: Date.now(), nombre: n });
            window.guardarCatalogoEnNube();
            window.cerrarModal('modalCatalogo');
        });
        function renderizarCatalogos() { /* (Mismo render que V43 pero usando window.catalogo) */ }
        function agregarFilaHabitacion(){ const d=document.createElement('div'); d.className='room-row'; d.innerHTML=`<input type="text" placeholder="Hab" class="inp-type"><input type="number" placeholder="Cap" class="inp-cap"><button type="button" onclick="this.parentElement.remove()">x</button>`; document.getElementById('room_list').appendChild(d); }
        function cambiarTipoCat(t) { document.getElementById('cat_tipo_actual').value=t; document.getElementById('fields_hotel').style.display=t==='hotel'?'block':'none'; document.getElementById('fields_tour').style.display=t==='tour'?'block':'none'; }

        // EXTRAS
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
        function agregarLineaTour(){ const d=document.createElement('div'); d.className='tour-row-input'; 
            let opts = '<option value="">Tour</option>'; if(window.catalogo.tours) window.catalogo.tours.forEach(t=>opts+=`<option value="${t.nombre}">${t.nombre}</option>`);
            d.innerHTML=`<select class="sel-tour">${opts}</select><select class="sel-dia"><option value="0">D√≠a 1</option><option value="1">D√≠a 2</option></select><input type="text" class="sel-obs" placeholder="Obs"><button type="button" onclick="this.parentElement.remove()" style="color:red;border:none;">x</button>`; 
            document.getElementById('listaToursInputs').appendChild(d); 
        }
        
        // LIQUIDACION
        function generarLiquidacion() {
            const ag = document.getElementById('liq_agencia').value; const desde = document.getElementById('liq_desde').value; const hasta = document.getElementById('liq_hasta').value;
            window.liquidacionData = []; 
            // Filtrar window.db y window.dbPases y llenar liquidacionData...
            // Renderizar tabla...
            document.getElementById('resultadosLiquidacion').style.display = 'block';
        }
        function liquidarRegistros() { window.liquidarEnNube(window.liquidacionData); }

        // --- BACKUP ---
        function descargarBackup() { const data = { db: window.db, dbPases: window.dbPases, catalogo: window.catalogo }; const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_cloud_${new Date().toISOString().slice(0,10)}.json`; a.click(); }

        // RENDER INICIAL
        function renderExcel(data, mes, filtro) { /* (Mismo c√≥digo V43) */ }
        function renderControl(data) { /* (Mismo c√≥digo V43) */ }
    </script>
</body>
</html>
