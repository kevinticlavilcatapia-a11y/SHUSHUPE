<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema SALIDAS - V32 (Filtro Agencia Pases)</title>
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3; --bg-app: #f3f4f6;
            --surface: #ffffff; --text-main: #111827; --text-sec: #6b7280;
            --border: #e5e7eb; --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --money: #059669; --pase-color: #8b5cf6; --ops-color: #0891b2;
            --pay-debt-bg: #fef2f2; --pay-part-bg: #fff7ed; --pay-ok-bg: #ffffff;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 25px; }

        /* HEADER */
        .header-container { background: var(--surface); padding: 15px 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .title-section h1 { margin: 0; font-size: 1.5rem; color: var(--primary); font-weight: 800; }
        .main-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2); }
        .btn-main:hover { background: var(--primary-dark); }
        .btn-sec { background: var(--surface); border: 1px solid var(--border); color: var(--text-sec); padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .btn-sec:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); overflow-x: auto; }
        .tab-btn { padding: 10px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: var(--text-sec); cursor: pointer; margin-bottom: -2px; font-size: 0.95rem; white-space: nowrap; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTILOS COMUNES */
        .card { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { background: #f9fafb; color: #4b5563; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; }
        
        .row-debt { background-color: var(--pay-debt-bg) !important; border-left: 4px solid var(--danger); }
        .row-partial { background-color: var(--pay-part-bg) !important; border-left: 4px solid var(--warning); }
        .row-ok { background-color: var(--pay-ok-bg); border-left: 4px solid var(--success); }
        
        .obs-box { display: block; margin-top: 5px; font-size: 0.75rem; background: #fffbeb; color: #92400e; padding: 4px 8px; border-radius: 6px; border: 1px solid #fcd34d; width: fit-content; }
        .tag-tour { display: inline-block; background: #e0e7ff; color: var(--primary-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin: 2px; border: 1px solid #c7d2fe; }

        /* CALENDARIO & OPS */
        .excel-wrapper { overflow-x: auto; background: var(--surface); border-radius: 12px; height: 75vh; border: 1px solid var(--border); }
        .excel-table th, .excel-table td { border-right: 1px solid var(--border); }
        .excel-table thead { position: sticky; top: 0; z-index: 50; background: #f9fafb; }
        
        .col-sticky { position: sticky; left: 0; background: var(--surface); z-index: 20; border-right: 2px solid var(--border) !important; width: 300px; min-width: 300px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .pax-card { font-size: 0.85rem; display: flex; flex-direction: column; gap: 3px; }
        .day-header { text-align: center; cursor: pointer; transition: background 0.2s; position: relative; color: var(--primary); }
        .day-header:hover { background-color: #e0e7ff; }
        .drop-zone.drag-over { background: #dcfce7 !important; } .cell-stay { background: #f0fdf4; }
        .tour-item { background: white; border-left: 4px solid var(--primary); padding: 4px; font-size: 0.7rem; margin-bottom: 3px; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}

        .pase-item { background: white; border-left: 4px solid var(--pase-color); padding: 4px; font-size: 0.75rem; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; font-weight: 600; color: var(--text-main); }
        
        /* ESTILOS OPERACIONES */
        .ops-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .ops-box { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 15px; height: 60vh; overflow-y: auto; display: flex; flex-direction: column; }
        .ops-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .ops-item:hover { background: #f9fafb; }
        .ops-header { font-weight: 800; color: var(--ops-color); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-add-ops { background: var(--success); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .btn-remove-ops { background: var(--danger); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .capacidad-indicator { font-size: 1.2rem; font-weight: bold; text-align: center; margin: 10px 0; padding: 10px; background: #e0f2fe; border-radius: 8px; color: #0369a1; }
        .capacidad-error { background: #fee2e2; color: #991b1b; }

        .money-cell { font-family: 'Courier New', monospace; font-weight: 700; color: var(--text-main); }
        .badge-debt { color: var(--danger); font-weight: 800; font-size: 0.8rem; background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--danger); }
        .badge-paid { color: var(--success); font-weight: 800; font-size: 0.8rem; }

        /* MODALES */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 16px; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; }
        .btn-icon { width: 28px; height: 28px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; margin-left: 5px; }
        .btn-edit { background: #fff7ed; color: #d97706; } .btn-del { background: #fef2f2; color: #dc2626; }
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .catalog-col { background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid var(--border); max-height: 70vh; display: flex; flex-direction: column; }
        .item-list { overflow-y: auto; flex: 1; }
        .cat-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .room-row { display: grid; grid-template-columns: 2fr 1fr 1fr 30px; gap: 8px; margin-bottom: 8px; }
        .type-selector { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .type-btn { padding: 8px 16px; border: 1px solid var(--border); background: white; border-radius: 20px; cursor: pointer; }
        .type-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .room-checkbox-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-top: 5px; }
        .room-option { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; background: white; padding: 8px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }

        /* IMPRESI√ìN */
        @media print {
            @page { size: A4 landscape; margin: 1cm; }
            body * { visibility: hidden; } #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; padding: 0; background: white; color: black; font-family: 'Arial', sans-serif; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11pt; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: top; }
            .print-table th { background-color: #f0f0f0 !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            button, .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="printableArea"></div>

    <div class="header-container">
        <div class="title-section"><h1>üöÄ SALIDAS <small style="font-size:0.8rem;color:gray;">V32</small></h1></div>
        <div class="main-controls">
            <button class="btn-sec" onclick="descargarBackup()" title="Backup">üíæ</button>
            <label class="btn-sec" style="cursor:pointer;" title="Importar">
                üìÇ <input type="file" onchange="cargarBackup(this)" style="display:none;" accept=".json">
            </label>
            <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
            
            <label style="font-weight:600; color:var(--text-sec);">Mes:</label>
            <input type="month" id="filtroMes" style="padding:8px; border-radius:8px; border:1px solid var(--border);" onchange="actualizarTodo()">
            <button class="btn-main" onclick="abrirModalRegistro()"><span>+</span> Registro</button>
        </div>
    </div>

    <div class="tabs">
        <button id="tabBtnLista" class="tab-btn active" onclick="cambiarVista('lista')">üìã Lista</button>
        <button id="tabBtnExcel" class="tab-btn" onclick="cambiarVista('excel')">üìÖ Calendario</button>
        <button id="tabBtnPases" class="tab-btn" onclick="cambiarVista('pases')" style="color:var(--pase-color);">üé´ Pases</button>
        <button id="tabBtnOps" class="tab-btn" onclick="cambiarVista('ops')" style="color:var(--ops-color);">üöç Operaciones</button>
        <button id="tabBtnCatalogo" class="tab-btn" onclick="cambiarVista('catalogo')">üìö Cat√°logo</button>
        <button id="tabBtnControl" class="tab-btn" onclick="cambiarVista('control')">üí∞ Control</button>
    </div>

    <div id="vistaLista" class="view-section active">
        <div style="margin-bottom:20px;">
            <input type="text" id="buscadorLista" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:300px;" placeholder="üîç Buscar por nombre..." onkeyup="actualizarTodo()">
        </div>
        <div class="card">
            <table style="width:100%">
                <thead><tr><th>Pasajero</th><th>Hotel / Agencia</th><th>Pagos</th><th>Itinerario</th><th style="text-align:right">Acciones</th></tr></thead>
                <tbody id="tbodyLista"></tbody>
            </table>
        </div>
    </div>

    <div id="vistaExcel" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <select id="filtroTourCalendario" style="padding:8px;border-radius:6px;border:1px solid #ccc;" onchange="actualizarTodo()"><option value="">-- Todos los Tours --</option></select>
            <div style="font-size:0.8rem; color:var(--text-sec);">Clic en d√≠a para ruta.</div>
        </div>
        <div class="excel-wrapper"><table class="excel-table" id="tablaExcel"></table></div>
    </div>

    <div id="vistaPases" class="view-section">
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" id="buscadorPases" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:250px;" placeholder="üîç Buscar pase..." onkeyup="actualizarTodo()">
            <select id="filtroAgenciaPases" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:200px;" onchange="actualizarTodo()">
                <option value="">-- Todas las Agencias --</option>
            </select>
            <div style="flex:1;"></div>
            <button class="btn-main" onclick="abrirModalPases()" style="background:var(--pase-color);">+ Nuevo Pase</button>
        </div>
        <div class="excel-wrapper"><table class="excel-table" id="tablaPases"></table></div>
    </div>

    <div id="vistaOps" class="view-section">
        <div class="card" style="padding:20px; margin-bottom:20px; border-top: 4px solid var(--ops-color);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0; color:var(--ops-color);">Gesti√≥n de Salidas (Despacho)</h3>
                <button class="btn-sec" onclick="nuevaOperacion()">üîÑ Limpiar Formulario</button>
            </div>
            <div class="form-grid" style="grid-template-columns:repeat(5, 1fr);">
                <div><label class="form-label">Fecha Salida</label><input type="date" id="ops_fecha" onchange="cargarPendientesOps()"></div>
                <div><label class="form-label">Tour</label><select id="ops_tour" onchange="cargarPendientesOps()"></select></div>
                <div><label class="form-label">Conductor</label><input type="text" id="ops_conductor" placeholder="Nombre Cond."></div>
                <div><label class="form-label">Gu√≠a</label><input type="text" id="ops_guia" placeholder="Nombre Gu√≠a"></div>
                <div><label class="form-label">Capacidad Veh√≠culo</label><input type="number" id="ops_capacidad" value="15" min="1" onchange="actualizarIndicadorCapacidad()"></div>
            </div>
            
            <input type="hidden" id="ops_id_actual"> 

            <div id="indicadorCapacidad" class="capacidad-indicator">0 / 15 Pasajeros</div>

            <div class="ops-container">
                <div class="ops-box">
                    <div class="ops-header">
                        <span>üë• Pendientes (Sin Asignar)</span>
                        <small id="count_pendientes">0</small>
                    </div>
                    <div id="lista_ops_pendientes" style="flex:1;"></div>
                </div>
                
                <div class="ops-box" style="border-color:var(--ops-color); background:#f0f9ff;">
                    <div class="ops-header">
                        <span>üöç En el Veh√≠culo</span>
                        <small id="count_asignados">0</small>
                    </div>
                    <div id="lista_ops_asignados" style="flex:1;"></div>
                </div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn-main" onclick="guardarOperacion()" style="background:var(--ops-color);">üíæ Guardar Operaci√≥n</button>
                <button class="btn-main" onclick="imprimirManifiesto()" style="background:#333;">üñ®Ô∏è Imprimir Manifiesto</button>
            </div>
        </div>

        <h3 style="margin-top:30px;">Salidas Programadas</h3>
        <div class="card">
            <table style="width:100%">
                <thead><tr><th>Fecha</th><th>Tour</th><th>Conductor / Gu√≠a</th><th>Capacidad</th><th>Estado</th><th>Acciones</th></tr></thead>
                <tbody id="tbodyOps"></tbody>
            </table>
        </div>
    </div>

    <div id="vistaCatalogo" class="view-section">
        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="buscadorCatalogo" style="padding:10px; border:1px solid var(--border); border-radius:8px; flex:1;" placeholder="üîç Buscar..." onkeyup="renderizarCatalogos()">
            <button class="btn-main" onclick="abrirModalCatalogo()">+ Nuevo Item</button>
        </div>
        <div class="catalog-grid">
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üè® HOTELES</div><div id="cat_hoteles" class="item-list"></div></div>
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üó∫Ô∏è TOURS</div><div id="cat_tours" class="item-list"></div></div>
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üè¢ AGENCIAS</div><div id="cat_agencias" class="item-list"></div></div>
        </div>
    </div>

    <div id="vistaControl" class="view-section">
        <div class="card">
            <table style="width:100%">
                <thead><tr><th>Pasajero</th><th>Detalle</th><th>Venta</th><th>Adelanto</th><th>Saldo</th><th>Costo Op.</th><th>Ganancia</th></tr></thead>
                <tbody id="tbodyControl"></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="modalRegistro">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
                <h2 id="modalRegTitulo" style="margin:0;color:var(--primary);">Registro</h2>
                <button onclick="cerrarModal('modalRegistro')" style="border:none;background:none;font-size:1.8rem;cursor:pointer;">&times;</button>
            </div>
            <form id="formTour">
                <div class="form-grid">
                    <div><label class="form-label">Nombres y Apellidos</label><input type="text" id="nombre" required placeholder="Ej. Juan P√©rez L√≥pez"></div>
                    <div><label class="form-label">Celular</label><input type="tel" id="celular" required></div>
                    <div><label class="form-label">Agencia</label><select id="selAgencia" required></select></div>
                    <div><label class="form-label">Pax</label><input type="number" id="cantidad" min="1" value="2" required></div>
                </div>
                <div class="form-grid" style="background:var(--pay-part-bg);padding:10px;border-radius:8px;">
                    <div><label style="color:var(--money);">Precio Venta</label><input type="number" id="precioPaquete" required placeholder="0.00"></div>
                    <div><label style="color:#d97706;">Adelanto</label><input type="number" id="adelanto" required placeholder="0.00" value="0"></div>
                </div>
                <div style="background:var(--bg-app);padding:15px;border-radius:10px;margin:20px 0;">
                    <div style="margin-bottom:10px;"><label class="form-label">Hotel</label><select id="selHotelName" required onchange="cargarHabitacionesDeHotel(this.value)"></select></div>
                    <div id="containerHabitaciones" style="display:none;"><label class="form-label">Habitaciones</label><div id="listaCheckHabitaciones" class="room-checkbox-container"></div></div>
                </div>
                <div class="form-grid" style="grid-template-columns:1fr 1fr;">
                    <div><label class="form-label">Llegada</label><input type="date" id="llegada" required onchange="validarFechas()"></div>
                    <div><label class="form-label">Retorno</label><input type="date" id="retorno" required onchange="validarFechas()"></div>
                </div>
                <div style="margin-bottom:20px;"><label class="form-label">Observaciones</label><textarea id="observaciones" style="width:100%;height:60px;padding:8px;border:1px solid #ccc;border-radius:6px;"></textarea></div>
                <div style="background:var(--bg-app);padding:15px;border-radius:10px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:10px;"><label><b>Tours</b></label><button type="button" onclick="agregarLineaTour()" class="btn-main" style="padding:5px 10px;font-size:0.8rem;">+ Agregar</button></div>
                    <div id="listaToursInputs"></div>
                </div>
                <button type="submit" class="btn-main" style="width:100%;margin-top:25px;justify-content:center;padding:12px;">Guardar</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modalPases">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;margin-bottom:20px;">
                <h2 id="modalPasesTitulo" style="margin:0;color:var(--pase-color);">Nuevo Pase (Solo Tour)</h2>
                <button onclick="cerrarModal('modalPases')" style="border:none;background:none;font-size:1.8rem;cursor:pointer;">&times;</button>
            </div>
            <form id="formPase">
                <div class="form-grid">
                    <div><label class="form-label">Nombres y Apellidos</label><input type="text" id="p_nombre" required></div>
                    <div><label class="form-label">Celular</label><input type="tel" id="p_celular" required></div>
                    <div><label class="form-label">Agencia</label><select id="p_agencia" required></select></div>
                    <div><label class="form-label">Pax</label><input type="number" id="p_cantidad" min="1" required></div>
                </div>
                <div style="margin-bottom:20px;">
                    <label class="form-label">Hotel (Nombre)</label>
                    <select id="p_hotel" required></select> </div>
                <div class="form-grid" style="grid-template-columns:1fr 1fr;">
                    <div><label class="form-label">Fecha del Pase</label><input type="date" id="p_fecha" required></div>
                    <div><label class="form-label">Tour a Realizar</label><select id="p_tour" required></select></div>
                </div>
                <button type="submit" class="btn-main" style="width:100%;margin-top:20px;background:var(--pase-color);">Guardar Pase</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modalResumenDia">
        <div class="modal-content" style="max-width:550px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:15px;">
                <h2 style="margin:0;color:var(--primary);">üìÖ Operaciones</h2>
                <button onclick="cerrarModal('modalResumenDia')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <h3 id="resumenFechaTitulo" style="margin:0;color:gray;font-size:1rem;margin-bottom:20px;"></h3>
            <div style="margin-bottom:15px;"><label style="font-weight:bold;">Filtrar Impresi√≥n:</label><select id="selTourPrint" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; margin-top:5px;"></select></div>
            <div id="listaResumenDia" style="border-top:1px solid #eee;"></div>
            <div style="margin-top:20px;text-align:right;"><button class="btn-main" id="btnImprimirRuta">üñ®Ô∏è Imprimir Hoja de Ruta</button></div>
        </div>
    </div>

    <div class="modal" id="modalCatalogo">
        <div class="modal-content" style="max-width:600px;">
            <div style="text-align:center;margin-bottom:20px;"><h2 id="modalCatTitulo" style="margin:0;">Cat√°logo</h2></div>
            <div class="type-selector">
                <button id="typeBtnHotel" type="button" class="type-btn active" onclick="cambiarTipoCat('hotel')">üè® Hotel</button>
                <button id="typeBtnTour" type="button" class="type-btn" onclick="cambiarTipoCat('tour')">üó∫Ô∏è Tour</button>
                <button id="typeBtnAgencia" type="button" class="type-btn" onclick="cambiarTipoCat('agencia')">üè¢ Agencia</button>
            </div>
            <form id="formCatalogo">
                <input type="hidden" id="cat_edit_id"><input type="hidden" id="cat_edit_old_name"><input type="hidden" id="cat_tipo_actual" value="hotel">
                <div style="margin-bottom:20px;"><label>Nombre</label><input type="text" id="cat_nombre" required style="font-weight:bold;width:100%;padding:10px;"></div>
                <div id="fields_tour" style="display:none;margin-bottom:20px;"><label>Precio Costo</label><input type="number" id="cat_precio_tour"></div>
                <div id="fields_hotel">
                    <label>Habitaciones</label>
                    <div style="background:var(--bg-app);padding:10px;border-radius:8px;">
                        <div id="room_list"></div>
                        <button type="button" onclick="agregarFilaHabitacion()" style="color:var(--primary);background:none;border:none;cursor:pointer;margin-top:10px;">+ Agregar</button>
                    </div>
                </div>
                <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                    <button type="button" onclick="cerrarModal('modalCatalogo')" style="padding:10px;border:1px solid #ccc;border-radius:6px;cursor:pointer;">Cancelar</button>
                    <button type="submit" class="btn-main">Guardar</button>
                </div>
            </form>
        </div>
    </div>

<script>
    let db = []; let dbPases = []; let dbOps = []; let catalogo = { hoteles: [], tours: [], agencias: [] }; let editId = null; let dragData = null;
    let opsTempAsignados = []; 

    window.onload = () => {
        const sDB = localStorage.getItem('sys_salidas_v28_db'); if(sDB) db = JSON.parse(sDB);
        const sPas = localStorage.getItem('sys_salidas_v28_pases'); if(sPas) dbPases = JSON.parse(sPas);
        const sOps = localStorage.getItem('sys_salidas_v28_ops'); if(sOps) dbOps = JSON.parse(sOps);
        const sCat = localStorage.getItem('sys_salidas_v28_cat'); if(sCat) catalogo = JSON.parse(sCat);
        document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7);
        cambiarVista('lista'); renderizarCatalogos(); actualizarTodo();
    };

    function guardarDB() { 
        localStorage.setItem('sys_salidas_v28_db', JSON.stringify(db)); 
        localStorage.setItem('sys_salidas_v28_pases', JSON.stringify(dbPases)); 
        localStorage.setItem('sys_salidas_v28_ops', JSON.stringify(dbOps)); 
        actualizarTodo(); 
    }
    
    // --- FORMATO & UTIL ---
    const fmtMoneda = (v) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(v);
    function calcularFechaTour(fechaBase, diasSumar) {
        const parts = fechaBase.split('-');
        const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
        date.setDate(date.getDate() + parseInt(diasSumar));
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function cambiarVista(vista) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('vista' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active');
        document.getElementById('tabBtn' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active');
        if(vista === 'ops') { cargarSelectOps(); nuevaOperacion(); renderListaOps(); }
    }

    function actualizarTodo() {
        const txt = document.getElementById('buscadorLista').value.toLowerCase();
        const mes = document.getElementById('filtroMes').value;
        const filtrado = db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes)) && (r.nombre.toLowerCase().includes(txt)));
        
        const ft = document.getElementById('filtroTourCalendario');
        if(ft.options.length<=1){const tu=[...new Set(catalogo.tours.map(t=>t.nombre))]; ft.innerHTML='<option value="">-- Todos --</option>'+tu.map(t=>`<option value="${t}">${t}</option>`).join('');}

        // Cargar filtro de agencias en pases si est√° vac√≠o
        const fa = document.getElementById('filtroAgenciaPases');
        if(fa.options.length<=1) {
             fa.innerHTML = '<option value="">-- Todas las Agencias --</option>' + catalogo.agencias.map(a => `<option value="${a.nombre}">${a.nombre}</option>`).join('');
        }

        renderLista(filtrado);
        renderExcel(filtrado, mes, ft.value);
        renderPases(mes);
        renderControl(filtrado);
    }

    // --- RENDER LISTA ---
    function renderLista(data) {
        document.getElementById('tbodyLista').innerHTML = data.map(r => {
            const v = parseFloat(r.precioPaquete)||0; const a = parseFloat(r.adelanto)||0; const s = v-a;
            let cls = 'row-ok'; if(s > 0 && a > 0) cls = 'row-partial'; else if(s > 0 && a === 0) cls = 'row-debt';
            const st = s>0 ? `<span class="badge-debt">Falta ${fmtMoneda(s)}</span>` : `<span class="badge-paid">‚úîÔ∏è OK</span>`;
            const obs = r.observaciones ? `<div class="obs-box">‚ö†Ô∏è ${r.observaciones}</div>` : '';
            const habs = Array.isArray(r.habitaciones) ? r.habitaciones.join(', ') : r.habitaciones;

            return `<tr class="${cls}">
                <td style="border-left-width: 4px;">
                    <div style="font-weight:bold; font-size:1rem;">${r.nombre}</div>
                    <div style="font-size:0.8rem;color:#666;">üì± ${r.celular} | Pax: ${r.cantidad}</div>
                    ${obs}
                </td>
                <td><div style="font-weight:600;">üè® ${r.hotelName}</div><div style="font-size:0.8rem;color:#666;">üõèÔ∏è ${habs}</div><div style="font-size:0.8rem;">üè¢ ${r.agencia}</div></td>
                <td>${st}<br><small>Venta: ${fmtMoneda(v)}</small></td>
                <td><div style="display:flex;flex-wrap:wrap;">${r.tours.map(t=>`<span class="tag-tour">üìÖ ${t.fecha.split('-')[2]}: ${t.nombre}</span>`).join('')}</div></td>
                <td style="text-align:right;"><button class="btn-icon btn-edit" onclick="cargarEdicion(${r.id})">‚úé</button><button class="btn-icon btn-del" onclick="if(confirm('Borrar?')){db=db.filter(x=>x.id!=${r.id});guardarDB();}">üóë</button></td>
            </tr>`;
        }).join('');
    }

    function renderExcel(data, mes, filtroTour) {
        const [y,m] = mes.split('-'); const days = new Date(y, m, 0).getDate();
        let h = '<thead><tr><th class="col-sticky">Detalle Cliente</th>';
        for(let i=1; i<=days; i++) h += `<th class="day-header" onclick="abrirResumenDia(${i})">${i}</th>`;
        h+='</tr></thead><tbody>';
        data.forEach(r => {
            const habs = Array.isArray(r.habitaciones) ? r.habitaciones.join(', ') : r.habitaciones;
            h+=`<tr data-pax="${r.id}"><td class="col-sticky">
                <div class="pax-card">
                    <div class="pax-header"><span>${r.nombre}</span><span style="background:#eee;padding:1px 5px;border-radius:4px;color:#333;font-size:0.7rem;">${r.cantidad}</span></div>
                    <div style="font-size:0.75rem;color:#666;">üì± ${r.celular}</div><div style="font-size:0.75rem;color:#666;">üè® ${r.hotelName}</div><div style="font-size:0.7rem;color:var(--primary);">${habs}</div><div class="pax-detail">üè¢ ${r.agencia}</div>
                </div>
            </td>`;
            for(let d=1; d<=days; d++) {
                const f = `${y}-${m}-${String(d).padStart(2,'0')}`;
                const bg = (f >= r.llegada && f <= r.retorno) ? 'cell-stay' : '';
                let ts = r.tours.filter(t=>t.fecha===f); if(filtroTour) ts = ts.filter(t=>t.nombre===filtroTour);
                h+=`<td class="drop-zone ${bg}" data-dia="${d}" ondragover="allowDrop(event)" ondrop="dropTour(event)"><div class="tour-stack">${ts.map(t=>`<div class="tour-item" title="${t.nombre}" draggable="true" ondragstart="dragStart(event,${r.id},${r.tours.indexOf(t)})">${t.nombre}</div>`).join('')}</div></td>`;
            }
            h+='</tr>';
        });
        document.getElementById('tablaExcel').innerHTML = h+'</tbody>';
    }
    
    function renderPases(mes) {
        const [y,m] = mes.split('-'); const days = new Date(y, m, 0).getDate();
        let h = '<thead><tr><th class="col-sticky">Detalle Pase</th>';
        for(let i=1; i<=days; i++) h += `<th style="text-align:center;">${i}</th>`;
        h+='</tr></thead><tbody>';
        
        let pasesMes = dbPases.filter(p => p.fecha.startsWith(mes));
        const txt = document.getElementById('buscadorPases').value.toLowerCase();
        const fAgencia = document.getElementById('filtroAgenciaPases').value;
        
        // Aplicar filtros
        pasesMes = pasesMes.filter(p => {
            const matchNombre = p.nombre.toLowerCase().includes(txt);
            const matchAgencia = fAgencia === "" || p.agencia === fAgencia;
            return matchNombre && matchAgencia;
        });
        
        pasesMes.forEach(p => {
            h += `<tr><td class="col-sticky"><div class="pax-card"><div style="color:var(--pase-color);font-weight:bold;">${p.nombre}</div><div>üì± ${p.celular} (${p.cantidad} Pax)</div><div>üè® ${p.hotel}</div><div>üè¢ ${p.agencia}</div><div style="margin-top:5px;"><button class="btn-icon btn-edit" onclick="editarPase(${p.id})">‚úé</button><button class="btn-icon btn-del" onclick="if(confirm('Borrar?')){dbPases=dbPases.filter(x=>x.id!=${p.id});guardarDB();}">üóë</button></div></div></td>`;
            for(let d=1; d<=days; d++) {
                const f = `${y}-${m}-${String(d).padStart(2,'0')}`;
                if (p.fecha === f) h += `<td><div class="pase-item">${p.tour}</div></td>`; else h += `<td></td>`;
            }
            h += '</tr>';
        });
        document.getElementById('tablaPases').innerHTML = h + '</tbody>';
    }

    function renderControl(data) {
        document.getElementById('tbodyControl').innerHTML = data.map(r => {
            const habs = Array.isArray(r.habitaciones) ? r.habitaciones : [r.habitaciones];
            const dur = Math.ceil((new Date(r.retorno)-new Date(r.llegada))/86400000);
            let ch=0; habs.forEach(ht => { const hd = catalogo.hoteles.find(h=>h.nombre===r.hotelName && h.habitacion===ht); ch += (hd?parseFloat(hd.precio):0)*dur; });
            let ct=0; r.tours.forEach(t => { const td = catalogo.tours.find(x=>x.nombre===t.nombre); ct += (td?parseFloat(td.precio):0)*r.cantidad; });
            const op = ch+ct; const v = parseFloat(r.precioPaquete)||0; const a = parseFloat(r.adelanto)||0; const s = v-a; const u = v-op;
            return `<tr><td><b>${r.nombre}</b><br><small>${r.cantidad} pax</small></td><td>${r.hotelName}<br>${r.agencia}</td><td class="money-cell">${fmtMoneda(v)}</td><td class="money-cell">${fmtMoneda(a)}</td><td>${s>0?`<span class="badge-debt">${fmtMoneda(s)}</span>`:`<span class="badge-paid">Pagado</span>`}</td><td class="money-cell">${fmtMoneda(op)}</td><td class="money-cell" style="color:${u>=0?'var(--money)':'red'}">${fmtMoneda(u)}</td></tr>`;
        }).join('');
    }

    // --- M√ìDULO OPERACIONES ---
    function cargarSelectOps() { const s = document.getElementById('ops_tour'); s.innerHTML = '<option value="">Seleccione Tour</option>' + catalogo.tours.map(t => `<option value="${t.nombre}">${t.nombre}</option>`).join(''); }
    function nuevaOperacion() { document.getElementById('ops_id_actual').value = ''; document.getElementById('ops_fecha').value = new Date().toISOString().split('T')[0]; document.getElementById('ops_tour').value = ''; document.getElementById('ops_conductor').value = ''; document.getElementById('ops_guia').value = ''; document.getElementById('ops_capacidad').value = 15; opsTempAsignados = []; cargarPendientesOps(); }
    function cargarPendientesOps() { const f = document.getElementById('ops_fecha').value; const t = document.getElementById('ops_tour').value; const divPend = document.getElementById('lista_ops_pendientes'); const divAsig = document.getElementById('lista_ops_asignados'); divPend.innerHTML = ''; divAsig.innerHTML = ''; if (!f || !t) return; const candidatosDB = db.filter(r => r.tours.some(tour => tour.fecha === f && tour.nombre === t)); const candidatosPases = dbPases.filter(p => p.fecha === f && p.tour === t); const idActual = document.getElementById('ops_id_actual').value; const pasajerosOcupadosEnOtras = []; dbOps.forEach(op => { if (op.id != idActual && op.fecha === f && op.tour === t) { op.pasajeros.forEach(p => pasajerosOcupadosEnOtras.push(p.refId + '_' + p.tipo)); } }); let htmlPend = ''; let countPend = 0; const renderItem = (id, nombre, pax, hotel, tipo) => { const yaAsignadoAqui = opsTempAsignados.find(x => x.refId == id && x.tipo == tipo); if (yaAsignadoAqui) return; if (pasajerosOcupadosEnOtras.includes(id + '_' + tipo)) return; countPend += parseInt(pax); return `<div class="ops-item"><div><b>${nombre}</b> <small>(${tipo === 'db' ? 'Hu√©sped' : 'Pase'})</small><br>Pax: <b>${pax}</b> | ${hotel}</div><button class="btn-add-ops" onclick="asignarPax(${id}, '${tipo}', ${pax}, '${nombre.replace(/'/g, "")}', '${hotel.replace(/'/g, "")}')">></button></div>`; }; candidatosDB.forEach(c => { const h = renderItem(c.id, c.nombre, c.cantidad, c.hotelName, 'db'); if(h) htmlPend += h; }); candidatosPases.forEach(c => { const h = renderItem(c.id, c.nombre, c.cantidad, c.hotel, 'pase'); if(h) htmlPend += h; }); divPend.innerHTML = htmlPend || '<div style="padding:10px; color:gray;">No hay clientes pendientes para este d√≠a/tour.</div>'; document.getElementById('count_pendientes').innerText = countPend; renderizarAsignados(); }
    function renderizarAsignados() { const divAsig = document.getElementById('lista_ops_asignados'); let htmlAsig = ''; let totalPax = 0; opsTempAsignados.forEach((p, index) => { totalPax += parseInt(p.pax); htmlAsig += `<div class="ops-item"><button class="btn-remove-ops" onclick="removerPax(${index})"><</button><div style="text-align:right;"><b>${p.nombre}</b><br>Pax: <b>${p.pax}</b> | ${p.hotel}</div></div>`; }); divAsig.innerHTML = htmlAsig || '<div style="padding:10px; color:gray;">Veh√≠culo vac√≠o.</div>'; document.getElementById('count_asignados').innerText = totalPax; actualizarIndicadorCapacidad(totalPax); }
    function asignarPax(id, tipo, pax, nombre, hotel) { const capMax = parseInt(document.getElementById('ops_capacidad').value); const actual = opsTempAsignados.reduce((sum, p) => sum + parseInt(p.pax), 0); if (actual + parseInt(pax) > capMax) { alert(`‚ö†Ô∏è No se puede agregar. Excede la capacidad (${capMax}). Espacio restante: ${capMax - actual}`); return; } opsTempAsignados.push({ refId: id, tipo: tipo, pax: pax, nombre: nombre, hotel: hotel }); cargarPendientesOps(); }
    function removerPax(index) { opsTempAsignados.splice(index, 1); cargarPendientesOps(); }
    function actualizarIndicadorCapacidad(currentPax = null) { if (currentPax === null) currentPax = opsTempAsignados.reduce((sum, p) => sum + parseInt(p.pax), 0); const max = document.getElementById('ops_capacidad').value; const ind = document.getElementById('indicadorCapacidad'); ind.innerText = `${currentPax} / ${max} Pasajeros`; if (currentPax > max) { ind.classList.add('capacidad-error'); } else { ind.classList.remove('capacidad-error'); } }
    function guardarOperacion() { if (opsTempAsignados.length === 0) { if(!confirm("La operaci√≥n no tiene pasajeros. ¬øGuardar vac√≠a?")) return; } const idActual = document.getElementById('ops_id_actual').value; const nuevaOp = { id: idActual ? parseInt(idActual) : Date.now(), fecha: document.getElementById('ops_fecha').value, tour: document.getElementById('ops_tour').value, conductor: document.getElementById('ops_conductor').value, guia: document.getElementById('ops_guia').value, capacidad: document.getElementById('ops_capacidad').value, pasajeros: opsTempAsignados }; if(!nuevaOp.fecha || !nuevaOp.tour || !nuevaOp.conductor) { alert("Complete Fecha, Tour y Conductor"); return; } if (idActual) { const idx = dbOps.findIndex(x => x.id == idActual); dbOps[idx] = nuevaOp; } else { dbOps.push(nuevaOp); } guardarDB(); alert("Operaci√≥n Guardada Correctamente"); nuevaOperacion(); renderListaOps(); }
    function renderListaOps() { const tbody = document.getElementById('tbodyOps'); tbody.innerHTML = dbOps.sort((a,b) => b.fecha.localeCompare(a.fecha)).map(op => { const totalPax = op.pasajeros.reduce((s, p) => s + parseInt(p.pax), 0); return `<tr><td>${op.fecha}</td><td>${op.tour}</td><td>üëÆ ${op.conductor}<br>üö© ${op.guia}</td><td>${totalPax} / ${op.capacidad}</td><td>${totalPax >= op.capacidad ? '<span class="badge-debt">LLENO</span>' : '<span class="badge-paid">OK</span>'}</td><td><button class="btn-icon btn-edit" onclick="cargarOp(${op.id})">‚úé</button><button class="btn-icon btn-del" onclick="if(confirm('Borrar operaci√≥n?')){dbOps=dbOps.filter(x=>x.id!=${op.id});guardarDB();renderListaOps();}">üóë</button></td></tr>`; }).join(''); }
    function cargarOp(id) { const op = dbOps.find(x => x.id === id); if(!op) return; document.getElementById('ops_id_actual').value = op.id; document.getElementById('ops_fecha').value = op.fecha; document.getElementById('ops_tour').value = op.tour; document.getElementById('ops_conductor').value = op.conductor; document.getElementById('ops_guia').value = op.guia; document.getElementById('ops_capacidad').value = op.capacidad; opsTempAsignados = [...op.pasajeros]; cargarPendientesOps(); document.querySelector('.ops-container').scrollIntoView({behavior: 'smooth'}); }
    function imprimirManifiesto() { const cond = document.getElementById('ops_conductor').value; const guia = document.getElementById('ops_guia').value; const tour = document.getElementById('ops_tour').value; const fecha = document.getElementById('ops_fecha').value; if (opsTempAsignados.length === 0) return alert("No hay pasajeros para imprimir"); let h = `<div class="print-header"><h2>MANIFIESTO DE PASAJEROS</h2><p>Fecha: ${fecha} | Tour: ${tour}</p><p>Conductor: ${cond} | Gu√≠a: ${guia}</p></div><table class="print-table"><thead><tr><th>N¬∞</th><th>PASAJERO</th><th>PAX</th><th>HOTEL</th><th>CELULAR</th><th>OBS</th></tr></thead><tbody>`; let i = 1; let total = 0; opsTempAsignados.forEach(p => { total += parseInt(p.pax); let dataReal; let cel = '', obs = ''; if (p.tipo === 'db') { dataReal = db.find(x => x.id == p.refId); if(dataReal) { cel = dataReal.celular; obs = dataReal.observaciones || ''; } } else { dataReal = dbPases.find(x => x.id == p.refId); if(dataReal) { cel = dataReal.celular; obs = '(PASE)'; } } h += `<tr><td>${i++}</td><td>${p.nombre}</td><td style="text-align:center;">${p.pax}</td><td>${p.hotel}</td><td>${cel}</td><td>${obs}</td></tr>`; }); h += `</tbody></table><h3 style="text-align:right; margin-top:10px;">Total Pax: ${total}</h3>`; document.getElementById('printableArea').innerHTML=h; window.print(); document.getElementById('printableArea').innerHTML=''; }

    // --- FUNCIONES RESTANTES (Backup, Pases, Registro, Catalogos, DragDrop, etc.) ---
    function descargarBackup() { const data = { db, dbPases, dbOps, catalogo, version: 'V32', fecha: new Date().toISOString() }; const blob = new Blob([JSON.stringify(data)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_salidas_${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function cargarBackup(input) { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = e => { try { const d = JSON.parse(e.target.result); if(confirm(`Restaurar backup del ${d.fecha}?`)){ db=d.db; dbPases=d.dbPases; dbOps=d.dbOps||[]; catalogo=d.catalogo; guardarDB(); location.reload(); } } catch(err){alert("Error archivo");} }; r.readAsText(f); }
    function abrirModalPases() { editId = null; document.getElementById('formPase').reset(); cargarSelectsPase(); document.getElementById('modalPases').classList.add('active'); }
    function cargarSelectsPase(){ const gr={}; catalogo.hoteles.forEach(h=>{if(!gr[h.nombre])gr[h.nombre]=true;}); document.getElementById('p_hotel').innerHTML='<option value="">Sel. Hotel</option>'+Object.keys(gr).map(n=>`<option>${n}</option>`).join(''); document.getElementById('p_agencia').innerHTML='<option value="">Sel. Agencia</option>'+catalogo.agencias.map(a=>`<option>${a.nombre}</option>`).join(''); document.getElementById('p_tour').innerHTML='<option value="">Sel. Tour</option>'+catalogo.tours.map(t=>`<option value="${t.nombre}">${t.nombre}</option>`).join(''); }
    document.getElementById('formPase').addEventListener('submit', e => { e.preventDefault(); const data = { id: editId || Date.now(), nombre: document.getElementById('p_nombre').value, celular: document.getElementById('p_celular').value, agencia: document.getElementById('p_agencia').value, cantidad: document.getElementById('p_cantidad').value, hotel: document.getElementById('p_hotel').value, fecha: document.getElementById('p_fecha').value, tour: document.getElementById('p_tour').value }; if(editId) dbPases[dbPases.findIndex(x=>x.id===editId)] = data; else dbPases.push(data); guardarDB(); cerrarModal('modalPases'); });
    function editarPase(id) { abrirModalPases(); const p = dbPases.find(x => x.id === id); if(!p) return; editId = id; document.getElementById('p_nombre').value = p.nombre; document.getElementById('p_celular').value = p.celular; document.getElementById('p_agencia').value = p.agencia; document.getElementById('p_cantidad').value = p.cantidad; document.getElementById('p_hotel').value = p.hotel; document.getElementById('p_fecha').value = p.fecha; document.getElementById('p_tour').value = p.tour; }
    function validarFechas() { const i=document.getElementById('llegada').value, f=document.getElementById('retorno').value; if(i&&f&&f<i){ alert("Retorno anterior a llegada"); document.getElementById('retorno').value=i;} actualizarSelectores(); }
    document.getElementById('formTour').addEventListener('submit', e => { e.preventDefault(); const habs = []; document.querySelectorAll('.chk-habitacion:checked').forEach(c => habs.push(c.value)); const tours = []; const llg = document.getElementById('llegada').value; document.querySelectorAll('.tour-row-input').forEach(row => { const tName = row.querySelector('.sel-tour').value; const tDia = parseInt(row.querySelector('.sel-dia').value); if(tName && llg) { tours.push({ nombre: tName, fecha: calcularFechaTour(llg, tDia) }); } }); const data = { id: editId || Date.now(), nombre: document.getElementById('nombre').value, celular: document.getElementById('celular').value, agencia: document.getElementById('selAgencia').value, cantidad: document.getElementById('cantidad').value, precioPaquete: document.getElementById('precioPaquete').value, adelanto: document.getElementById('adelanto').value, hotelName: document.getElementById('selHotelName').value, habitaciones: habs, llegada: document.getElementById('llegada').value, retorno: document.getElementById('retorno').value, observaciones: document.getElementById('observaciones').value, tours: tours }; if(editId) { const idx = db.findIndex(x => x.id === editId); if(idx !== -1) db[idx] = data; } else { db.push(data); } guardarDB(); cerrarModal('modalRegistro'); });
    function cargarEdicion(id) { const r = db.find(x => x.id === id); if(!r) return; abrirModalRegistro(); editId = id; document.getElementById('modalRegTitulo').innerText = "Editar Registro"; document.getElementById('nombre').value = r.nombre; document.getElementById('celular').value = r.celular; document.getElementById('selAgencia').value = r.agencia; document.getElementById('cantidad').value = r.cantidad; document.getElementById('precioPaquete').value = r.precioPaquete; document.getElementById('adelanto').value = r.adelanto; document.getElementById('llegada').value = r.llegada; document.getElementById('retorno').value = r.retorno; document.getElementById('observaciones').value = r.observaciones || ''; document.getElementById('selHotelName').value = r.hotelName; cargarHabitacionesDeHotel(r.hotelName, r.habitaciones); document.getElementById('listaToursInputs').innerHTML = ''; if(r.tours && r.tours.length > 0) { r.tours.forEach(t => { const diff = Math.ceil((new Date(t.fecha) - new Date(r.llegada)) / 86400000); agregarLineaTour(t.nombre, diff); }); } else { agregarLineaTour(); } }
    function dragStart(ev,pid,tid){dragData={pid,tid};ev.dataTransfer.effectAllowed="move";} function allowDrop(ev){ev.preventDefault();ev.target.closest('td')?.classList.add('drag-over');} document.addEventListener('dragleave',e=>e.target.closest('td')?.classList.remove('drag-over'));
    function dropTour(ev){ev.preventDefault(); const c=ev.target.closest('td'); document.querySelectorAll('.drop-zone').forEach(x=>x.classList.remove('drag-over')); if(!c||!dragData)return; const pid=parseInt(c.parentElement.getAttribute('data-pax')); const dia=parseInt(c.getAttribute('data-dia')); const f=document.getElementById('filtroMes').value+'-'+String(dia).padStart(2,'0'); if(pid!==dragData.pid) return alert("Solo mover mismo pax"); const p=db.find(x=>x.id===pid); if(f<p.llegada||f>p.retorno)return alert("Fuera estad√≠a"); p.tours[dragData.tid].fecha=f; guardarDB();}
    function abrirResumenDia(dia){ const m=document.getElementById('filtroMes').value; const f=`${m}-${String(dia).padStart(2,'0')}`; document.getElementById('resumenFechaTitulo').innerText=f; const toursDia = new Set(); db.forEach(r => r.tours.filter(t => t.fecha === f).forEach(t => toursDia.add(t.nombre))); dbPases.filter(p => p.fecha === f).forEach(p => toursDia.add(p.tour)); const selTour = document.getElementById('selTourPrint'); selTour.innerHTML = '<option value="TODOS">-- Imprimir TODOS --</option>' + Array.from(toursDia).map(t => `<option value="${t}">${t}</option>`).join(''); document.getElementById('btnImprimirRuta').onclick = () => imprimirHoja(f, selTour.value); const listDiv = document.getElementById('listaResumenDia'); let html = ''; toursDia.forEach(tName => { let total = 0; db.forEach(r => { if(r.tours.some(t => t.fecha===f && t.nombre===tName)) total += parseInt(r.cantidad); }); dbPases.filter(p => p.fecha===f && p.tour===tName).forEach(p => total += parseInt(p.cantidad)); html += `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;"><span>${tName}</span><b>${total} Pax</b></div>`; }); listDiv.innerHTML = html || 'Sin movimientos.'; document.getElementById('modalResumenDia').classList.add('active'); }
    function imprimirHoja(f, tourFilter){ let l=[]; db.forEach(r=>{const t=r.tours.find(x=>x.fecha===f); if(t && (tourFilter==='TODOS' || t.nombre===tourFilter)) l.push({...r, tour:t.nombre, tipo:'Hu√©sped'});}); dbPases.filter(p => p.fecha === f && (tourFilter==='TODOS' || p.tour===tourFilter)).forEach(p => l.push({...p, hotelName: p.hotel, observaciones:'(PASE)', tipo:'Pase'})); l.sort((a,b)=>a.tour.localeCompare(b.tour)); let h=`<div class="print-header"><h2>HOJA DE RUTA: ${f}</h2><p>Destino: ${tourFilter==='TODOS' ? 'General' : tourFilter}</p></div><table class="print-table"><thead><tr><th>TOUR</th><th>PASAJERO</th><th>PAX</th><th>HOTEL</th><th>CELULAR</th><th>AGENCIA</th><th>OBS</th></tr></thead><tbody>`; let totalPax = 0; l.forEach(x=>{ totalPax += parseInt(x.cantidad); h+=`<tr><td>${x.tour}</td><td>${x.nombre}</td><td style="text-align:center;">${x.cantidad}</td><td>${x.hotelName} ${x.habitaciones||''}</td><td>${x.celular}</td><td>${x.agencia}</td><td>${x.observaciones||''}</td></tr>`; }); h+=`</tbody></table><h3 style="text-align:right; margin-top:10px;">Total Pax: ${totalPax}</h3>`; document.getElementById('printableArea').innerHTML=h; window.print(); document.getElementById('printableArea').innerHTML=''; }
    function abrirModalCatalogo(){document.getElementById('formCatalogo').reset();document.getElementById('cat_edit_id').value='';document.getElementById('room_list').innerHTML='';cambiarTipoCat('hotel');agregarFilaHabitacion();document.getElementById('modalCatalogo').classList.add('active');}
    function cambiarTipoCat(t){document.getElementById('cat_tipo_actual').value=t;document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));const idx=t==='hotel'?0:t==='tour'?1:2;document.querySelectorAll('.type-btn')[idx].classList.add('active');document.getElementById('fields_hotel').style.display=t==='hotel'?'block':'none';document.getElementById('fields_tour').style.display=t==='tour'?'block':'none';document.querySelectorAll('.inp-type').forEach(e=>e.required=(t==='hotel'));}
    document.getElementById('formCatalogo').addEventListener('submit',e=>{e.preventDefault();const t=document.getElementById('cat_tipo_actual').value;const n=document.getElementById('cat_nombre').value;const old=document.getElementById('cat_edit_old_name').value;const id=document.getElementById('cat_edit_id').value;if(t==='hotel'){if(old)catalogo.hoteles=catalogo.hoteles.filter(h=>h.nombre!==old);document.querySelectorAll('.room-row').forEach(r=>{catalogo.hoteles.push({id:Date.now()+Math.random(),nombre:n,habitacion:r.querySelector('.inp-type').value,capacidad:r.querySelector('.inp-cap').value,precio:r.querySelector('.inp-price').value});});}else if(t==='tour'){const d={id:id||Date.now(),nombre:n,precio:document.getElementById('cat_precio_tour').value};if(id){const i=catalogo.tours.findIndex(x=>x.id==id);catalogo.tours[i]=d;}else catalogo.tours.push(d);}else{const d={id:id||Date.now(),nombre:n};if(id){const i=catalogo.agencias.findIndex(x=>x.id==id);catalogo.agencias[i]=d;}else catalogo.agencias.push(d);}guardarCat();cerrarModal('modalCatalogo');});
    function editarCat(tipo, idOrName) { abrirModalCatalogo(); cambiarTipoCat(tipo); if(tipo === 'hotel') { document.getElementById('cat_nombre').value = idOrName; document.getElementById('cat_edit_old_name').value = idOrName; document.getElementById('room_list').innerHTML = ''; catalogo.hoteles.filter(h => h.nombre === idOrName).forEach(r => agregarFilaHabitacion(r.habitacion, r.capacidad, r.precio)); } else if (tipo === 'tour') { const t = catalogo.tours.find(x => x.id == idOrName); document.getElementById('cat_nombre').value = t.nombre; document.getElementById('cat_precio_tour').value = t.precio; document.getElementById('cat_edit_id').value = t.id; } else { const a = catalogo.agencias.find(x => x.id == idOrName); document.getElementById('cat_nombre').value = a.nombre; document.getElementById('cat_edit_id').value = a.id; } }
    function eliminarCat(t,i){if(!confirm("Borrar?"))return;if(t==='hotel')catalogo.hoteles=catalogo.hoteles.filter(x=>x.nombre!==i);else if(t==='tour')catalogo.tours=catalogo.tours.filter(x=>x.id!=i);else catalogo.agencias=catalogo.agencias.filter(x=>x.id!=i);guardarCat();}
    function renderizarCatalogos(){const txt=document.getElementById('buscadorCatalogo').value.toLowerCase();const gr={}; catalogo.hoteles.forEach(h=>{if(!gr[h.nombre])gr[h.nombre]=[];gr[h.nombre].push(h);});document.getElementById('cat_hoteles').innerHTML=Object.keys(gr).filter(k=>k.toLowerCase().includes(txt)).map(k=>`<div class="cat-item"><b>${k}</b> <span>${gr[k].length} habs</span> <div><button class="btn-icon btn-edit" onclick="editarCat('hotel','${k}')">‚úé</button><button class="btn-icon btn-del" onclick="eliminarCat('hotel','${k}')">üóë</button></div></div>`).join('');document.getElementById('cat_tours').innerHTML=catalogo.tours.filter(t=>t.nombre.toLowerCase().includes(txt)).map(t=>`<div class="cat-item">${t.nombre} <span>${fmtMoneda(t.precio)}</span> <div><button class="btn-icon btn-edit" onclick="editarCat('tour',${t.id})">‚úé</button><button class="btn-icon btn-del" onclick="eliminarCat('tour',${t.id})">üóë</button></div></div>`).join('');document.getElementById('cat_agencias').innerHTML=catalogo.agencias.filter(a=>a.nombre.toLowerCase().includes(txt)).map(a=>`<div class="cat-item">${a.nombre} <div><button class="btn-icon btn-edit" onclick="editarCat('agencia',${a.id})">‚úé</button><button class="btn-icon btn-del" onclick="eliminarCat('agencia',${a.id})">üóë</button></div></div>`).join('');}
    function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
    function agregarLineaTour(v='',d=0){const el=document.createElement('div');el.className='tour-row-input';el.style.cssText="display:grid;grid-template-columns:2fr 1fr 30px;gap:5px;margin-bottom:5px;";const opts='<option value="">Tour</option>'+catalogo.tours.map(t=>`<option value="${t.nombre}" ${t.nombre===v?'selected':''}>${t.nombre}</option>`).join('');const i=document.getElementById('llegada').value;const f=document.getElementById('retorno').value;let od='';if(i&&f){const c=Math.ceil((new Date(f)-new Date(i))/86400000)+1;for(let j=0;j<c;j++)od+=`<option value="${j}" ${j===d?'selected':''}>D√≠a ${j+1} ${j===0?'(Llegada)':''}</option>`;}el.innerHTML=`<select class="sel-tour">${opts}</select><select class="sel-dia">${od}</select><button type="button" onclick="this.parentElement.remove()" style="color:red;border:none;">&times;</button>`;document.getElementById('listaToursInputs').appendChild(el);}
    function agregarFilaHabitacion(t='',c='',p=''){const d=document.createElement('div');d.className='room-row';d.innerHTML=`<input type="text" placeholder="Tipo" value="${t}" class="inp-type"><input type="number" placeholder="Cap." value="${c}" class="inp-cap"><input type="number" placeholder="S/." value="${p}" class="inp-price"><button type="button" onclick="this.parentElement.remove()" style="color:red;border:none;">&times;</button>`;document.getElementById('room_list').appendChild(d);if(document.getElementById('cat_tipo_actual').value!=='hotel')d.querySelector('.inp-type').required=false;}
    function actualizarSelectores(){document.querySelectorAll('.sel-dia').forEach(s=>{const o=s.value;const i=document.getElementById('llegada').value;const f=document.getElementById('retorno').value;let h='';if(i&&f){const c=Math.ceil((new Date(f)-new Date(i))/86400000)+1;for(let j=0;j<c;j++)h+=`<option value="${j}">D√≠a ${j+1} ${j===0?'(Llegada)':''}</option>`;}s.innerHTML=h;s.value=o;});}
    function abrirModalRegistro() {editId=null; document.getElementById('modalRegTitulo').innerText="Registro"; document.getElementById('formTour').reset(); document.getElementById('listaToursInputs').innerHTML=''; cargarSelects(); document.getElementById('containerHabitaciones').style.display='none'; agregarLineaTour(); document.getElementById('modalRegistro').classList.add('active');}
    function cargarSelects() {const gr={}; catalogo.hoteles.forEach(h=>{if(!gr[h.nombre])gr[h.nombre]=true;});document.getElementById('selHotelName').innerHTML='<option value="">Seleccione...</option>'+Object.keys(gr).map(n=>`<option>${n}</option>`).join('');document.getElementById('selAgencia').innerHTML='<option value="">Seleccione...</option>'+catalogo.agencias.map(a=>`<option>${a.nombre}</option>`).join('');}
    function cargarHabitacionesDeHotel(n, chk=[]) {const c=document.getElementById('containerHabitaciones'); const l=document.getElementById('listaCheckHabitaciones');if(!n){c.style.display='none';return;} c.style.display='block';const rms=catalogo.hoteles.filter(h=>h.nombre===n);l.innerHTML=rms.length?rms.map(r=>`<label class="room-option"><input type="checkbox" value="${r.habitacion}" class="chk-habitacion" ${chk.includes(r.habitacion)?'checked':''}> ${r.habitacion} <small>(${r.capacidad})</small></label>`).join(''):'Sin habs';}
</script>
</body>
</html>
