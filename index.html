<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema SALIDAS - Dashboard</title>
    <style>
        /* ESTILOS GENERALES Y PRO */
        :root {
            --primary: #4f46e5; --primary-dark: #3730a3; --primary-light: #e0e7ff;
            --bg-app: #f3f4f6; --surface: #ffffff; 
            --text-main: #111827; --text-sec: #6b7280; --border: #e5e7eb;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --money: #059669; --pase-color: #8b5cf6; --ops-color: #0891b2;
            --pay-debt-bg: #fef2f2; --pay-part-bg: #fff7ed; --pay-ok-bg: #f0fdf4;
            --report-color: #be185d; --expense-color: #b91c1c;
        }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg-app); color: var(--text-main); margin: 0; padding: 25px; }
        
        /* HEADER */
        .header-container { background: var(--surface); padding: 10px 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .title-section h1 { margin: 0; font-size: 1.4rem; color: var(--primary); font-weight: 800; letter-spacing: -0.025em; }
        
        .main-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .control-group-right { display: flex; align-items: center; gap: 5px; background: #f8fafc; padding: 4px; border-radius: 8px; border: 1px solid var(--border); }
        .input-month-compact { border: none; background: transparent; font-family: inherit; font-size: 0.9rem; color: var(--text-main); padding: 5px; outline: none; cursor: pointer; }
        .btn-reg-compact { background: var(--primary); color: white; border: none; padding: 6px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-reg-compact:hover { background: var(--primary-dark); }
        .btn-sec { background: var(--surface); border: 1px solid var(--border); color: var(--text-sec); padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; }
        .btn-sec:hover { background: #f9fafb; color: var(--primary); border-color: var(--primary); }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border); overflow-x: auto; scrollbar-width: none; }
        .tab-btn { padding: 10px 20px; background: transparent; border: none; border-bottom: 3px solid transparent; font-weight: 600; color: var(--text-sec); cursor: pointer; margin-bottom: -2px; font-size: 0.95rem; white-space: nowrap; transition: 0.2s; }
        .tab-btn:hover { color: var(--primary); }
        .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); }
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & TABLES */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { background: #f9fafb; color: #4b5563; font-size: 0.75rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; }
        .row-debt { background-color: var(--pay-debt-bg) !important; border-left: 4px solid var(--danger); }
        .row-partial { background-color: var(--pay-part-bg) !important; border-left: 4px solid var(--warning); }
        .row-ok { background-color: var(--pay-ok-bg); border-left: 4px solid var(--success); }
        .obs-box { display: block; margin-top: 5px; font-size: 0.75rem; background: #fffbeb; color: #92400e; padding: 4px 8px; border-radius: 6px; border: 1px solid #fcd34d; width: fit-content; }
        .tag-tour { display: inline-block; background: var(--primary-light); color: var(--primary-dark); padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; margin: 2px; border: 1px solid #c7d2fe; }

        /* CALENDARIO & OPS */
        .excel-wrapper { overflow-x: auto; background: var(--surface); border-radius: 12px; height: 75vh; border: 1px solid var(--border); }
        .excel-table th, .excel-table td { border-right: 1px solid var(--border); }
        .excel-table thead { position: sticky; top: 0; z-index: 50; background: #f9fafb; }
        .col-sticky { position: sticky; left: 0; background: var(--surface); z-index: 20; border-right: 2px solid var(--border) !important; width: 300px; min-width: 300px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .day-header { text-align: center; cursor: pointer; transition: background 0.2s; position: relative; color: var(--primary); padding: 10px; }
        .day-header:hover { background-color: var(--primary-light); }
        .drop-zone.drag-over { background: #dcfce7 !important; border: 2px dashed var(--success); } 
        .cell-stay { background: #f0fdf4; }
        .cell-pase { background: #f5f3ff; } /* Fondo ligeramante morado para pases */
        
        .tour-item { background: white; border-left: 4px solid var(--primary); padding: 4px; font-size: 0.7rem; margin-bottom: 3px; cursor: grab; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; font-weight: 500; white-space: normal; overflow: hidden; z-index: 5; display:flex; flex-direction:column; gap:1px;}
        .tour-obs-cal { font-size: 0.65rem; color: #2563eb; font-style: italic; line-height: 1; font-weight:bold; }
        .tour-obs-ops { font-size: 0.65rem; color: #d97706; font-style: italic; margin-top: 2px; border-top: 1px dashed #eee; padding-top: 2px; }
        
        .tour-item.locked { border-left-color: #f59e0b; background-color: #fffbeb; cursor: default; color: #92400e; box-shadow: none; border-left-width: 4px; }
        .tour-item.locked:hover { transform: none; box-shadow: none; }
        
        .tour-item.pase-style { border-left-color: var(--pase-color); } /* Borde morado para tour de pases */

        .obs-general-cal { margin-top: 5px; font-size: 0.7rem; color: #991b1b; background: #fee2e2; border: 1px solid #fecaca; padding: 3px 6px; border-radius: 4px; font-style: italic; }

        .pax-card { font-size: 0.85rem; display: flex; flex-direction: column; gap: 3px; }
        .pax-card.is-pase { border-left: 4px solid var(--pase-color); padding-left: 8px; } /* Indicador visual en tarjeta de pase */
        
        .pase-item { background: white; border-left: 4px solid var(--pase-color); padding: 4px; font-size: 0.75rem; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 0 4px 4px 0; font-weight: 600; color: var(--text-main); }

        /* OPERACIONES */
        .ops-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .ops-box { background: white; border: 1px solid var(--border); border-radius: 10px; padding: 15px; height: 60vh; overflow-y: auto; display: flex; flex-direction: column; }
        .ops-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .ops-header { font-weight: 800; color: var(--ops-color); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-add-ops { background: var(--success); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .btn-remove-ops { background: var(--danger); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .capacidad-indicator { font-size: 1.2rem; font-weight: bold; text-align: center; margin: 10px 0; padding: 10px; background: #e0f2fe; border-radius: 8px; color: #0369a1; }
        .capacidad-error { background: #fee2e2; color: #991b1b; }

        /* UTILIDADES */
        .money-cell { font-family: 'Courier New', monospace; font-weight: 700; color: var(--text-main); }
        .badge-debt { color: var(--danger); font-weight: 800; font-size: 0.8rem; background: white; padding: 2px 6px; border-radius: 4px; border: 1px solid var(--danger); }
        .badge-paid { color: var(--success); font-weight: 800; font-size: 0.8rem; background: #dcfce7; padding: 2px 6px; border-radius: 4px; border: 1px solid #86efac; }
        .badge-liq { background:#ecfdf5; color:#065f46; padding:2px 6px; border-radius:4px; font-size:0.75rem; border:1px solid #6ee7b7; display: inline-block; margin-top:2px; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column; }
        .kpi-title { font-size: 0.85rem; color: var(--text-sec); font-weight: 600; text-transform: uppercase; }
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin-top: 5px; }

        /* MODALES & FORMS */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 0; border-radius: 16px; width: 95%; max-width: 850px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column;}
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: white; position: sticky; top: 0; z-index: 10; }
        .modal-body { padding: 25px; background: #f8fafc; flex: 1; overflow-y: auto; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 0; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 0.9rem; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        
        .btn-icon { width: 28px; height: 28px; border-radius: 6px; border: none; cursor: pointer; display: inline-flex; justify-content: center; align-items: center; margin-left: 5px; }
        .btn-edit { background: #fff7ed; color: #d97706; } .btn-del { background: #fef2f2; color: #dc2626; }
        
        .catalog-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .catalog-col { background: var(--surface); border-radius: 12px; padding: 15px; border: 1px solid var(--border); max-height: 70vh; display: flex; flex-direction: column; }
        .item-list { overflow-y: auto; flex: 1; }
        /* NUEVO ESTILO ITEM CATALOGO */
        .cat-item { padding: 12px; border-bottom: 1px solid var(--border); font-size: 0.9rem; background:white; margin-bottom:5px; border-radius:8px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:flex-start;}
        .room-row { display: grid; grid-template-columns: 1.5fr 1fr 1fr 30px; gap: 8px; margin-bottom: 8px; align-items: center; }
        .type-selector { display: flex; background: #e0e7ff; padding: 5px; border-radius: 10px; margin-bottom: 20px; }
        .type-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4b5563; transition: 0.2s; display:flex; justify-content:center; align-items:center; gap:8px;}
        .type-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .room-list-container { background: #f9fafb; border: 1px solid var(--border); border-radius: 10px; padding: 10px; max-height: 250px; overflow-y: auto; }
        
        /* ESTILOS PARA LA NUEVA LISTA DE HABITACIONES */
        .added-room-item { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .added-room-info { display: flex; flex-direction: column; }
        .added-room-hotel { font-weight: 700; color: var(--primary); font-size: 0.75rem; text-transform: uppercase; }
        
        .tour-row-input { margin-bottom: 5px; background: white; padding: 5px; border-radius: 6px; border: 1px solid #eee; display: flex; gap: 5px; align-items: center;}
        
        .pro-section { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.02); }
        .pro-section-title { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; }
        .input-group { margin-bottom: 0; }
        .input-label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 4px; }
        .input-wrapper { position: relative; }
        .input-icon-left { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        .with-icon { padding-left: 35px; }
        .date-range-container { display: flex; gap: 10px; align-items: center; background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid var(--border); margin-top: 10px;}
        .date-separator { color: #9ca3af; font-size: 1.2rem; }
        .pay-toggle-container { display: flex; background: #e5e7eb; padding: 4px; border-radius: 8px; margin-bottom: 15px; }
        .pay-toggle-opt { flex: 1; text-align: center; padding: 8px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; font-weight: 600; color: #6b7280; transition: 0.2s; }
        .pay-toggle-opt.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .pay-toggle-opt.active-green { background: var(--money); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; justify-content:center; align-items:center; color: var(--primary); font-weight:800; font-size:1.5rem; flex-direction:column; gap:10px; }
        
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .btn-main:hover { background: var(--primary-dark); }

        @media print {
            @page { size: A4 portrait; margin: 1cm; }
            body * { visibility: hidden; } #printableArea, #printableArea * { visibility: visible; }
            #printableArea { position: absolute; left: 0; top: 0; width: 100%; height: 100%; padding: 0; background: white; color: black; font-family: 'Arial', sans-serif; }
            .print-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 11pt; }
            .print-table th, .print-table td { border: 1px solid #000; padding: 8px; text-align: left; vertical-align: middle; }
            .print-table th { background-color: #f0f0f0 !important; font-weight: bold; text-align: center; -webkit-print-color-adjust: exact; }
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            button, .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay" style="display:none;"></div>
    <div id="printableArea"></div>

    <div class="header-container">
        <div class="title-section"><h1>üöÄ SALIDAS</h1></div>
        <div class="main-controls">
            <div class="control-group-right">
                <input type="month" id="filtroMes" class="input-month-compact" onchange="actualizarTodo()">
                <button class="btn-reg-compact" onclick="abrirModalRegistro()">+ Nuevo</button>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button id="tabBtnLista" class="tab-btn active" onclick="cambiarVista('lista')">üìã Lista</button>
        <button id="tabBtnExcel" class="tab-btn" onclick="cambiarVista('excel')">üìÖ Calendario</button>
        <button id="tabBtnPases" class="tab-btn" onclick="cambiarVista('pases')" style="color:var(--pase-color);">üé´ Pases</button>
        <button id="tabBtnOps" class="tab-btn" onclick="cambiarVista('ops')" style="color:var(--ops-color);">üöç Operaciones</button>
        <button id="tabBtnLiquidacion" class="tab-btn" onclick="cambiarVista('liquidacion')" style="color:var(--report-color);">üìâ Liquidaci√≥n</button>
        <button id="tabBtnGastos" class="tab-btn" onclick="cambiarVista('gastos')" style="color:var(--expense-color);">üí∏ Gastos</button>
        <button id="tabBtnCatalogo" class="tab-btn" onclick="cambiarVista('catalogo')">üìö Cat√°logo</button>
        <button id="tabBtnControl" class="tab-btn" onclick="cambiarVista('control')">üí∞ Control</button>
    </div>

    <div id="vistaLista" class="view-section active">
        <div style="margin-bottom:20px;"><input type="text" id="buscadorLista" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:300px;" placeholder="üîç Buscar por nombre..." onkeyup="actualizarTodo()"></div>
        <div class="card"><table style="width:100%"><thead><tr><th>Pasajero</th><th>Hotel / Agencia</th><th>Pagos</th><th>Itinerario</th><th style="text-align:right">Acciones</th></tr></thead><tbody id="tbodyLista"></tbody></table></div>
    </div>

    <div id="vistaExcel" class="view-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <select id="filtroTourCalendario" style="padding:8px;border-radius:6px;border:1px solid #ccc;" onchange="actualizarTodo()"><option value="">-- Todos los Tours --</option></select>
            <div style="font-size:0.8rem; color:var(--text-sec);">Clic en d√≠a para ruta.</div>
        </div>
        <div class="excel-wrapper"><table class="excel-table" id="tablaExcel"></table></div>
    </div>

    <div id="vistaPases" class="view-section">
        <div style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
            <input type="text" id="buscadorPases" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:250px;" placeholder="üîç Buscar pase..." onkeyup="actualizarTodo()">
            <select id="filtroAgenciaPases" style="padding:10px; border:1px solid var(--border); border-radius:8px; width:200px;" onchange="actualizarTodo()"><option value="">-- Todas las Agencias --</option></select>
            <div style="flex:1;"></div>
            <button class="btn-main" onclick="abrirModalPases()" style="background:var(--pase-color);">+ Nuevo Pase</button>
        </div>
        <div class="excel-wrapper"><table class="excel-table" id="tablaPases"></table></div>
    </div>

    <div id="vistaOps" class="view-section">
        <div class="card" style="padding:20px; margin-bottom:20px; border-top: 4px solid var(--ops-color);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;"><h3 style="margin:0; color:var(--ops-color);">Gesti√≥n de Salidas (Despacho)</h3><button class="btn-sec" onclick="nuevaOperacion()">üîÑ Limpiar Formulario</button></div>
            <div class="form-grid" style="grid-template-columns:repeat(5, 1fr);">
                <div><label class="input-label">Fecha Salida</label><input type="date" id="ops_fecha" onchange="cargarPendientesOps()"></div>
                <div><label class="input-label">Tour</label><select id="ops_tour" onchange="cargarPendientesOps()"></select></div>
                <div><label class="input-label">Conductor</label><input type="text" id="ops_conductor" placeholder="Nombre Cond."></div>
                <div><label class="input-label">Gu√≠a</label><input type="text" id="ops_guia" placeholder="Nombre Gu√≠a"></div>
                <div><label class="input-label">Capacidad Veh√≠culo</label><input type="number" id="ops_capacidad" value="15" min="1" onchange="actualizarIndicadorCapacidad()"></div>
            </div>
            <input type="hidden" id="ops_id_actual"> <input type="hidden" id="ops_firestore_id">
            <div id="indicadorCapacidad" class="capacidad-indicator">0 / 15 Pasajeros</div>
            <div class="ops-container">
                <div class="ops-box"><div class="ops-header"><span>üë• Pendientes (Sin Asignar)</span><small id="count_pendientes">0</small></div><div id="lista_ops_pendientes" style="flex:1;"></div></div>
                <div class="ops-box" style="border-color:var(--ops-color); background:#f0f9ff;"><div class="ops-header"><span>üöç En el Veh√≠culo</span><small id="count_asignados">0</small></div><div id="lista_ops_asignados" style="flex:1;"></div></div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;"><button class="btn-main" onclick="guardarOperacion()" style="background:var(--ops-color);">üíæ Guardar Operaci√≥n</button><button class="btn-main" onclick="imprimirManifiesto()" style="background:#333;">üñ®Ô∏è Imprimir Manifiesto</button></div>
        </div>
        <h3 style="margin-top:30px;">Salidas Programadas</h3>
        <div class="card"><table style="width:100%"><thead><tr><th>Fecha</th><th>Tour</th><th>Conductor / Gu√≠a</th><th>Capacidad</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tbodyOps"></tbody></table></div>
    </div>

    <div id="vistaLiquidacion" class="view-section">
        <div class="card" style="padding:20px; border-top: 4px solid var(--report-color);">
            <h3 style="margin:0; margin-bottom:15px; color:var(--report-color);">Liquidaci√≥n de Agencias</h3>
            <div style="display:flex; gap:15px; align-items:flex-end; flex-wrap:wrap; background:#fdf2f8; padding:15px; border-radius:10px; border:1px solid #fbcfe8;">
                <div style="flex:1; min-width:200px;"><label class="input-label">Agencia</label><select id="liq_agencia" style="width:100%;"><option value="">Seleccione Agencia...</option></select></div>
                <div><label class="input-label">Desde</label><input type="date" id="liq_desde"></div>
                <div><label class="input-label">Hasta</label><input type="date" id="liq_hasta"></div>
                <div><label class="input-label">Ver</label><select id="liq_filtro_estado"><option value="pendientes">Pendientes (Por Cobrar)</option><option value="todos">Todo el Historial</option><option value="liquidados">Solo Pagados</option></select></div>
                <button class="btn-main" style="background:var(--report-color);" onclick="generarLiquidacion()">üìä Generar</button>
            </div>
            <div id="resultadosLiquidacion" style="margin-top:20px; display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><button class="btn-main" style="background:#059669;" onclick="liquidarRegistros()">‚úÖ Marcar como Pagado</button><button class="btn-sec" onclick="imprimirLiquidacion()">üñ®Ô∏è Imprimir Liquidaci√≥n</button></div>
                <div id="tablaLiqContainer"></div>
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-top:20px;">
                    <div style="padding:15px; background:#f3f4f6; border-radius:8px; text-align:center;"><small>Total Ventas</small><div id="liq_total_venta" style="font-weight:bold; font-size:1.2rem;">S/ 0.00</div></div>
                    <div style="padding:15px; background:#ecfdf5; border-radius:8px; text-align:center; color:#047857;"><small>Total Adelantos</small><div id="liq_total_adelanto" style="font-weight:bold; font-size:1.2rem;">S/ 0.00</div></div>
                    <div style="padding:15px; background:#fef2f2; border-radius:8px; text-align:center; color:#dc2626; border:2px solid #dc2626;"><small>Saldo a Pagar (Deuda)</small><div id="liq_total_deuda" style="font-weight:bold; font-size:1.5rem;">S/ 0.00</div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="vistaGastos" class="view-section">
        <div class="card" style="padding:20px; border-top: 4px solid var(--expense-color);">
            <h3 style="margin:0; margin-bottom:15px; color:var(--expense-color);">Registro de Gastos Operativos</h3>
            <form id="formGasto" style="display:flex; gap:10px; align-items:flex-end; background:#fff1f2; padding:15px; border-radius:10px; margin-bottom:20px; flex-wrap:wrap;">
                <input type="hidden" id="g_firestore_id">
                <div><label class="input-label">Fecha</label><input type="date" id="g_fecha" required></div>
                <div style="flex:2;"><label class="input-label">Descripci√≥n</label><input type="text" id="g_desc" placeholder="Ej. Gasolina..." required></div>
                <div><label class="input-label">Monto (S/)</label><input type="number" id="g_monto" placeholder="0.00" step="0.01" required></div>
                <div style="flex:1;"><label class="input-label">Responsable</label><input type="text" id="g_resp" placeholder="Qui√©n gast√≥"></div>
                <button type="submit" id="btnGuardarGasto" class="btn-main" style="background:var(--expense-color);">+ Agregar</button>
                <button type="button" id="btnCancelGasto" onclick="limpiarGastoForm()" style="display:none; background:#ccc; color:#333; padding:10px; border:none; border-radius:6px; cursor:pointer;">Cancelar</button>
            </form>
            <h4 style="margin-bottom:10px;">Gastos del Mes</h4>
            <table style="width:100%"><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Responsable</th><th>Monto</th><th>Acci√≥n</th></tr></thead><tbody id="tbodyGastos"></tbody><tfoot><tr style="background:#f9fafb; font-weight:bold;"><td colspan="3" style="text-align:right;">TOTAL GASTOS:</td><td id="totalGastosDisplay" style="color:var(--expense-color);">S/ 0.00</td><td></td></tr></tfoot></table>
        </div>
    </div>

    <div id="vistaCatalogo" class="view-section">
        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <input type="text" id="buscadorCatalogo" style="padding:10px; border:1px solid var(--border); border-radius:8px; flex:1;" placeholder="üîç Buscar..." onkeyup="renderizarCatalogos()">
            <button class="btn-main" onclick="abrirModalCatalogo()">+ Nuevo Item</button>
        </div>
        <div class="catalog-grid">
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üè® HOTELES</div><div id="cat_hoteles" class="item-list"></div></div>
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üó∫Ô∏è TOURS</div><div id="cat_tours" class="item-list"></div></div>
            <div class="catalog-col"><div style="font-weight:800;margin-bottom:10px;">üè¢ AGENCIAS</div><div id="cat_agencias" class="item-list"></div></div>
        </div>
    </div>

    <div id="vistaControl" class="view-section">
        <div class="dashboard-grid">
            <div class="kpi-card">
                <span class="kpi-title">Ventas Totales</span>
                <span id="kpi_ventas" class="kpi-value" style="color:var(--primary);">S/ 0.00</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-title">Ganancia Estimada</span>
                <span id="kpi_ganancia" class="kpi-value" style="color:var(--money);">S/ 0.00</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-title">Por Cobrar</span>
                <span id="kpi_cobrar" class="kpi-value" style="color:var(--danger);">S/ 0.00</span>
            </div>
        </div>

        <div class="card">
            <table style="width:100%">
                <thead><tr><th>Pasajero</th><th>Detalle</th><th>Venta</th><th>Adelanto</th><th>Saldo</th><th>Costo Op.</th><th>Ganancia</th><th>Estado</th><th>Acciones</th></tr></thead>
                <tbody id="tbodyControl"></tbody>
            </table>
        </div>
    </div>

    <div class="modal" id="modalRegistro">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modalRegTitulo" style="margin:0;color:var(--primary);">üìù Registro</h2><button onclick="cerrarModal('modalRegistro')" style="border:none;background:none;font-size:1.8rem;cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                <form id="formTour">
                    <input type="hidden" id="reg_firestore_id">
                    
                    <div class="pro-section">
                        <div class="pro-section-title">üë§ Datos del Cliente</div>
                        <div class="form-grid" style="grid-template-columns: 2fr 1fr 1.5fr 0.5fr;">
                            <div class="input-group"><label class="input-label">Nombres</label><div class="input-wrapper"><span class="input-icon-left">üë§</span><input type="text" id="nombre" required class="with-icon"></div></div>
                            <div class="input-group"><label class="input-label">Celular</label><div class="input-wrapper"><span class="input-icon-left">üì±</span><input type="tel" id="celular" required class="with-icon"></div></div>
                            <div class="input-group"><label class="input-label">Agencia</label><select id="selAgencia" required></select></div>
                            <div class="input-group"><label class="input-label">Pax</label><input type="number" id="cantidad" min="1" required style="text-align:center;"></div>
                        </div>
                        
                        <div style="margin-top:10px;">
                            <label class="input-label">Fechas de Estad√≠a</label>
                            <div class="date-range-container">
                                <div style="flex:1;">
                                    <label style="font-size:0.7rem;">LLEGADA</label>
                                    <input type="date" id="llegada" required onchange="validarFechas()" style="border:none; background:transparent;">
                                </div>
                                <div class="date-separator">‚ûù</div>
                                <div style="flex:1; text-align:right;">
                                    <label style="font-size:0.7rem;">SALIDA</label>
                                    <input type="date" id="retorno" required onchange="validarFechas()" style="border:none; text-align:right; background:transparent;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="pro-section">
                        <div class="pro-section-title">üè® Alojamiento (Habitaciones)</div>
                        <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px dashed #bae6fd; margin-bottom: 10px;">
                            <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap: wrap;">
                                <div style="flex:1.5; min-width: 200px;">
                                    <label class="input-label">1. Seleccionar Hotel</label>
                                    <select id="selHotelAdd" onchange="actualizarSelectRoom()"></select>
                                </div>
                                <div style="flex:1; min-width: 150px;">
                                    <label class="input-label">2. Habitaci√≥n</label>
                                    <select id="selRoomAdd"></select>
                                </div>
                                <div style="width: 80px;">
                                    <label class="input-label">3. Noches</label>
                                    <input type="number" id="txtNochesAdd" value="1" min="1" style="text-align:center;">
                                </div>
                                <button type="button" class="btn-main" onclick="agregarHabitacion()" style="padding: 10px 15px;">+ Agregar</button>
                            </div>
                        </div>
                        <div id="listaHabitacionesAgregadas"></div>
                    </div>

                    <div class="pro-section"><div class="pro-section-title">üí∞ Detalles</div><div class="form-grid" style="grid-template-columns: 1fr 1fr 2fr;"><div class="input-group"><label class="input-label">Precio Total</label><div class="input-wrapper"><span class="input-icon-left">S/</span><input type="number" id="precioPaquete" required class="with-icon" style="font-weight:bold;"></div></div><div class="input-group"><label class="input-label">Adelanto</label><div class="input-wrapper"><span class="input-icon-left">S/</span><input type="number" id="adelanto" required class="with-icon"></div></div><div class="input-group"><label class="input-label">Observaciones</label><input type="text" id="observaciones" style="width:100%;"></div></div></div>
                    
                    <div class="pro-section" style="background:#f8fafc;">
                        <div class="pro-section-title" style="justify-content:space-between;">
                            <span>üó∫Ô∏è Itinerario</span>
                            <div style="display:flex; gap:5px;">
                                <button type="button" onclick="agregarLineaItinerario('tour')" class="btn-main" style="padding:4px 10px; height:auto; background:var(--primary);">+ Tour</button>
                                <button type="button" onclick="agregarLineaItinerario('nota')" class="btn-main" style="padding:4px 10px; height:auto; background:#f59e0b;">+ Nota</button>
                            </div>
                        </div>
                        <div id="listaToursInputs"></div>
                    </div>
                    
                    <button type="submit" class="btn-main" style="width:100%; justify-content:center; padding:15px; margin-top:10px;">üíæ Guardar Registro</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="modalPases">
        <div class="modal-content" style="max-width:650px;">
            <div class="modal-header"><h2 id="modalPasesTitulo" style="margin:0;color:var(--pase-color);">üé´ Nuevo Pase</h2><button onclick="cerrarModal('modalPases')" style="border:none;background:none;font-size:1.8rem;cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                <form id="formPase">
                    <input type="hidden" id="pase_firestore_id">
                    <div class="pro-section"><div class="pro-section-title">Datos del Pasajero</div><div class="form-grid" style="grid-template-columns: 2fr 1fr 1.5fr;"><div class="input-group"><label class="input-label">Nombres</label><input type="text" id="p_nombre" required></div><div class="input-group"><label class="input-label">Celular</label><input type="tel" id="p_celular" required></div><div class="input-group"><label class="input-label">Agencia</label><select id="p_agencia" required></select></div></div></div>
                    <div class="pro-section"><div class="pro-section-title">Servicio</div><div class="form-grid" style="grid-template-columns:1fr 1.5fr 0.5fr;"><div class="input-group"><label class="input-label">Fecha</label><input type="date" id="p_fecha" required></div><div class="input-group"><label class="input-label">Tour</label><select id="p_tour" required onchange="calcPaseAuto()"></select></div><div class="input-group"><label class="input-label">Pax</label><input type="number" id="p_cantidad" min="1" required onchange="calcPaseAuto()"></div></div><div class="input-group" style="margin-top:10px;"><label class="input-label">Recojo</label><select id="p_hotel" required></select></div><div class="input-group" style="margin-top:10px;"><label class="input-label">Observaciones</label><input type="text" id="p_obs"></div></div>
                    <div class="pro-section"><div class="pro-section-title">Pago</div><div class="pay-toggle-container"><div class="pay-toggle-opt active" id="opt_adelanto" onclick="setPasePagoMode('adelanto')">A Cuenta</div><div class="pay-toggle-opt" id="opt_pagado" onclick="setPasePagoMode('pagado')">Pagado</div></div><input type="hidden" id="p_modo_pago" value="adelanto"><div class="form-grid" style="grid-template-columns: 1fr 1fr;"><div class="input-group"><label class="input-label">Total</label><input type="number" id="p_precio" required step="0.01" onchange="syncPasePago()"></div><div class="input-group"><label class="input-label">Abonado</label><input type="number" id="p_adelanto" required step="0.01"></div></div></div>
                    <button type="submit" class="btn-main" style="width:100%; justify-content:center; padding:12px;">Guardar Pase</button>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="modalCatalogo"><div class="modal-content" style="max-width:600px;"><div class="modal-header"><h2 style="margin:0;color:var(--primary);">üìö Cat√°logo</h2><button onclick="cerrarModal('modalCatalogo')" style="border:none;background:none;font-size:1.5rem;">&times;</button></div><div class="modal-body"><div class="type-selector"><button id="typeBtnHotel" class="type-btn active" onclick="cambiarTipoCat('hotel')">üè® Hotel</button><button id="typeBtnTour" class="type-btn" onclick="cambiarTipoCat('tour')">üó∫Ô∏è Tour</button><button id="typeBtnAgencia" class="type-btn" onclick="cambiarTipoCat('agencia')">üè¢ Agencia</button></div><form id="formCatalogo"><input type="hidden" id="cat_edit_id"><input type="hidden" id="cat_edit_old_name"><input type="hidden" id="cat_tipo_actual" value="hotel"><div class="pro-section"><div class="input-group"><label class="input-label">Nombre</label><input type="text" id="cat_nombre" required style="font-weight:bold; font-size:1rem;"></div></div><div id="fields_tour" style="display:none;" class="pro-section"><div class="input-group"><label class="input-label">Precio Costo</label><div class="input-wrapper"><span class="input-icon-left">S/</span><input type="number" id="cat_precio_tour" class="with-icon"></div></div></div><div id="fields_hotel" class="pro-section"><div class="pro-section-title" style="justify-content:space-between;"><span>üõèÔ∏è Habitaciones</span><button type="button" onclick="agregarFilaHabitacion()" style="font-size:0.8rem;color:var(--primary);background:none;border:none;cursor:pointer;">+ Agregar</button></div><div class="room-list-container"><div style="display:grid;grid-template-columns:1.5fr 1fr 1fr 30px;gap:8px;padding:5px;font-size:0.75rem;font-weight:bold;"><span>Nombre</span><span>Cap</span><span>Precio</span><span></span></div><div id="room_list"></div></div></div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;"><button type="submit" class="btn-main">Guardar</button></div></form></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB7R-NO45QoBSdHWS4Q2BK7tqmjYCMyDEk",
          authDomain: "sistemasalidas-92d4b.firebaseapp.com",
          projectId: "sistemasalidas-92d4b",
          storageBucket: "sistemasalidas-92d4b.firebasestorage.app",
          messagingSenderId: "679142301697",
          appId: "1:679142301697:web:4357eca0d8915ebcd66000"
        };

        let app, dbFirestore;

        try {
            app = initializeApp(firebaseConfig);
            dbFirestore = getFirestore(app);
            enableIndexedDbPersistence(dbFirestore).catch((err) => { console.log('Persistencia no disp.'); });
        } catch (error) {
            console.error("Error cr√≠tico de conexi√≥n: " + error.message);
        }

        window.db = []; window.dbPases = []; window.dbOps = []; window.dbGastos = []; 
        window.catalogo = { hoteles: [], tours: [], agencias: [] };
        window.editId = null; window.dragData = null; window.opsTempAsignados = []; window.liquidacionData = [];
        window.tempHabitaciones = []; 

        function initRealTime() {
            try {
                onSnapshot(collection(dbFirestore, "registros"), (snapshot) => {
                    window.db = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                    window.actualizarTodo();
                });
                onSnapshot(collection(dbFirestore, "pases"), (snapshot) => {
                    window.dbPases = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                    window.actualizarTodo();
                });
                onSnapshot(collection(dbFirestore, "operaciones"), (snapshot) => {
                    window.dbOps = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                    window.actualizarTodo();
                });
                onSnapshot(collection(dbFirestore, "gastos"), (snapshot) => {
                    window.dbGastos = snapshot.docs.map(d => ({ ...d.data(), firestoreId: d.id }));
                    window.actualizarTodo();
                });
                onSnapshot(doc(dbFirestore, "config", "catalogo"), (docSnap) => {
                    if (docSnap.exists()) window.catalogo = docSnap.data();
                    else setDoc(doc(dbFirestore, "config", "catalogo"), { hoteles: [], tours: [], agencias: [] });
                    window.actualizarTodo();
                    window.renderizarCatalogos();
                });
            } catch(e) {
                console.error(e);
            }
        }

        initRealTime();

        window.guardarRegistroEnNube = async (data) => {
            const fid = document.getElementById('reg_firestore_id').value;
            try { if (fid) await updateDoc(doc(dbFirestore, "registros", fid), data); else await addDoc(collection(dbFirestore, "registros"), data); window.cerrarModal('modalRegistro'); } catch (e) { alert("Error: " + e.message); }
        };
        window.guardarPaseEnNube = async (data) => {
            const fid = document.getElementById('pase_firestore_id').value;
            try { if (fid) await updateDoc(doc(dbFirestore, "pases", fid), data); else await addDoc(collection(dbFirestore, "pases"), data); window.cerrarModal('modalPases'); } catch (e) { alert("Error: " + e.message); }
        };
        window.guardarOperacionEnNube = async (data) => {
            const fid = document.getElementById('ops_firestore_id').value;
            try { if (fid) await updateDoc(doc(dbFirestore, "operaciones", fid), data); else await addDoc(collection(dbFirestore, "operaciones"), data); window.nuevaOperacion(); window.cambiarVista('ops'); } catch (e) { alert("Error: " + e.message); }
        };
        
        window.guardarGastoEnNube = async (data) => { 
            const fid = document.getElementById('g_firestore_id').value;
            try { 
                if(fid) {
                    await updateDoc(doc(dbFirestore, "gastos", fid), data); 
                } else {
                    await addDoc(collection(dbFirestore, "gastos"), data); 
                }
                window.limpiarGastoForm();
            } catch(e){ alert(e); } 
        };
        
        window.eliminarDocEnNube = async (coll, fid) => { if(confirm("¬øBorrar?")) try { await deleteDoc(doc(dbFirestore, coll, fid)); } catch(e){ alert(e); } };
        window.guardarCatalogoEnNube = async () => { try { await setDoc(doc(dbFirestore, "config", "catalogo"), window.catalogo); } catch(e){ alert(e); } };
        window.liquidarEnNube = async (listaData) => {
            if(!confirm("¬øMarcar PAGADOS?")) return;
            const promesas = [];
            listaData.forEach(row => {
                if(!row.liq) {
                    if(row.tipo === 'db') { const item = window.db.find(x => x.id === row.id); if(item && item.firestoreId) promesas.push(updateDoc(doc(dbFirestore, "registros", item.firestoreId), { liquidado: true })); }
                    else { const item = window.dbPases.find(x => x.id === row.id); if(item && item.firestoreId) promesas.push(updateDoc(doc(dbFirestore, "pases", item.firestoreId), { liquidado: true })); }
                }
            });
            if(promesas.length > 0) { await Promise.all(promesas); alert("Actualizado."); window.generarLiquidacion(); } else { alert("Nada pendiente."); }
        };
        window.toggleLiquidadoEnNube = async (fid, collectionName, currentState) => {
            try { await updateDoc(doc(dbFirestore, collectionName, fid), { liquidado: !currentState }); } catch(e) { alert("Error al cambiar estado"); }
        }

        // Global functions to be accessible from HTML
        window.cerrarModal = (id) => document.getElementById(id).classList.remove('active');
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>

    <script>
        window.onload = () => { document.getElementById('filtroMes').value = new Date().toISOString().slice(0, 7); cambiarVista('lista'); };
        const fmtMoneda = (v) => new Intl.NumberFormat('es-PE', { style: 'currency', currency: 'PEN' }).format(v);
        function calcularFechaTour(fechaBase, diasSumar) { const parts = fechaBase.split('-'); const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0); date.setDate(date.getDate() + parseInt(diasSumar)); const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
        function cambiarVista(vista) { document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active')); document.getElementById('vista' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active'); document.getElementById('tabBtn' + vista.charAt(0).toUpperCase() + vista.slice(1)).classList.add('active'); if(vista === 'ops') { cargarSelectOps(); nuevaOperacion(); renderListaOps(); } if(vista === 'liquidacion') { cargarSelectLiquidacion(); } if(vista === 'gastos') { document.getElementById('g_fecha').value = new Date().toISOString().split('T')[0]; renderGastos(); } }
        
        function obtenerOpcionesFechas(selectedIdx = -1) {
            const f1 = document.getElementById('llegada').value;
            const f2 = document.getElementById('retorno').value;
            if(!f1 || !f2) {
                let h = '';
                for(let i=0; i<=20; i++) h+=`<option value="${i}" ${i==selectedIdx?'selected':''}>D√≠a ${i+1}</option>`;
                return h;
            }

            const d1 = new Date(f1);
            const d2 = new Date(f2);
            d1.setMinutes(d1.getMinutes() + d1.getTimezoneOffset());
            d2.setMinutes(d2.getMinutes() + d2.getTimezoneOffset());

            let html = '';
            let current = new Date(d1);
            let idx = 0;

            while(current <= d2) {
                const y = current.getFullYear();
                const m = String(current.getMonth()+1).padStart(2,'0');
                const d = String(current.getDate()).padStart(2,'0');
                const fechaStr = `${y}-${m}-${d}`;

                const isSelected = (idx === parseInt(selectedIdx)) ? 'selected' : '';
                html += `<option value="${idx}" ${isSelected}>${fechaStr} (D√≠a ${idx+1})</option>`;

                current.setDate(current.getDate() + 1);
                idx++;
            }
            return html;
        }

        window.validarFechas = function() {
            const l = document.getElementById('llegada').value;
            const r = document.getElementById('retorno').value;
            if(l && r && l > r) {
                alert("Error: Retorno antes de llegada");
                document.getElementById('retorno').value = '';
                return;
            }
            actualizarSelectoresItinerario();
        }

        window.actualizarSelectoresItinerario = function() {
            document.querySelectorAll('.sel-dia').forEach(sel => {
                const currVal = sel.value;
                sel.innerHTML = obtenerOpcionesFechas(currVal);
            });
        }

        function actualizarTodo() {
            const txt = document.getElementById('buscadorLista').value.toLowerCase(); const mes = document.getElementById('filtroMes').value;
            renderLista(window.db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes)) && (r.nombre.toLowerCase().includes(txt))));
            renderPases(mes); renderGastos(); renderListaOps();
            const ft = document.getElementById('filtroTourCalendario'); if(ft.options.length<=1 && window.catalogo.tours) ft.innerHTML='<option value="">-- Todos --</option>'+[...new Set(window.catalogo.tours.map(t=>t.nombre))].map(t=>`<option value="${t}">${t}</option>`).join('');
            const fa = document.getElementById('filtroAgenciaPases'); if(fa.options.length<=1 && window.catalogo.agencias) fa.innerHTML = '<option value="">-- Todas --</option>' + window.catalogo.agencias.map(a => `<option value="${a.nombre}">${a.nombre}</option>`).join('');
            renderExcel(window.db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes))), mes, ft.value);
            renderControl(window.db.filter(r => (r.llegada.startsWith(mes)||r.retorno.startsWith(mes))));
        }
        
        function renderLista(data) {
            const tbody = document.getElementById('tbodyLista');
            tbody.innerHTML = '';
            
            const renderedIds = new Set();
            const html = data.map(r => {
                if(renderedIds.has(r.id)) return '';
                renderedIds.add(r.id);

                const v = parseFloat(r.precioPaquete)||0;
                const a = parseFloat(r.adelanto)||0;
                const s = v-a;
                let statusBadge = (s<=0 && v>0) ? `<span class="badge-paid">¬°PAGADO!</span>` : (s>0 && a>0) ? `<span class="badge-debt" style="color:#b45309; border-color:#b45309;">Falta ${fmtMoneda(s)}</span>` : `<span class="badge-debt">Falta ${fmtMoneda(s)}</span>`;
                const rowClass = (s<=0 && v>0) ? 'row-ok' : (s>0 && a>0) ? 'row-partial' : 'row-debt';
                const obs = r.observaciones ? `<div class="obs-box">‚ö†Ô∏è ${r.observaciones}</div>` : '';
                
                let habsDisplay = '';
                if(Array.isArray(r.habitaciones)) {
                    if(r.habitaciones.length > 0 && typeof r.habitaciones[0] === 'object') {
                         // Mostrar noches en la lista
                         habsDisplay = r.habitaciones.map(h => `${h.habitacion} (${h.hotel}) - ${h.noches || 1}N`).join(', ');
                    } else {
                        habsDisplay = r.habitaciones.join(', '); 
                    }
                } else {
                    habsDisplay = r.habitaciones; 
                }

                const liq = r.liquidado ? `<span class="badge-liq">Liq.</span>` : '';
                
                return `<tr class="${rowClass}">
                    <td style="border-left-width: 4px;">
                        <div style="font-weight:bold; font-size:1rem;">${r.nombre} ${liq}</div>
                        <div style="font-size:0.8rem;color:#666;">üì± ${r.celular} | Pax: ${r.cantidad}</div>
                        ${obs}
                    </td>
                    <td>
                        <div style="font-weight:600;">üè® ${r.hotelName}</div>
                        <div style="font-size:0.8rem;color:#666;">üõèÔ∏è ${habsDisplay}</div>
                        <div style="font-size:0.8rem;">üè¢ ${r.agencia}</div>
                    </td>
                    <td>
                        ${statusBadge}<br><small>Venta: ${fmtMoneda(v)}</small>
                    </td>
                    <td>
                        <div style="display:flex;flex-wrap:wrap;">
                            ${r.tours.map(t=>`<span class="tag-tour" title="${t.obsTour||t.obs||''}">üìÖ ${t.fecha.split('-')[2]}: ${t.nombre || t.obsDia}</span>`).join('')}
                        </div>
                    </td>
                    <td style="text-align:right;">
                        <button class="btn-icon btn-edit" onclick="cargarEdicion(${r.id})">‚úé</button>
                        <button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('registros', '${r.firestoreId}')">üóë</button>
                    </td>
                </tr>`;
            }).join('');
            
            tbody.innerHTML = html;
        }

        function renderPases(mes) {
            const [y,m] = mes.split('-'); const days = new Date(y, m, 0).getDate(); let h = '<thead><tr><th class="col-sticky">Detalle Pase</th>'; for(let i=1; i<=days; i++) h += `<th style="text-align:center;">${i}</th>`; h+='</tr></thead><tbody>';
            let pasesMes = window.dbPases.filter(p => p.fecha.startsWith(mes)); const txt = document.getElementById('buscadorPases').value.toLowerCase(); const fAgencia = document.getElementById('filtroAgenciaPases').value; pasesMes = pasesMes.filter(p => p.nombre.toLowerCase().includes(txt) && (fAgencia==="" || p.agencia===fAgencia));
            pasesMes.forEach(p => { const v = parseFloat(p.precio)||0; const a = parseFloat(p.adelanto)||0; const s = v-a; let statusBadge = (s<=0 && v>0) ? `<br><span class="badge-paid">¬°PAGADO!</span>` : `<br><span class="badge-debt">Falta ${fmtMoneda(s)}</span>`; const liq = p.liquidado ? `<span class="badge-liq">Liq.</span>` : ''; const obsDisplay = p.observacion ? `<div style="font-size:0.7rem;color:#d97706;background:#fff7ed;padding:2px;">‚ö†Ô∏è ${p.observacion}</div>` : ''; h += `<tr><td class="col-sticky"><div class="pax-card"><div style="color:var(--pase-color);font-weight:bold;">${p.nombre} ${liq}</div><div>üì± ${p.celular} (${p.cantidad} Pax)</div><div>üè® ${p.hotel}</div><div>üè¢ ${p.agencia}</div>${statusBadge}${obsDisplay}<div style="margin-top:5px;"><button class="btn-icon btn-edit" onclick="editarPase(${p.id})">‚úé</button><button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('pases', '${p.firestoreId}')">üóë</button></div></div></td>`; for(let d=1; d<=days; d++) { const f = `${y}-${m}-${String(d).padStart(2,'0')}`; h += (p.fecha === f) ? `<td><div class="pase-item">${p.tour}</div></td>` : `<td></td>`; } h += '</tr>'; });
            document.getElementById('tablaPases').innerHTML = h + '</tbody>';
        }
        
        function renderExcel(data, mes, filtroTour) {
            // UNIFICAR REGISTROS (DB) Y PASES (DBPASES) PARA EL CALENDARIO
            let allItems = [...data]; // Copia de registros
            
            // Transformar Pases al formato de calendario y agregar
            window.dbPases.forEach(p => {
                if(p.fecha.startsWith(mes)) {
                    // Verificar filtros de lista (opcional, pero consistente con vista)
                    const txt = document.getElementById('buscadorLista').value.toLowerCase();
                    if(p.nombre.toLowerCase().includes(txt)) {
                        allItems.push({
                            id: p.id,
                            firestoreId: p.firestoreId,
                            isPase: true, // Marcador para identificar
                            nombre: p.nombre,
                            llegada: p.fecha,
                            retorno: p.fecha, // 1 dia
                            cantidad: p.cantidad,
                            celular: p.celular,
                            hotelName: p.hotel, // Hotel es recojo
                            agencia: p.agencia,
                            observaciones: p.observacion,
                            tours: [{
                                nombre: p.tour,
                                fecha: p.fecha,
                                obsTour: p.observacion
                            }],
                            habitaciones: [] // Sin habitaciones
                        });
                    }
                }
            });

            // ORDENAMIENTO ESCALONADO POR FECHA DE LLEGADA
            allItems.sort((a, b) => {
                if (a.llegada < b.llegada) return -1;
                if (a.llegada > b.llegada) return 1;
                return 0;
            });

            const [y,m] = mes.split('-'); const days = new Date(y, m, 0).getDate();
            let h = '<thead><tr><th class="col-sticky">Detalle Cliente</th>';
            for(let i=1; i<=days; i++) h += `<th class="day-header" onclick="abrirResumenDia(${i})">${i}</th>`;
            h+='</tr></thead><tbody>';
            
            allItems.forEach(r => {
                let habs = '';
                if(Array.isArray(r.habitaciones)) {
                     if(r.habitaciones.length > 0 && typeof r.habitaciones[0] === 'object') habs = r.habitaciones.map(x=>x.habitacion).join(', ');
                     else habs = r.habitaciones.join(', ');
                } else habs = r.habitaciones;

                const obsGeneral = r.observaciones ? `<div class="obs-general-cal">‚ö†Ô∏è ${r.observaciones}</div>` : '';
                
                // Estilo diferente si es Pase
                const paseClass = r.isPase ? 'is-pase' : '';
                const paseBadge = r.isPase ? '<span style="background:var(--pase-color);color:white;padding:1px 4px;border-radius:4px;font-size:0.6rem;margin-right:4px;">[PASE]</span>' : '';
                const editFunc = r.isPase ? `editarPase(${r.id})` : `cargarEdicion(${r.id})`; // Correct edit function

                h+=`<tr data-pax="${r.id}" data-type="${r.isPase?'pase':'db'}"><td class="col-sticky" ondblclick="${editFunc}"><div class="pax-card ${paseClass}"><div class="pax-header">${paseBadge}<span>${r.nombre}</span><span style="background:#eee;padding:1px 5px;border-radius:4px;color:#333;font-size:0.7rem;">${r.cantidad}</span></div><div style="font-size:0.75rem;color:#666;">üì± ${r.celular}</div><div style="font-size:0.75rem;color:#666;">üè® ${r.hotelName}</div><div style="font-size:0.7rem;color:var(--primary);">${habs}</div>${obsGeneral}<div class="pax-detail">üè¢ ${r.agencia}</div></div></td>`;
                
                for(let d=1; d<=days; d++) {
                    const f = `${y}-${m}-${String(d).padStart(2,'0')}`;
                    // Fondo solo si es registro completo (estadia)
                    const bg = (!r.isPase && f >= r.llegada && f <= r.retorno) ? 'cell-stay' : (r.isPase && f === r.llegada) ? 'cell-pase' : '';
                    
                    let ts = r.tours.filter(t=>t.fecha===f); if(filtroTour) ts = ts.filter(t=>t.nombre===filtroTour);
                    
                    h+=`<td class="drop-zone ${bg}" data-dia="${d}" ondragover="window.allowDrop(event)" ondrop="window.dropTour(event)">
                        <div class="tour-stack">
                            ${ts.map(t=>{
                                if(!t.nombre) {
                                    return `<div class="tour-item locked" draggable="false">
                                        <div class="tour-name" style="font-weight:normal; font-style:italic;">üìå ${t.obsDia}</div>
                                    </div>`;
                                }
                                
                                const obsDiaHtml = t.obsDia ? `<div class="tour-obs-cal">üìÖ ${t.obsDia}</div>` : '';
                                const obsTourHtml = (t.obsTour || t.obs) ? `<div class="tour-obs-ops">üìù ${t.obsTour || t.obs}</div>` : '';
                                const paseStyle = r.isPase ? 'pase-style' : '';

                                return `<div class="tour-item ${paseStyle}" title="${t.nombre}" draggable="true" ondragstart="window.dragStart(event,${r.id},${r.tours.indexOf(t)})">
                                    <div class="tour-name">${t.nombre}</div>
                                    ${obsTourHtml}
                                    ${obsDiaHtml}
                                </div>`;
                            }).join('')}
                        </div>
                    </td>`;
                }
                h+='</tr>';
            });
            document.getElementById('tablaExcel').innerHTML = h+'</tbody>';
        }

        window.dragStart = (ev,pid,tid) => { window.dragData={pid,tid}; ev.dataTransfer.effectAllowed="move"; };
        window.allowDrop = (ev) => { ev.preventDefault(); ev.target.closest('td')?.classList.add('drag-over'); };
        document.addEventListener('dragleave',e=>e.target.closest('td')?.classList.remove('drag-over'));
        window.dropTour = (ev) => {
            ev.preventDefault(); 
            const c=ev.target.closest('td'); 
            document.querySelectorAll('.drop-zone').forEach(x=>x.classList.remove('drag-over')); 
            if(!c||!window.dragData)return;
            
            const pid=parseInt(c.parentElement.getAttribute('data-pax')); 
            const type=c.parentElement.getAttribute('data-type'); // 'db' or 'pase'
            const dia=parseInt(c.getAttribute('data-dia'));
            const f=document.getElementById('filtroMes').value+'-'+String(dia).padStart(2,'0');
            
            if(pid!==window.dragData.pid) return alert("Solo mover mismo pasajero");
            
            if(type === 'pase') {
                // LOGICA PARA MOVER PASE DE FECHA
                const p = window.dbPases.find(x=>x.id===pid);
                if(p) {
                    p.fecha = f; // Actualizar fecha del pase
                    document.getElementById('pase_firestore_id').value = p.firestoreId;
                    window.guardarPaseEnNube(p);
                }
            } else {
                // LOGICA PARA MOVER TOUR DE REGISTRO
                const p = window.db.find(x=>x.id===pid);
                if(f<p.llegada || f>p.retorno) return alert("Fecha fuera de estad√≠a");
                p.tours[window.dragData.tid].fecha=f;
                document.getElementById('reg_firestore_id').value = p.firestoreId; 
                window.guardarRegistroEnNube(p);
            }
        };

        function renderControl(data) { 
            let html = '';
            let totalVenta = 0, totalGanancia = 0;
            let countPagado = 0, countPendiente = 0;
            let montoCobrar = 0;

            const processRecord = (r, type) => {
                const dur = Math.ceil((new Date(r.retorno)-new Date(r.llegada))/86400000);
                
                let costoHosp = 0;
                let hotelDisplayName = r.hotelName;

                if(type === 'db') {
                    if(Array.isArray(r.habitaciones)) {
                        r.habitaciones.forEach(ht => { 
                            if(typeof ht === 'object') {
                                // NUEVA LOGICA DE COSTOS: PRECIO * NOCHES
                                if(ht.noches) {
                                    costoHosp += (parseFloat(ht.precio) || 0) * parseInt(ht.noches);
                                } else {
                                    // Fallback si no tiene noches (registros antiguos)
                                    costoHosp += (parseFloat(ht.precio) || 0) * (dur > 0 ? dur : 1);
                                }
                            } else {
                                // Viejo formato
                                const hd = window.catalogo.hoteles.find(h=>h.nombre===r.hotelName && h.habitaciones.some(rom=>rom.habitacion===ht)); 
                                let romPrice = 0;
                                if(hd) {
                                    const specificRoom = hd.habitaciones.find(rom=>rom.habitacion===ht);
                                    if(specificRoom) romPrice = parseFloat(specificRoom.precio);
                                }
                                costoHosp += romPrice * (dur > 0 ? dur : 1); 
                            }
                        });
                    }
                } else {
                    hotelDisplayName = r.hotel;
                }
                
                let costoTours = 0;
                if (type === 'db') {
                    r.tours.forEach(t => { 
                        const td = window.catalogo.tours.find(x=>x.nombre===t.nombre); 
                        costoTours += (td ? parseFloat(td.precio) : 0) * r.cantidad; 
                    });
                } else {
                    const td = window.catalogo.tours.find(x=>x.nombre===r.tour); 
                    costoTours += (td ? parseFloat(td.precio) : 0) * r.cantidad;
                }

                const costoOp = costoHosp + costoTours;
                const venta = type === 'db' ? parseFloat(r.precioPaquete)||0 : parseFloat(r.precio)||0;
                const adelanto = parseFloat(r.adelanto)||0;
                const saldo = venta - adelanto;
                const ganancia = venta - costoOp;

                totalVenta += venta;
                totalGanancia += ganancia;
                if(r.liquidado) countPagado++; else { countPendiente++; montoCobrar += saldo; }

                const badge = r.liquidado ? '<span class="badge-paid">PAGADO</span>' : '<span class="badge-debt">PENDIENTE</span>';
                
                const editFunc = type === 'db' ? `cargarEdicion(${r.id})` : `editarPase(${r.id})`;
                const toggleFunc = `window.toggleLiquidadoEnNube('${r.firestoreId}', '${type==='db'?'registros':'pases'}', ${r.liquidado})`;

                html += `<tr>
                    <td><b>${r.nombre}</b><br><small>${r.cantidad} pax</small></td>
                    <td>${hotelDisplayName}<br>${r.agencia}</td>
                    <td class="money-cell">${fmtMoneda(venta)}</td>
                    <td class="money-cell">${fmtMoneda(adelanto)}</td>
                    <td class="money-cell" style="color:${saldo>0?'var(--danger)':'var(--success)'}">${fmtMoneda(saldo)}</td>
                    <td class="money-cell">${fmtMoneda(costoOp)}</td>
                    <td class="money-cell" style="font-weight:bold; color:${ganancia>=0?'var(--money)':'red'}">${fmtMoneda(ganancia)}</td>
                    <td>${badge}</td>
                    <td>
                        <button class="btn-icon" style="background:#e0e7ff; color:var(--primary);" onclick="${toggleFunc}" title="Cambiar Estado Pago">üí≤</button>
                        <button class="btn-icon btn-edit" onclick="${editFunc}" title="Editar Completo">‚úèÔ∏è</button>
                    </td>
                </tr>`;
            };

            data.forEach(r => processRecord(r, 'db'));
            const mes = document.getElementById('filtroMes').value;
            const pasesMes = window.dbPases.filter(p => p.fecha.startsWith(mes));
            pasesMes.forEach(p => processRecord(p, 'pase'));

            document.getElementById('tbodyControl').innerHTML = html;
            document.getElementById('kpi_ventas').innerText = fmtMoneda(totalVenta);
            document.getElementById('kpi_ganancia').innerText = fmtMoneda(totalGanancia);
            document.getElementById('kpi_cobrar').innerText = fmtMoneda(montoCobrar);
        }

        document.getElementById('formGasto').addEventListener('submit', e => { 
            e.preventDefault(); 
            const g = { 
                id: window.editGastoId || Date.now(), 
                fecha: document.getElementById('g_fecha').value, 
                desc: document.getElementById('g_desc').value, 
                monto: parseFloat(document.getElementById('g_monto').value), 
                resp: document.getElementById('g_resp').value 
            }; 
            window.guardarGastoEnNube(g); 
        });

        window.cargarEdicionGasto = function(id) {
            const g = window.dbGastos.find(x => x.id == id);
            if(!g) return;
            document.getElementById('g_firestore_id').value = g.firestoreId;
            document.getElementById('g_fecha').value = g.fecha;
            document.getElementById('g_desc').value = g.desc;
            document.getElementById('g_monto').value = g.monto;
            document.getElementById('g_resp').value = g.resp;
            
            window.editGastoId = g.id;
            const btn = document.getElementById('btnGuardarGasto');
            btn.innerText = "Actualizar Gasto";
            btn.style.background = "#d97706";
            document.getElementById('btnCancelGasto').style.display = 'block';
        };

        window.limpiarGastoForm = function() {
            document.getElementById('g_firestore_id').value = '';
            document.getElementById('g_desc').value = ''; 
            document.getElementById('g_monto').value = ''; 
            document.getElementById('g_resp').value = '';
            
            window.editGastoId = null;
            const btn = document.getElementById('btnGuardarGasto');
            btn.innerText = "+ Agregar";
            btn.style.background = "var(--expense-color)";
            document.getElementById('btnCancelGasto').style.display = 'none';
        };

        function renderGastos() { 
            const mes = document.getElementById('filtroMes').value; 
            const tbody = document.getElementById('tbodyGastos'); 
            const displayTotal = document.getElementById('totalGastosDisplay'); 
            const gastosMes = window.dbGastos.filter(g => g.fecha.startsWith(mes)); 
            gastosMes.sort((a,b) => a.fecha.localeCompare(b.fecha)); 
            let total = 0; 
            let html = ''; 
            gastosMes.forEach(g => { 
                total += g.monto; 
                html += `<tr>
                    <td>${g.fecha}</td>
                    <td>${g.desc}</td>
                    <td>${g.resp}</td>
                    <td style="font-weight:bold;">${fmtMoneda(g.monto)}</td>
                    <td>
                        <button class="btn-icon btn-edit" onclick="cargarEdicionGasto('${g.id}')">‚úé</button>
                        <button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('gastos', '${g.firestoreId}')">üóë</button>
                    </td>
                </tr>`; 
            }); 
            tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center;color:gray;padding:20px;">Sin gastos registrados.</td></tr>'; 
            displayTotal.innerText = fmtMoneda(total); 
        }

        window.renderizarCatalogos = function() {
            const txt = document.getElementById('buscadorCatalogo').value.toLowerCase();
            
            let htmlHoteles = '';
            const hoteles = window.catalogo.hoteles || [];
            hoteles.forEach(h => {
                if(h.nombre.toLowerCase().includes(txt)) {
                    let sub = '';
                    if(h.habitaciones && h.habitaciones.length > 0) {
                        sub = `<div style="font-size:0.75rem; color:#666; margin-top:4px;">`;
                        h.habitaciones.forEach(r => {
                            sub += `<div>‚Ä¢ ${r.habitacion} (Cap: ${r.capacidad}) - S/ ${r.precio}</div>`;
                        });
                        sub += `</div>`;
                    }
                    
                    htmlHoteles += `<div class="cat-item">
                        <div><div style="font-weight:bold;">${h.nombre}</div>${sub}</div>
                        <div>
                            <button class="btn-icon btn-edit" onclick="editarCat('hotel', '${h.nombre}')">‚úé</button>
                            <button class="btn-icon btn-del" onclick="eliminarCat('hotel', '${h.nombre}')">üóë</button>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('cat_hoteles').innerHTML = htmlHoteles;

            let htmlTours = '';
            const tours = window.catalogo.tours || [];
            tours.forEach(t => {
                if(t.nombre.toLowerCase().includes(txt)) {
                    htmlTours += `<div class="cat-item">
                        <div><div style="font-weight:bold;">${t.nombre}</div><div style="font-size:0.75rem;">Costo: S/ ${t.precio}</div></div>
                        <div>
                            <button class="btn-icon btn-edit" onclick="editarCat('tour', '${t.id}')">‚úé</button>
                            <button class="btn-icon btn-del" onclick="eliminarCat('tour', '${t.id}')">üóë</button>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('cat_tours').innerHTML = htmlTours;

            let htmlAgencias = '';
            const agencias = window.catalogo.agencias || [];
            agencias.forEach(a => {
                if(a.nombre.toLowerCase().includes(txt)) {
                    htmlAgencias += `<div class="cat-item">
                        <div style="font-weight:bold;">${a.nombre}</div>
                        <div>
                            <button class="btn-icon btn-edit" onclick="editarCat('agencia', '${a.id}')">‚úé</button>
                            <button class="btn-icon btn-del" onclick="eliminarCat('agencia', '${a.id}')">üóë</button>
                        </div>
                    </div>`;
                }
            });
            document.getElementById('cat_agencias').innerHTML = htmlAgencias;
        };

        window.cambiarTipoCat = function(tipo) {
            document.getElementById('cat_tipo_actual').value = tipo;
            document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
            if(tipo === 'hotel') document.getElementById('typeBtnHotel').classList.add('active');
            if(tipo === 'tour') document.getElementById('typeBtnTour').classList.add('active');
            if(tipo === 'agencia') document.getElementById('typeBtnAgencia').classList.add('active');

            document.getElementById('fields_hotel').style.display = (tipo === 'hotel') ? 'block' : 'none';
            document.getElementById('fields_tour').style.display = (tipo === 'tour') ? 'block' : 'none';
            
            if(!window.isEditingCat) {
                document.getElementById('cat_edit_id').value = '';
                document.getElementById('cat_edit_old_name').value = '';
                document.getElementById('cat_nombre').value = '';
                document.getElementById('cat_precio_tour').value = '';
                document.getElementById('room_list').innerHTML = '';
            }
        };

        window.agregarFilaHabitacion = function(nombre='', cap='', precio='') {
            const div = document.createElement('div');
            div.className = 'room-row';
            div.innerHTML = `
                <input type="text" class="r-name" placeholder="Ej. 101 / Matrimonial" value="${nombre}" required>
                <input type="number" class="r-cap" placeholder="Pax" value="${cap}" required>
                <input type="number" class="r-price" placeholder="S/" value="${precio}" required>
                <button type="button" onclick="this.parentElement.remove()" style="color:red; border:none; background:none; cursor:pointer;">&times;</button>
            `;
            document.getElementById('room_list').appendChild(div);
        };

        window.abrirModalCatalogo = function() {
            window.isEditingCat = false;
            document.getElementById('modalCatalogo').classList.add('active');
            cambiarTipoCat('hotel'); 
        }

        document.getElementById('formCatalogo').addEventListener('submit', (e) => {
            e.preventDefault();
            const tipo = document.getElementById('cat_tipo_actual').value;
            const nombre = document.getElementById('cat_nombre').value.trim();
            const editId = document.getElementById('cat_edit_id').value; 
            const oldName = document.getElementById('cat_edit_old_name').value; 

            if(!nombre) return alert("Ingrese un nombre");

            if(tipo === 'hotel') {
                const habitaciones = [];
                document.querySelectorAll('#room_list .room-row').forEach(row => {
                    habitaciones.push({
                        habitacion: row.querySelector('.r-name').value,
                        capacidad: row.querySelector('.r-cap').value,
                        precio: row.querySelector('.r-price').value
                    });
                });

                const newHotel = { nombre, habitaciones };

                if(oldName) {
                    const idx = window.catalogo.hoteles.findIndex(h => h.nombre === oldName);
                    if(idx >= 0) window.catalogo.hoteles[idx] = newHotel;
                } else {
                    window.catalogo.hoteles.push(newHotel);
                }

            } else if (tipo === 'tour') {
                const precio = document.getElementById('cat_precio_tour').value;
                const newTour = { id: editId || Date.now().toString(), nombre, precio };
                
                if(editId) {
                    const idx = window.catalogo.tours.findIndex(t => t.id == editId);
                    if(idx >= 0) window.catalogo.tours[idx] = newTour;
                } else {
                    window.catalogo.tours.push(newTour);
                }

            } else if (tipo === 'agencia') {
                const newAgencia = { id: editId || Date.now().toString(), nombre };
                
                if(editId) {
                    const idx = window.catalogo.agencias.findIndex(a => a.id == editId);
                    if(idx >= 0) window.catalogo.agencias[idx] = newAgencia;
                } else {
                    window.catalogo.agencias.push(newAgencia);
                }
            }

            window.guardarCatalogoEnNube();
            window.cerrarModal('modalCatalogo');
            window.renderizarCatalogos();
        });

        function cargarSelectLiquidacion() { const s = document.getElementById('liq_agencia'); s.innerHTML = '<option value="">Seleccione Agencia...</option>' + catalogo.agencias.map(a => `<option value="${a.nombre}">${a.nombre}</option>`).join(''); }
        function generarLiquidacion() { const ag = document.getElementById('liq_agencia').value; const desde = document.getElementById('liq_desde').value; const hasta = document.getElementById('liq_hasta').value; window.liquidacionData = []; const estado = document.getElementById('liq_filtro_estado').value; const applyFilter = (r) => { const isLiq = !!r.liquidado; if(estado === 'pendientes' && isLiq) return false; if(estado === 'liquidados' && !isLiq) return false; return true; }; window.db.forEach(r => { if(r.agencia === ag && r.llegada >= desde && r.llegada <= hasta && applyFilter(r)) { window.liquidacionData.push({ id: r.id, tipo: 'db', fecha: r.llegada, nombre: r.nombre, pax: r.cantidad, desc: `Paquete`, v: parseFloat(r.precioPaquete)||0, a: parseFloat(r.adelanto)||0, s: (parseFloat(r.precioPaquete)||0)-(parseFloat(r.adelanto)||0), liq: r.liquidado }); } }); window.dbPases.forEach(p => { if(p.agencia === ag && p.fecha >= desde && p.fecha <= hasta && applyFilter(p)) { window.liquidacionData.push({ id: p.id, tipo: 'pase', fecha: p.fecha, nombre: p.nombre, pax: p.cantidad, desc: `Pase: ${p.tour}`, v: parseFloat(p.precio)||0, a: parseFloat(p.adelanto)||0, s: (parseFloat(p.precio)||0)-(parseFloat(p.adelanto)||0), liq: p.liquidado }); } }); let html = '<table class="excel-table"><thead><tr><th>Estado</th><th>Fecha</th><th>Cliente</th><th>Servicio</th><th>Venta</th><th>Adelanto</th><th>Saldo</th></tr></thead><tbody>'; let tV=0, tA=0, tS=0; window.liquidacionData.sort((a,b)=>a.fecha.localeCompare(b.fecha)).forEach(d=>{ tV+=d.v; tA+=d.a; tS+=d.s; const badge = d.liq ? '<span class="badge-liq">PAGADO</span>' : '<span style="color:red;font-weight:bold;">PENDIENTE</span>'; html+=`<tr><td>${badge}</td><td>${d.fecha}</td><td>${d.nombre}</td><td>${d.desc}</td><td>${fmtMoneda(d.v)}</td><td>${fmtMoneda(d.a)}</td><td style="color:${d.s>0?'red':'green'}">${fmtMoneda(d.s)}</td></tr>`; }); html+='</tbody></table>'; document.getElementById('tablaLiqContainer').innerHTML=html; document.getElementById('liq_total_venta').innerText=fmtMoneda(tV); document.getElementById('liq_total_adelanto').innerText=fmtMoneda(tA); document.getElementById('liq_total_deuda').innerText=fmtMoneda(tS); document.getElementById('resultadosLiquidacion').style.display = 'block'; }
        function liquidarRegistros() { window.liquidarEnNube(window.liquidacionData); }
        function imprimirLiquidacion() { const ag = document.getElementById('liq_agencia').value; const d1 = document.getElementById('liq_desde').value; const d2 = document.getElementById('liq_hasta').value; const tv = document.getElementById('liq_total_venta').innerText; const ta = document.getElementById('liq_total_adelanto').innerText; const td = document.getElementById('liq_total_deuda').innerText; let h = `<div class="print-header"><h1>LIQUIDACI√ìN DE AGENCIA</h1><h2>${ag}</h2><p>Periodo: ${d1} al ${d2}</p></div><table class="print-table"><thead><tr><th>FECHA</th><th>PASAJERO</th><th>SERVICIO</th><th>IMPORTE</th><th>A CUENTA</th><th>SALDO</th></tr></thead><tbody>`; window.liquidacionData.forEach(r => { h += `<tr><td>${r.fecha}</td><td>${r.nombre} (${r.pax})</td><td>${r.desc}</td><td>${fmtMoneda(r.v)}</td><td>${fmtMoneda(r.a)}</td><td>${fmtMoneda(r.s)}</td></tr>`; }); h += `</tbody></table><div style="margin-top:20px; display:flex; justify-content:flex-end;"><table style="width:300px; border:1px solid #000; border-collapse:collapse;"><tr><td style="padding:5px; border:1px solid #000;">Total Venta:</td><td style="padding:5px; border:1px solid #000; text-align:right;">${tv}</td></tr><tr><td style="padding:5px; border:1px solid #000;">Total Pagado:</td><td style="padding:5px; border:1px solid #000; text-align:right;">${ta}</td></tr><tr><td style="padding:5px; border:1px solid #000; font-weight:bold;">A PAGAR:</td><td style="padding:5px; border:1px solid #000; text-align:right; font-weight:bold;">${td}</td></tr></table></div><div style="margin-top:40px; text-align:center;">__________________________<br>Firma Conforme</div>`; document.getElementById('printableArea').innerHTML = h; window.print(); document.getElementById('printableArea').innerHTML = ''; }
        function cargarSelectOps() { const s = document.getElementById('ops_tour'); s.innerHTML = '<option value="">Seleccione Tour</option>' + catalogo.tours.map(t => `<option value="${t.nombre}">${t.nombre}</option>`).join(''); }
        function nuevaOperacion() { document.getElementById('ops_id_actual').value = ''; document.getElementById('ops_firestore_id').value = ''; document.getElementById('ops_fecha').value = new Date().toISOString().split('T')[0]; document.getElementById('ops_tour').value = ''; document.getElementById('ops_conductor').value = ''; document.getElementById('ops_guia').value = ''; document.getElementById('ops_capacidad').value = 15; window.opsTempAsignados = []; cargarPendientesOps(); }
        
        function cargarPendientesOps() { 
            const f = document.getElementById('ops_fecha').value; 
            const t = document.getElementById('ops_tour').value; 
            const idActual = document.getElementById('ops_id_actual').value; 

            const divPend = document.getElementById('lista_ops_pendientes'); 
            const divAsig = document.getElementById('lista_ops_asignados'); 
            divPend.innerHTML = ''; 
            divAsig.innerHTML = ''; 
            
            if (!f || !t) return; 

            const bloqueados = new Set();
            window.dbOps.forEach(op => {
                if (String(op.id) === String(idActual)) return;
                if (op.fecha === f && op.tour === t) {
                    op.pasajeros.forEach(p => {
                        bloqueados.add(`${p.tipo}_${p.refId}`);
                    });
                }
            });

            let htmlPend = ''; 
            let countPend = 0; 
            
            const candidatosDB = window.db.filter(r => Array.isArray(r.tours) && r.tours.some(tour => tour.fecha === f && tour.nombre === t)); 
            const candidatosPases = window.dbPases.filter(p => p.fecha === f && p.tour === t); 

            const renderItem = (id, nombre, pax, hotel, tipo, fullObs, celular) => { 
                const yaAsignadoAqui = window.opsTempAsignados.find(x => x.refId == id && x.tipo == tipo); 
                if (yaAsignadoAqui) return; 

                if (bloqueados.has(`${tipo}_${id}`)) return;

                countPend += parseInt(pax); 
                
                const obsTag = fullObs ? `<span style="color:orange;font-size:0.7rem; display:block;">üìù ${fullObs.substring(0,30)}...</span>` : ''; 
                
                const safeNombre = nombre.replace(/'/g, "").replace(/"/g, "");
                const safeHotel = hotel.replace(/'/g, "").replace(/"/g, "");
                const safeObs = fullObs.replace(/'/g, "").replace(/"/g, "");

                return `<div class="ops-item"><div><b>${nombre}</b> <small>(${tipo==='db'?'Hu√©sped':'Pase'})</small><br>Pax: <b>${pax}</b> | ${hotel} ${obsTag}</div><button class="btn-add-ops" onclick="asignarPax(${id}, '${tipo}', ${pax}, '${safeNombre}', '${safeHotel}', '${celular || ""}', '${safeObs}')">></button></div>`; 
            }; 

            candidatosDB.forEach(c => { 
                const tr = c.tours.find(x => x.fecha === f && x.nombre === t); 
                const notaDia = c.tours.find(x => x.fecha === f && !x.nombre);

                let obsParts = [];
                if(c.observaciones) obsParts.push(`[Gen: ${c.observaciones}]`);
                if(tr && (tr.obsTour || tr.obs)) obsParts.push(`[Tour: ${tr.obsTour || tr.obs}]`);
                if(notaDia && notaDia.obsDia) obsParts.push(`[Nota: ${notaDia.obsDia}]`);
                
                const fullObs = obsParts.join(' ');

                const h = renderItem(c.id, c.nombre, c.cantidad, c.hotelName, 'db', fullObs, c.celular); 
                if(h) htmlPend+=h; 
            }); 
            candidatosPases.forEach(c => { 
                const h = renderItem(c.id, c.nombre, c.cantidad, c.hotel, 'pase', c.observacion || '', c.celular); 
                if(h) htmlPend+=h; 
            }); 

            divPend.innerHTML = htmlPend || '<div style="padding:10px; color:gray;">No hay clientes pendientes.</div>'; 
            document.getElementById('count_pendientes').innerText = countPend; 
            renderizarAsignados(); 
        }

        window.imprimirManifiesto = function() {
            const fecha = document.getElementById('ops_fecha').value;
            const tour = document.getElementById('ops_tour').value;
            const conductor = document.getElementById('ops_conductor').value || "---";
            const guia = document.getElementById('ops_guia').value || "---";
            const capacidad = document.getElementById('ops_capacidad').value;
            const paxList = window.opsTempAsignados;

            if (paxList.length === 0) return alert("No hay pasajeros asignados para imprimir.");

            let totalPax = paxList.reduce((sum, p) => sum + parseInt(p.pax), 0);

            let h = `
                <div class="print-header">
                    <h1>MANIFIESTO DE PASAJEROS</h1>
                    <h2>${tour}</h2>
                    <table style="width:100%; margin-top:10px; border:none;">
                        <tr>
                            <td style="border:none;"><strong>Fecha:</strong> ${fecha}</td>
                            <td style="border:none;"><strong>Veh√≠culo Cap:</strong> ${capacidad}</td>
                        </tr>
                        <tr>
                            <td style="border:none;"><strong>Conductor:</strong> ${conductor}</td>
                            <td style="border:none;"><strong>Gu√≠a:</strong> ${guia}</td>
                        </tr>
                    </table>
                </div>
                <table class="print-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">#</th>
                            <th>PASAJERO</th>
                            <th>CELULAR</th>
                            <th style="width:50px;">PAX</th>
                            <th>HOTEL / RECOJO</th>
                            <th>OBSERVACIONES</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            paxList.forEach((p, index) => {
                h += `
                    <tr>
                        <td style="text-align:center;">${index + 1}</td>
                        <td>${p.nombre}</td>
                        <td>${p.celular || '---'}</td>
                        <td style="text-align:center;">${p.pax}</td>
                        <td>${p.hotel}</td>
                        <td style="font-size:0.8rem;">${p.obs || ''}</td> 
                    </tr>
                `;
            });

            h += `
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" style="text-align:right; font-weight:bold; padding:10px;">TOTAL PASAJEROS:</td>
                            <td style="text-align:center; font-weight:bold; padding:10px;">${totalPax}</td>
                            <td colspan="2"></td>
                        </tr>
                    </tfoot>
                </table>
                <div style="margin-top:50px; display:flex; justify-content:space-around;">
                    <div style="text-align:center; border-top:1px solid #000; width:200px; padding-top:10px;">Firma Conductor</div>
                    <div style="text-align:center; border-top:1px solid #000; width:200px; padding-top:10px;">Firma Gu√≠a</div>
                </div>
            `;

            document.getElementById('printableArea').innerHTML = h;
            window.print();
            document.getElementById('printableArea').innerHTML = '';
        };

        function renderizarAsignados() { const divAsig = document.getElementById('lista_ops_asignados'); let html = ''; let total = 0; window.opsTempAsignados.forEach((p, index) => { total+=parseInt(p.pax); html += `<div class="ops-item"><button class="btn-remove-ops" onclick="removerPax(${index})"><</button><div><b>${p.nombre}</b><br>Pax: ${p.pax}</div></div>`; }); divAsig.innerHTML = html || '<div style="padding:10px; color:gray;">Vac√≠o.</div>'; document.getElementById('count_asignados').innerText = total; actualizarIndicadorCapacidad(total); }
        
        function asignarPax(id, tipo, pax, nombre, hotel, celular, obs) { 
            const capMax = parseInt(document.getElementById('ops_capacidad').value); 
            const actual = window.opsTempAsignados.reduce((sum, p) => sum + parseInt(p.pax), 0); 
            if (actual + parseInt(pax) > capMax) return alert("Excede capacidad"); 
            window.opsTempAsignados.push({ refId: id, tipo, pax, nombre, hotel, celular, obs }); 
            cargarPendientesOps(); 
        }
        
        function removerPax(i) { window.opsTempAsignados.splice(i, 1); cargarPendientesOps(); }
        function actualizarIndicadorCapacidad(c=null) { if(c===null) c=window.opsTempAsignados.reduce((s,p)=>s+parseInt(p.pax),0); const m=document.getElementById('ops_capacidad').value; document.getElementById('indicadorCapacidad').innerText=`${c} / ${m}`; }
        function guardarOperacion() { const data = { id: document.getElementById('ops_id_actual').value || Date.now(), fecha: document.getElementById('ops_fecha').value, tour: document.getElementById('ops_tour').value, conductor: document.getElementById('ops_conductor').value, guia: document.getElementById('ops_guia').value, capacidad: document.getElementById('ops_capacidad').value, pasajeros: window.opsTempAsignados }; window.guardarOperacionEnNube(data); }
        function renderListaOps() { const tbody = document.getElementById('tbodyOps'); tbody.innerHTML = window.dbOps.sort((a,b)=>b.fecha.localeCompare(a.fecha)).map(op => { const total = op.pasajeros.reduce((s,p)=>s+parseInt(p.pax),0); return `<tr><td>${op.fecha}</td><td>${op.tour}</td><td>${op.conductor}</td><td>${total}/${op.capacidad}</td><td>OK</td><td><button class="btn-icon btn-edit" onclick="cargarOp(${op.id})">‚úé</button><button class="btn-icon btn-del" onclick="window.eliminarDocEnNube('operaciones', '${op.firestoreId}')">üóë</button></td></tr>`; }).join(''); }
        function cargarOp(id) { const op = window.dbOps.find(x => x.id === id); if(!op) return; document.getElementById('ops_id_actual').value = op.id; document.getElementById('ops_firestore_id').value = op.firestoreId; document.getElementById('ops_fecha').value = op.fecha; document.getElementById('ops_tour').value = op.tour; document.getElementById('ops_conductor').value = op.conductor; document.getElementById('ops_guia').value = op.guia; document.getElementById('ops_capacidad').value = op.capacidad; window.opsTempAsignados = [...op.pasajeros]; cargarPendientesOps(); }
        
        function cargarSelects() { 
            const s = document.getElementById('selHotelAdd'); 
            s.innerHTML='<option value="">Seleccione Hotel...</option>'; 
            if(window.catalogo.hoteles) window.catalogo.hoteles.forEach(h=>s.innerHTML+=`<option value="${h.nombre}">${h.nombre}</option>`); 
            
            const sa = document.getElementById('selAgencia'); 
            sa.innerHTML='<option value="">Seleccione...</option>'; 
            if(window.catalogo.agencias) window.catalogo.agencias.forEach(a=>sa.innerHTML+=`<option>${a.nombre}</option>`); 
        }

        window.actualizarSelectRoom = function() {
            const hName = document.getElementById('selHotelAdd').value;
            const rSelect = document.getElementById('selRoomAdd');
            rSelect.innerHTML = '';
            
            if(!hName) return;

            const hotel = window.catalogo.hoteles.find(h => h.nombre === hName);
            if(hotel && hotel.habitaciones) {
                hotel.habitaciones.forEach(r => {
                    const option = document.createElement('option');
                    option.value = r.habitacion;
                    option.text = `${r.habitacion} (Cap: ${r.capacidad}) - S/ ${r.precio}`;
                    option.setAttribute('data-price', r.precio);
                    option.setAttribute('data-cap', r.capacidad);
                    rSelect.appendChild(option);
                });
            } else {
                rSelect.innerHTML = '<option value="">Sin habitaciones</option>';
            }
        };

        window.agregarHabitacion = function() {
            const hName = document.getElementById('selHotelAdd').value;
            const rSelect = document.getElementById('selRoomAdd');
            const rName = rSelect.value;
            const noches = document.getElementById('txtNochesAdd').value;
            
            if(!hName || !rName) return alert("Seleccione Hotel y Habitaci√≥n");
            if(parseInt(noches) < 1) return alert("Ingrese al menos 1 noche");

            const selectedOption = rSelect.options[rSelect.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const cap = selectedOption.getAttribute('data-cap');

            window.tempHabitaciones.push({
                hotel: hName,
                habitacion: rName,
                precio: price,
                capacidad: cap,
                noches: noches // Guardamos noches
            });
            
            renderTempHabitaciones();
        };

        window.removerHabitacion = function(index) {
            window.tempHabitaciones.splice(index, 1);
            renderTempHabitaciones();
        };

        function renderTempHabitaciones() {
            const container = document.getElementById('listaHabitacionesAgregadas');
            container.innerHTML = '';
            
            if(window.tempHabitaciones.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#9ca3af; font-size:0.8rem; padding:10px;">Ninguna habitaci√≥n agregada</div>';
                return;
            }

            window.tempHabitaciones.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'added-room-item';
                div.innerHTML = `
                    <div class="added-room-info">
                        <span class="added-room-hotel">${item.hotel}</span>
                        <span>Hab: <b>${item.habitacion}</b> | üåô ${item.noches} Noches | Cap: ${item.capacidad} | S/ ${item.precio}</span>
                    </div>
                    <button type="button" onclick="removerHabitacion(${index})" style="color:red; background:none; border:none; cursor:pointer; font-weight:bold;">‚úï</button>
                `;
                container.appendChild(div);
            });
        }
        
        function cargarSelectsPase() {
            const sa = document.getElementById('p_agencia'); sa.innerHTML = '<option value="">Seleccione Agencia...</option>'; if(window.catalogo.agencias) window.catalogo.agencias.forEach(a => sa.innerHTML += `<option value="${a.nombre}">${a.nombre}</option>`);
            const st = document.getElementById('p_tour'); st.innerHTML = '<option value="">Seleccione Tour...</option>'; if(window.catalogo.tours) window.catalogo.tours.forEach(t => st.innerHTML += `<option value="${t.nombre}">${t.nombre}</option>`);
            const sh = document.getElementById('p_hotel'); sh.innerHTML = '<option value="">Seleccione Hotel/Lugar...</option>'; if(window.catalogo.hoteles) window.catalogo.hoteles.forEach(h => sh.innerHTML += `<option value="${h.nombre}">${h.nombre}</option>`);
        }
        
        function agregarLineaItinerario(tipo, valor='', diaVal=0, obs='') { 
            const d=document.createElement('div'); 
            d.className='tour-row-input'; 
            d.setAttribute('data-tipo', tipo);

            let dayOpts = obtenerOpcionesFechas(diaVal);

            let html = '';
            
            if(tipo === 'tour') {
                let opts = '<option value="">-- Seleccione Tour --</option>'; 
                if(window.catalogo.tours) window.catalogo.tours.forEach(t=>{
                    opts+=`<option value="${t.nombre}" ${t.nombre===valor?'selected':''}>${t.nombre}</option>`;
                });
                
                html = `
                    <select class="sel-tour" style="flex:1.5;">${opts}</select>
                    <select class="sel-dia" style="flex:1;">${dayOpts}</select>
                    <input type="text" class="sel-obs" placeholder="Obs Tour (Veggie, etc.)" value="${obs}" style="flex:1.5;">
                `;
            } else {
                html = `
                    <input type="text" class="sel-nota-texto" placeholder="‚ö†Ô∏è Escriba la Nota (Ej. D√≠a Libre, Vuelo Salida)" value="${valor}" style="flex:2.5; font-weight:bold; color:#d97706; background:#fffbeb;">
                    <select class="sel-dia" style="flex:1;">${dayOpts}</select>
                `;
            }

            html += `<button type="button" onclick="this.parentElement.remove()" style="color:red;border:none;cursor:pointer;font-weight:bold;margin-left:5px;">üóë</button>`;
            
            d.innerHTML = html;
            document.getElementById('listaToursInputs').appendChild(d); 
        }

        function abrirModalRegistro() { 
            window.editId = null; 
            document.getElementById('reg_firestore_id').value = ''; 
            document.getElementById('modalRegTitulo').innerText="üìù Nuevo Registro"; 
            document.getElementById('formTour').reset(); 
            document.getElementById('listaToursInputs').innerHTML=''; 
            document.getElementById('txtNochesAdd').value = 1; // Reset noches
            
            window.tempHabitaciones = []; 
            renderTempHabitaciones();

            cargarSelects(); 
            agregarLineaItinerario('tour'); 
            document.getElementById('modalRegistro').classList.add('active'); 
        }
        
        function cargarEdicion(id) { 
            const r = window.db.find(x => x.id === id); if(!r) return; 
            abrirModalRegistro(); 
            document.getElementById('listaToursInputs').innerHTML = ''; 

            window.editId = id; 
            document.getElementById('reg_firestore_id').value = r.firestoreId; 
            document.getElementById('nombre').value = r.nombre; 
            document.getElementById('celular').value = r.celular; 
            document.getElementById('selAgencia').value = r.agencia; 
            document.getElementById('cantidad').value = r.cantidad; 
            document.getElementById('precioPaquete').value = r.precioPaquete; 
            document.getElementById('adelanto').value = r.adelanto; 
            document.getElementById('llegada').value = r.llegada; 
            document.getElementById('retorno').value = r.retorno; 
            document.getElementById('observaciones').value = r.observaciones || ''; 
            
            // CARGA DE HABITACIONES
            window.tempHabitaciones = [];
            if(Array.isArray(r.habitaciones)) {
                r.habitaciones.forEach(h => {
                    if(typeof h === 'object') {
                        // Nuevo formato
                        window.tempHabitaciones.push(h);
                    } else {
                        // Viejo formato
                        window.tempHabitaciones.push({
                            hotel: r.hotelName,
                            habitacion: h,
                            precio: 0,
                            capacidad: 0,
                            noches: 1
                        });
                    }
                });
            } else {
                 if(r.habitaciones) {
                     window.tempHabitaciones.push({
                         hotel: r.hotelName,
                         habitacion: r.habitaciones,
                         precio: 0,
                         capacidad: 0,
                         noches: 1
                     });
                 }
            }
            renderTempHabitaciones();

            if(r.tours && r.tours.length > 0) { 
                r.tours.forEach(t => { 
                    const diff = Math.ceil((new Date(t.fecha) - new Date(r.llegada)) / 86400000); 
                    if(t.nombre) {
                        agregarLineaItinerario('tour', t.nombre, diff, (t.obsTour || t.obs)); 
                    } else {
                        agregarLineaItinerario('nota', t.obsDia, diff);
                    }
                }); 
            } else { 
                agregarLineaItinerario('tour'); 
            } 
        }

        function abrirModalPases() { window.editId = null; document.getElementById('pase_firestore_id').value = ''; document.getElementById('formPase').reset(); setPasePagoMode('adelanto'); cargarSelectsPase(); document.getElementById('modalPases').classList.add('active'); }
        function setPasePagoMode(mode) { document.getElementById('p_modo_pago').value = mode; if (mode === 'pagado') { document.getElementById('opt_pagado').classList.add('active-green'); document.getElementById('opt_adelanto').classList.remove('active'); syncPasePago(); } else { document.getElementById('opt_adelanto').classList.add('active'); document.getElementById('opt_pagado').classList.remove('active-green'); document.getElementById('p_adelanto').readOnly = false; } }
        function syncPasePago() { if (document.getElementById('p_modo_pago').value === 'pagado') { document.getElementById('p_adelanto').value = document.getElementById('p_precio').value; document.getElementById('p_adelanto').readOnly = true; } }
        function calcPaseAuto() { const tName = document.getElementById('p_tour').value; const qty = parseFloat(document.getElementById('p_cantidad').value) || 0; const tourData = window.catalogo.tours.find(t => t.nombre === tName); if(tourData && qty > 0) { const total = parseFloat(tourData.precio) * qty; document.getElementById('p_precio').value = total.toFixed(2); syncPasePago(); } }
        document.getElementById('formPase').addEventListener('submit', e => { e.preventDefault(); const precio = parseFloat(document.getElementById('p_precio').value) || 0; const adelanto = parseFloat(document.getElementById('p_adelanto').value) || 0; const modo = document.getElementById('p_modo_pago').value; const data = { id: window.editId || Date.now(), nombre: document.getElementById('p_nombre').value, celular: document.getElementById('p_celular').value, agencia: document.getElementById('p_agencia').value, cantidad: document.getElementById('p_cantidad').value, hotel: document.getElementById('p_hotel').value, fecha: document.getElementById('p_fecha').value, tour: document.getElementById('p_tour').value, observacion: document.getElementById('p_obs').value, precio: precio, adelanto: adelanto, liquidado: (modo === 'pagado' || (precio > 0 && adelanto >= precio)) }; window.guardarPaseEnNube(data); });
        function editarPase(id) { const p = window.dbPases.find(x => x.id === id); if(!p) return; abrirModalPases(); window.editId = id; document.getElementById('pase_firestore_id').value = p.firestoreId; document.getElementById('p_nombre').value = p.nombre; document.getElementById('p_celular').value = p.celular; document.getElementById('p_agencia').value = p.agencia; document.getElementById('p_cantidad').value = p.cantidad; document.getElementById('p_hotel').value = p.hotel; document.getElementById('p_fecha').value = p.fecha; document.getElementById('p_tour').value = p.tour; document.getElementById('p_obs').value = p.observacion || ''; document.getElementById('p_precio').value = p.precio; document.getElementById('p_adelanto').value = p.adelanto; if (p.liquidado || (p.precio > 0 && p.adelanto >= p.precio)) setPasePagoMode('pagado'); else setPasePagoMode('adelanto'); }
        
        function editarCat(tipo, idOrName) { 
            window.isEditingCat = true;
            document.getElementById('modalCatalogo').classList.add('active'); 
            cambiarTipoCat(tipo);
            if(tipo === 'hotel') { 
                document.getElementById('cat_nombre').value = idOrName; 
                document.getElementById('cat_edit_old_name').value = idOrName; 
                document.getElementById('room_list').innerHTML = ''; 
                const hotel = window.catalogo.hoteles.find(h => h.nombre === idOrName);
                if(hotel && hotel.habitaciones) {
                    hotel.habitaciones.forEach(r => agregarFilaHabitacion(r.habitacion, r.capacidad, r.precio)); 
                }
            } else if (tipo === 'tour') { 
                const t = window.catalogo.tours.find(x => x.id == idOrName); 
                document.getElementById('cat_nombre').value = t.nombre; 
                document.getElementById('cat_precio_tour').value = t.precio; 
                document.getElementById('cat_edit_id').value = t.id; 
            } else { 
                const a = window.catalogo.agencias.find(x => x.id == idOrName); 
                document.getElementById('cat_nombre').value = a.nombre; 
                document.getElementById('cat_edit_id').value = a.id; 
            } 
        }

        function eliminarCat(t,i){
            if(!confirm("Borrar?"))return;
            if(t==='hotel') window.catalogo.hoteles=window.catalogo.hoteles.filter(x=>x.nombre!==i);
            else if(t==='tour') window.catalogo.tours=window.catalogo.tours.filter(x=>x.id!=i);
            else window.catalogo.agencias=window.catalogo.agencias.filter(x=>x.id!=i);
            window.guardarCatalogoEnNube();
        }

        document.getElementById('formTour').addEventListener('submit', async (e) => {
            e.preventDefault();
            const llegada = document.getElementById('llegada').value;
            
            const habitaciones = window.tempHabitaciones;
            
            let mainHotelName = '';
            if(habitaciones.length > 0) mainHotelName = habitaciones[0].hotel;

            const tours = [];
            
            document.querySelectorAll('#listaToursInputs .tour-row-input').forEach(row => {
                const tipo = row.getAttribute('data-tipo');
                const tDiaIdx = parseInt(row.querySelector('.sel-dia').value);
                const fechaTour = calcularFechaTour(llegada, tDiaIdx);

                if(tipo === 'tour') {
                    const tName = row.querySelector('.sel-tour').value;
                    const tObs = row.querySelector('.sel-obs').value;
                    if(tName) {
                        tours.push({ 
                            nombre: tName, 
                            fecha: fechaTour, 
                            obsTour: tObs, 
                            obsDia: '' 
                        });
                    }
                } else {
                    const notaTexto = row.querySelector('.sel-nota-texto').value;
                    if(notaTexto) {
                        tours.push({ 
                            nombre: '', 
                            fecha: fechaTour, 
                            obsTour: '', 
                            obsDia: notaTexto 
                        });
                    }
                }
            });

            const data = {
                id: window.editId || Date.now(),
                nombre: document.getElementById('nombre').value,
                celular: document.getElementById('celular').value,
                agencia: document.getElementById('selAgencia').value,
                cantidad: document.getElementById('cantidad').value,
                hotelName: mainHotelName, 
                llegada: llegada,
                retorno: document.getElementById('retorno').value,
                habitaciones: habitaciones, 
                precioPaquete: parseFloat(document.getElementById('precioPaquete').value) || 0,
                adelanto: parseFloat(document.getElementById('adelanto').value) || 0,
                observaciones: document.getElementById('observaciones').value,
                tours: tours,
                liquidado: false 
            };
            if(window.editId) {
                const old = window.db.find(x => x.id === window.editId);
                if(old) data.liquidado = old.liquidado;
            }
            await window.guardarRegistroEnNube(data);
        });
    </script>
</body>
</html>
